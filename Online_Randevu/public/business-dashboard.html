<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>İşletme Paneli - Online Randevu</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .dashboard-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .dashboard-nav {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-decoration: none;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .menu-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, #764ba2, #667eea);
        }
        
        .nav-right {
            display: flex;
            align-items: center;
        }
        
        .logout-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(238, 90, 82, 0.3);
        }
        
        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(238, 90, 82, 0.4);
            background: linear-gradient(135deg, #ee5a52, #ff6b6b);
        }
        
        .dashboard-main {
            flex: 1;
            padding: 40px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }
        
        .welcome-message {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 40px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .welcome-message::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb, #f5576c);
            background-size: 300% 100%;
            animation: gradientShift 3s ease infinite;
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .welcome-message h2 {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 15px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .welcome-message p {
            font-size: 1.2rem;
            color: #7f8c8d;
            line-height: 1.6;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .resources-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
            margin-bottom: 30px;
        }
        
        .resources-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            background-size: 300% 100%;
            animation: gradientShift 3s ease infinite;
        }
        
        .resources-section h3 {
            font-size: 2rem;
            color: #2c3e50;
            margin-bottom: 10px;
            font-weight: 700;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .section-description {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1.1rem;
            line-height: 1.6;
        }
        
        .resources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        
        .resource-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            overflow: hidden;
        }
        
        .resource-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.6s;
        }
        
        .resource-card:hover::before {
            left: 100%;
        }
        
        .resource-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }
        
        .resource-card.selected {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-5px);
            box-shadow: 0 15px 50px rgba(102, 126, 234, 0.4);
        }
        
        .resource-card.selected .resource-title,
        .resource-card.selected .resource-type-tag {
            color: white;
        }
        
        .resource-card.selected .resource-icon {
            color: rgba(255, 255, 255, 0.9);
        }
        
        .appointment-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            border-radius: 25px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 15px rgba(238, 90, 82, 0.4);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .appointment-badge.urgent {
            background: linear-gradient(135deg, #ff4757, #c44569);
            animation: urgent-pulse 1s infinite;
        }
        
        @keyframes urgent-pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 4px 15px rgba(196, 69, 105, 0.4); }
            50% { transform: scale(1.1); box-shadow: 0 6px 20px rgba(196, 69, 105, 0.6); }
        }
        
        .resource-type-tag {
            position: absolute;
            top: 15px;
            left: 15px;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 3px 10px rgba(79, 172, 254, 0.3);
        }
        
        .resource-icon {
            font-size: 48px;
            color: #667eea;
            margin: 20px 0 15px;
            align-self: center;
            transition: all 0.3s ease;
            filter: drop-shadow(0 4px 8px rgba(102, 126, 234, 0.3));
        }
        
        .resource-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: #2c3e50;
            text-align: center;
            transition: color 0.3s ease;
        }
        
        .resource-status {
            margin-top: 15px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .status-active {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
        }
        
        .status-inactive {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        
        .toggle-status-btn {
            margin-top: 15px;
            padding: 10px 20px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            align-self: center;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .toggle-status-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }
        
        .appointment-list {
            margin-top: 40px;
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .appointment-list::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff6b6b, #ee5a52, #ff9ff3, #f368e0);
            background-size: 300% 100%;
            animation: gradientShift 3s ease infinite;
        }
        
        .appointment-list.active {
            display: block;
            animation: fadeInUp 0.6s ease;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .appointment-list h3 {
            font-size: 1.8rem;
            color: #2c3e50;
            margin-bottom: 30px;
            font-weight: 700;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .no-appointments-message {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-size: 1.2rem;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(248, 249, 250, 0.8));
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .appointment-item {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            transition: all 0.3s ease;
            border-left: 4px solid #3498db;
            position: relative;
            overflow: hidden;
        }
        
        .appointment-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #3498db, #2ecc71, #f39c12);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .appointment-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }
        
        .appointment-item:hover::before {
            opacity: 1;
        }
        
        .appointment-details {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .customer-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .customer-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 0 3px 12px rgba(102, 126, 234, 0.3);
        }
        
        .customer-details {
            flex-grow: 1;
        }
        
        .customer-name {
            font-weight: 600;
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 4px;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        
        .customer-name:hover {
            color: #3498db;
        }
        
        .customer-phone {
            font-size: 13px;
            color: #7f8c8d;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .service-info {
            background: linear-gradient(135deg, #e8f5e9, #d4edda);
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 8px;
            border-left: 3px solid #28a745;
        }
        
        .service-name {
            font-weight: 600;
            color: #155724;
            font-size: 14px;
        }
        
        .service-price {
            background: #28a745;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: auto;
        }
        
        .appointment-time {
            color: #666;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 500;
        }
        
        .appointment-time .material-icons {
            font-size: 18px;
            color: #3498db;
        }
        
        .appointment-status {
            font-size: 13px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            text-align: center;
            min-width: 100px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-waiting {
            background: linear-gradient(135deg, #fff8e1, #ffecb3);
            color: #e65100;
            border: 1px solid #ffcc02;
        }
        
        .status-approved {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            color: #2e7d32;
            border: 1px solid #4caf50;
        }
        
        .status-completed {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: #1565c0;
            border: 1px solid #2196f3;
        }
        
        .status-noshow {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            color: #c62828;
            border: 1px solid #f44336;
        }
        
        .status-cancelled {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            color: #c62828;
            border: 1px solid #f44336;
        }
        
        .status-rejected {
            background: linear-gradient(135deg, #fce4ec, #f8bbd9);
            color: #ad1457;
            border: 1px solid #e91e63;
        }
        
        .appointment-actions {
            display: flex;
            gap: 12px;
            flex-direction: column;
            align-items: flex-end;
        }
        
        .action-btn {
            padding: 10px 18px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.15);
            min-width: 100px;
            justify-content: center;
        }
        
        .approve-btn {
            background: linear-gradient(135deg, #4caf50, #388e3c);
            color: white;
        }
        
        .approve-btn:hover {
            background: linear-gradient(135deg, #388e3c, #2e7d32);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }
        
        .reject-btn {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }
        
        .reject-btn:hover {
            background: linear-gradient(135deg, #d32f2f, #c62828);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
        }
        
        .loading-placeholder {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            font-size: 1.1rem;
            font-weight: 500;
        }
        
        .empty-resources {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 249, 250, 0.9));
            backdrop-filter: blur(20px);
            padding: 50px;
            border-radius: 20px;
            text-align: center;
            color: #7f8c8d;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .empty-resources .material-icons {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.6;
            color: #667eea;
            filter: drop-shadow(0 4px 8px rgba(102, 126, 234, 0.2));
        }
        
        .empty-resources p {
            font-size: 1.2rem;
            line-height: 1.6;
            max-width: 500px;
            margin: 0 auto;
        }
        
        /* Toggle status butonu için stil */
        .toggle-status-btn {
            margin-top: 10px;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            background-color: #f0f0f0;
            color: #333;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
            align-self: flex-start;
            margin-top: auto;
        }
        
        .toggle-status-btn:hover {
            background-color: #e0e0e0;
        }
        
        .status-active .toggle-status-btn {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .status-inactive .toggle-status-btn {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        /* Çıkış butonu için stil */
        .logout-btn {
            margin-left: 10px;
            padding: 8px 15px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        .logout-btn:hover {
            background-color: #c0392b;
        }
        
        /* Müşteri adı ve telefon numarası için stil */
        .customer-name {
            font-weight: 600;
            margin-bottom: 5px;
            position: relative;
            cursor: pointer;
            text-decoration: underline dotted;
        }
        
        .customer-name:hover::after {
            content: attr(data-phone);
            position: absolute;
            bottom: 100%;
            left: 0;
            background: #333;
            color: white;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 100;
        }
        
        /* Randevu durumu tik işareti */
        .attendance-indicator {
            margin-left: 8px;
            vertical-align: middle;
            color: #27ae60;
        }
        
        .attendance-indicator.not-attended {
            color: #e74c3c;
        }
        
        .resource-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            padding: 20px 0;
        }
        
        /* Yeni müşteri bilgileri stilleri */
        .customer-info {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .customer-name {
            font-weight: 600;
            cursor: pointer;
            border-bottom: 1px dotted #666;
            margin-right: 10px;
        }
        
        .customer-name:hover {
            color: #1a73e8;
        }
        
        .attendance-indicator {
            font-size: 18px;
            margin-left: 5px;
            vertical-align: middle;
        }
        
        .attendance-indicator.not-attended {
            color: #d32f2f;
        }
        
        /* Durum stilleri */
        .status-waiting {
            background-color: #fff3e0;
            color: #e65100;
        }
        
        .status-approved {
            background-color: #e3f2fd;
            color: #0d47a1;
        }
        
        .status-completed {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .status-noshow {
            background-color: #ffebee;
            color: #b71c1c;
        }
        
        .status-rejected {
            background-color: #eeeeee;
            color: #757575;
        }
        
        .attendance-indicator {
            background: white;
            border-radius: 50%;
            padding: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        /* Mesaj Butonu Stilleri */
        .message-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: relative;
        }

        .message-btn:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        /* Mesaj Bildirimi Badge */
        .message-notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #ff4757, #ff3742);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(255, 71, 87, 0.4);
            animation: pulse 2s infinite;
            z-index: 10;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(255, 71, 87, 0.4);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 4px 12px rgba(255, 71, 87, 0.6);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(255, 71, 87, 0.4);
            }
        }

        /* Mesajlaşma Modal Stilleri */
        .message-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .message-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            height: 70vh;
            max-height: 600px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .message-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .message-modal-header h3 {
            margin: 0;
            font-size: 1.2rem;
        }

        .message-modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .message-modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message-item {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .message-item.sent {
            align-items: flex-end;
        }

        .message-item.received {
            align-items: flex-start;
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            position: relative;
        }

        .message-item.sent .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message-item.received .message-bubble {
            background: white;
            color: #333;
            border: 1px solid #e2e8f0;
        }

        .message-info {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 5px;
            padding: 0 5px;
        }

        .message-input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 25px;
            outline: none;
            font-size: 0.9rem;
            resize: none;
            font-family: inherit;
        }

        .message-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .send-message-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .send-message-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .send-message-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .messages-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
            color: #64748b;
        }

        .no-messages {
            text-align: center;
            color: #64748b;
            padding: 40px;
            font-style: italic;
        }
        
        .attendance-indicator[title*="geldi"] {
            color: #28a745;
        }
        
        .attendance-indicator.not-attended {
            color: #dc3545;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .dashboard-nav {
                padding: 10px 20px;
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-left, .nav-right {
                width: 100%;
                justify-content: center;
            }
            
            .dashboard-main {
                padding: 20px;
            }
            
            .welcome-message {
                padding: 30px 20px;
            }
            
            .welcome-message h2 {
                font-size: 2rem;
            }
            
            .welcome-message p {
                font-size: 1rem;
            }
            
            .resources-section {
                padding: 30px 20px;
            }
            
            .resources-section h3 {
                font-size: 1.6rem;
            }
            
            .resources-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .appointment-list {
                padding: 30px 20px;
            }
            
            .appointment-list h3 {
                font-size: 1.5rem;
            }
            
            .appointment-item {
                flex-direction: column;
                gap: 20px;
                align-items: stretch;
            }
            
            .appointment-actions {
                flex-direction: row;
                justify-content: center;
                align-items: center;
            }
            
            .customer-avatar {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
        }
        
        @media (max-width: 480px) {
            .menu-item, .logout-btn {
                padding: 10px 15px;
                font-size: 13px;
            }
            
            .welcome-message h2 {
                font-size: 1.8rem;
            }
            
            .resources-section h3, .appointment-list h3 {
                font-size: 1.4rem;
            }
            
            .resource-card {
                padding: 20px;
            }
            
            .resource-icon {
                font-size: 40px;
            }
            
            .resource-title {
                font-size: 1.2rem;
            }
        }

        /* Masa Saat Yönetimi Stilleri */
        .resource-schedule-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
            margin-bottom: 30px;
            display: none;
        }

        .resource-schedule-section.active {
            display: block;
            animation: fadeInUp 0.6s ease;
        }

        .resource-schedule-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb, #f5576c);
            background-size: 300% 100%;
            animation: gradientShift 3s ease infinite;
        }

        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.1);
        }

        .schedule-title {
            font-size: 2rem;
            color: #2c3e50;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .date-selector {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .date-input {
            padding: 12px 16px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            background: white;
            transition: all 0.3s ease;
        }

        .date-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .time-grid-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }

        .resource-time-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 249, 250, 0.9));
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(102, 126, 234, 0.1);
            transition: all 0.3s ease;
        }

        .resource-time-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
        }

        .resource-time-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
        }

        .resource-time-icon {
            font-size: 32px;
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            padding: 12px;
            border-radius: 12px;
        }

        .resource-time-info h4 {
            font-size: 1.3rem;
            color: #2c3e50;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .resource-time-info p {
            color: #7f8c8d;
            font-size: 14px;
        }

        .time-slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 12px;
            margin-top: 20px;
        }

        .time-slot-btn {
            padding: 12px 8px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 10px;
            background: white;
            color: #2c3e50;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
        }

        .time-slot-btn:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
            transform: translateY(-2px);
        }

        .time-slot-btn.available {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            border-color: #27ae60;
        }

        .time-slot-btn.blocked {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border-color: #c0392b;
        }

        .time-slot-btn.occupied {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            border-color: #e67e22;
            cursor: not-allowed;
        }

        .time-slot-btn.occupied::after {
            content: '🔒';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 10px;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 25px;
            padding: 20px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .legend-available { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .legend-blocked { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .legend-occupied { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .legend-default { background: white; border: 2px solid rgba(102, 126, 234, 0.2); }

        .save-schedule-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 15px;
            margin-top: 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }

        .save-schedule-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .back-btn:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateX(-3px);
        }
    </style>
</head>
<body class="dashboard-page">
    <div class="dashboard-container">
        <nav class="dashboard-nav">
            <div class="nav-left">
                <div class="menu-item" onclick="window.location.href='/business-profile-view'">
                    <span class="material-icons">business</span>
                    <span>İşletmem</span>
                </div>
            </div>
            <div class="nav-right">
                <button class="logout-btn" onclick="logout()">
                    <span class="material-icons">exit_to_app</span>
                    <span>Çıkış Yap</span>
                </button>
            </div>
        </nav>
        
        <main class="dashboard-main">
            <div class="welcome-message">
                <h2>İşletme Panelinize Hoş Geldiniz</h2>
                <p>İşletmenizi yönetmek için sol üst menüden "İşletmem" seçeneğine tıklayabilirsiniz.</p>
            </div>
            
            <div class="resources-section">
                <h3>İşletme Kaynakları</h3>
                <p class="section-description">İşletmenize ait kaynaklar aşağıda listelenmiştir. Yeni kaynak eklemek için "İşletmem" menüsünden "Kaynaklar" sekmesini kullanabilirsiniz.</p>
                <div id="resourcesCardContainer" class="resources-grid">
                    <div class="loading-placeholder">Yükleniyor...</div>
                </div>
                
                <div id="resourceAppointments" class="appointment-list">
                    <h3 id="selectedResourceTitle">Seçili Kaynak Randevuları</h3>
                    <div id="appointmentsList">
                        <p class="no-appointments-message">Lütfen randevularını görmek istediğiniz kaynağı seçin.</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Masa/Kaynak Saat Yönetimi Bölümü -->
        <div id="resourceScheduleSection" class="resource-schedule-section">
            <div class="back-btn" onclick="hideScheduleSection()">
                <span class="material-icons">arrow_back</span>
                <span>Geri Dön</span>
            </div>
            
            <div class="schedule-header">
                <h3 class="schedule-title" id="scheduleResourceTitle">Masa Saat Yönetimi</h3>
                <div class="date-selector">
                    <label for="scheduleDate">Tarih:</label>
                    <input type="date" id="scheduleDate" class="date-input">
                </div>
            </div>
            
            <div class="time-grid-container" id="timeGridContainer">
                <!-- Kaynak saat kartları buraya dinamik olarak eklenecek -->
            </div>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color legend-available"></div>
                    <span>Müsait</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-blocked"></div>
                    <span>Hizmet Verilmiyor</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-occupied"></div>
                    <span>Randevu Var</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-default"></div>
                    <span>Varsayılan</span>
                </div>
            </div>
            
            <button class="save-schedule-btn" onclick="saveResourceSchedule()">
                <span class="material-icons">save</span>
                <span>Değişiklikleri Kaydet</span>
            </button>
        </div>
    </div>
    <script>
    // Çıkış yapma fonksiyonu
    function logout() {
        if (confirm('Çıkış yapmak istediğinize emin misiniz?')) {
            localStorage.removeItem('token'); // Token'ı sil
            window.location.href = '/'; // Ana sayfaya yönlendir
        }
    }

    async function approveAppointment(id, resourceId = null) {
        if (!confirm('Bu randevuyu onaylamak istiyor musunuz?')) return;
        
        console.log('Randevu onaylama isteği:', { id, resourceId });
        
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/appointments/approve`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ id })
        });
        
        const responseData = await response.json();
        console.log('Onaylama yanıtı:', responseData);
        
        if (response.ok) {
            alert('Randevu onaylandı!');
            if (resourceId) {
                // Eğer kaynak bazlı görünümden onaylandıysa, o kaynağın randevularını yenile
                fetchResourceAppointments(resourceId);
                // Kaynak kartlarını da güncelle
                fetchResources();
            }
        } else {
            console.error('Onaylama hatası:', responseData);
            alert(`Onaylama işlemi başarısız: ${responseData.error || 'Bilinmeyen hata'}`);
        }
    }

    async function rejectAppointment(id, resourceId = null) {
        if (!confirm('Bu randevuyu reddetmek istiyor musunuz?')) return;
        
        console.log('Randevu reddetme isteği:', { id, resourceId });
        
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/appointments/reject`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ id })
        });
        
        const responseData = await response.json();
        console.log('Reddetme yanıtı:', responseData);
        
        if (response.ok) {
            alert('Randevu reddedildi!');
            if (resourceId) {
                // Eğer kaynak bazlı görünümden reddedildiyse, o kaynağın randevularını yenile
                fetchResourceAppointments(resourceId);
                // Kaynak kartlarını da güncelle
                fetchResources();
            }
        } else {
            console.error('Reddetme hatası:', responseData);
            alert(`Reddetme işlemi başarısız: ${responseData.error || 'Bilinmeyen hata'}`);
        }
    }

    // Kaynak türüne göre ikon seçimi
    function getResourceIcon(resourceType) {
        const icons = {
            'klinik': 'medical_services',
            'koltuk': 'chair',
            'oda': 'meeting_room',
            'saha': 'sports_soccer',
            'masa': 'table_restaurant',
            'generic': 'category'
        };
        
        return icons[resourceType] || 'category';
    }
    
    // Kaynak türüne göre etiket
    function getResourceTypeLabel(resourceType) {
        const labels = {
            'klinik': 'Klinik',
            'koltuk': 'Koltuk',
            'oda': 'Oda',
            'saha': 'Saha',
            'masa': 'Masa',
            'generic': 'Genel'
        };
        
        return labels[resourceType] || 'Kaynak';
    }
    
    // Kaynakları yükle ve göster
    async function fetchResources() {
        const container = document.getElementById('resourcesCardContainer');
        container.innerHTML = '<div class="loading-placeholder">Yükleniyor...</div>';
        
        try {
            const token = localStorage.getItem('token');
            const response = await fetch('/api/business/resources', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (!response.ok) {
                throw new Error('Kaynaklar alınamadı');
            }
            
            const data = await response.json();
            
            if (data.resources.length === 0) {
                container.innerHTML = `
                    <div class="empty-resources">
                        <span class="material-icons">inventory_2</span>
                        <p>Henüz kaynak eklenmemiş. İşletmenize kaynak eklemek için "İşletmem" > "Kaynaklar" bölümüne gidin.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            // Kaynakların randevu sayılarını alma
            const appointmentCountsResponse = await fetch('/api/business/resource-appointments/count', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            let appointmentCounts = {};
            if (appointmentCountsResponse.ok) {
                appointmentCounts = await appointmentCountsResponse.json();
            }
            
            // Kaynakları kutucuklar halinde göster
            data.resources.forEach(resource => {
                const card = document.createElement('div');
                card.className = 'resource-card';
                card.setAttribute('data-resource-id', resource.id);
                card.setAttribute('data-resource-name', resource.name);
                
                const icon = getResourceIcon(resource.resource_type);
                const typeLabel = getResourceTypeLabel(resource.resource_type);
                
                // Bekleyen randevu sayısı
                const pendingCount = appointmentCounts[resource.id]?.pending || 0;
                const badgeHtml = pendingCount > 0 ? 
                    `<span class="appointment-badge ${pendingCount > 5 ? 'urgent' : ''}">
                        <span class="material-icons">event</span>
                        ${pendingCount}
                    </span>` : '';
                
                card.innerHTML = `
                    ${badgeHtml}
                    <span class="resource-type-tag">${typeLabel}</span>
                    <span class="material-icons resource-icon">${icon}</span>
                    <h3 class="resource-title">${resource.name}</h3>
                    <div class="resource-status ${resource.status === 'active' ? 'status-active' : 'status-inactive'}">
                        <span class="material-icons">${resource.status === 'active' ? 'check_circle' : 'cancel'}</span>
                        <span>${resource.status === 'active' ? 'Aktif' : 'Pasif'}</span>
                    </div>
                    <button class="toggle-status-btn" onclick="toggleResourceStatus(event, '${resource.id}', '${resource.status}')">
                        ${resource.status === 'active' ? 'Pasif Yap' : 'Aktif Yap'}
                    </button>
                    <button class="toggle-status-btn schedule-btn" onclick="showScheduleSection('${resource.id}', '${resource.name}')" style="margin-top: 10px; background: linear-gradient(135deg, #667eea, #764ba2);">
                        <span class="material-icons">schedule</span> Saat Yönetimi
                    </button>
                `;
                
                // Kaynağa tıklandığında randevu listesi göster
                card.addEventListener('click', () => {
                    // Tüm kartların seçili durumunu kaldır
                    document.querySelectorAll('.resource-card').forEach(c => {
                        c.classList.remove('selected');
                    });
                    
                    // Bu kartı seçili yap
                    card.classList.add('selected');
                    
                    // Randevu listesini görünür yap
                    document.getElementById('resourceAppointments').classList.add('active');
                    
                    // Başlığı güncelle
                    document.getElementById('selectedResourceTitle').textContent = 
                        `${resource.name} - Randevular`;
                    
                    // Randevuları getir
                    fetchResourceAppointments(resource.id);
                });
                
                container.appendChild(card);
            });
            
        } catch (error) {
            console.error('Kaynaklar yüklenirken hata:', error);
            container.innerHTML = `<div class="loading-placeholder">Hata: ${error.message}</div>`;
        }
    }
    
    // Seçili kaynağın randevularını getir
    async function fetchResourceAppointments(resourceId) {
        const appointmentsList = document.getElementById('appointmentsList');
        appointmentsList.innerHTML = '<div class="loading-placeholder">Randevular yükleniyor...</div>';
        
        try {
            const token = localStorage.getItem('token');
            const response = await fetch(`/api/business/resource-appointments/${resourceId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (!response.ok) {
                throw new Error('Randevular alınamadı');
            }
            
            const appointments = await response.json();
            
            // Reddedilmemiş, tamamlanmamış ve gelmedi randevuları filtrele
            const filteredAppointments = appointments.filter(app => 
                app.status !== 'Reddedildi' && 
                app.status !== 'Tamamlandı' && 
                app.status !== 'completed' &&
                app.status !== 'Gelmedi' &&
                app.status !== 'noShow'
            );
            
            if (filteredAppointments.length === 0) {
                appointmentsList.innerHTML = '<p class="no-appointments-message">Bu kaynağa ait randevu bulunmamaktadır.</p>';
                return;
            }
            
            appointmentsList.innerHTML = '';
            
            // Randevuları listele
            filteredAppointments.forEach(app => {
                const appointmentItem = document.createElement('div');
                appointmentItem.className = 'appointment-item';
                
                // Tarih ve saat formatı
                const date = new Date(app.appointment_date);
                const formattedDate = date.toLocaleDateString('tr-TR', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric' 
                });
                const formattedTime = date.toLocaleTimeString('tr-TR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                // Durum sınıfı
                let statusClass = '';
                let statusText = '';
                let attendanceIcon = '';
                
                switch(app.status) {
                    case 'Beklemede':
                        statusClass = 'status-waiting';
                        statusText = 'Beklemede';
                        break;
                    case 'Onaylandı':
                        statusClass = 'status-approved';
                        statusText = 'Onaylandı';
                        break;
                    case 'Tamamlandı':
                        statusClass = 'status-completed';
                        statusText = 'Tamamlandı';
                        attendanceIcon = '<span class="material-icons attendance-indicator" title="Randevuya geldi">check_circle</span>';
                        break;
                    case 'Gelmedi':
                        statusClass = 'status-noshow';
                        statusText = 'Gelmedi';
                        attendanceIcon = '<span class="material-icons attendance-indicator not-attended" title="Randevuya gelmedi">cancel</span>';
                        break;
                    case 'Reddedildi':
                        statusClass = 'status-rejected';
                        statusText = 'Reddedildi';
                        break;
                    default:
                        statusClass = 'status-waiting';
                        statusText = app.status;
                }
                
                const customerPhone = app.customer_phone || 'Telefon bilgisi yok';
                
                // Müşteri ismi için avatar oluştur
                const customerName = app.customer_name || 'Randevu talep eden';
                const initials = customerName.split(' ').map(n => n && n[0] || '').join('').substring(0, 2).toUpperCase();
                
                appointmentItem.innerHTML = `
                    <div class="appointment-details">
                        <div class="customer-info">
                            <div class="customer-avatar">${initials}</div>
                            <div class="customer-details">
                                <div class="customer-name" data-phone="${customerPhone}" title="Telefon: ${customerPhone}">${customerName}</div>
                                <div class="customer-phone">
                                    <span class="material-icons">phone</span>
                                    ${customerPhone}
                                </div>
                            </div>
                            ${attendanceIcon || ''}
                        </div>
                        <div class="service-info">
                            <span class="material-icons">medical_services</span>
                            <span class="service-name">${app.service_name || 'Hizmet belirtilmemiş'}</span>
                            <span class="service-price">${app.service_price ? app.service_price + ' TL' : 'Fiyat yok'}</span>
                        </div>
                        <div class="appointment-time">
                            <span class="material-icons">schedule</span>
                            <span>${formattedDate} - ${formattedTime}</span>
                        </div>
                    </div>
                    <div class="appointment-status ${statusClass}">${statusText}</div>
                `;
                
                // Eğer randevu beklemedeyse işlem butonlarını ekle
                if (app.status === 'Beklemede') {
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'appointment-actions';
                    
                    const approveBtn = document.createElement('button');
                    approveBtn.className = 'action-btn approve-btn';
                    approveBtn.innerHTML = '<span class="material-icons">check</span> Onayla';
                    approveBtn.onclick = (e) => {
                        e.stopPropagation(); // Olayın üst elemanlara yayılmasını engelle
                        approveAppointment(app.id, resourceId);
                    };
                    
                    const rejectBtn = document.createElement('button');
                    rejectBtn.className = 'action-btn reject-btn';
                    rejectBtn.innerHTML = '<span class="material-icons">close</span> Reddet';
                    rejectBtn.onclick = (e) => {
                        e.stopPropagation(); // Olayın üst elemanlara yayılmasını engelle
                        rejectAppointment(app.id, resourceId);
                    };
                    
                    // Mesajlaşma butonu ekle
                    const messageBtn = document.createElement('button');
                    messageBtn.className = 'action-btn message-btn';
                    messageBtn.innerHTML = '<span class="material-icons">message</span> Mesaj';
                    messageBtn.onclick = (e) => {
                        e.stopPropagation();
                        openMessageModal(app.id, app.customer_name);
                    };
                    
                    // Okunmamış mesaj sayısını kontrol et ve badge ekle
                    checkUnreadMessages(app.id, messageBtn);
                    
                    actionsDiv.appendChild(approveBtn);
                    actionsDiv.appendChild(rejectBtn);
                    actionsDiv.appendChild(messageBtn);
                    appointmentItem.appendChild(actionsDiv);
                } else if (app.status === 'Onaylandı') {
                    // Onaylanmış randevular için "geldi/gelmedi" işaretleme butonları
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'appointment-actions';
                    
                    const attendedBtn = document.createElement('button');
                    attendedBtn.className = 'action-btn approve-btn';
                    attendedBtn.innerHTML = '<span class="material-icons">check_circle</span> Geldi';
                    attendedBtn.onclick = (e) => {
                        e.stopPropagation();
                        markAttendance(app.id, 'attended', resourceId);
                    };
                    
                    const notAttendedBtn = document.createElement('button');
                    notAttendedBtn.className = 'action-btn reject-btn';
                    notAttendedBtn.innerHTML = '<span class="material-icons">cancel</span> Gelmedi';
                    notAttendedBtn.onclick = (e) => {
                        e.stopPropagation();
                        markAttendance(app.id, 'not_attended', resourceId);
                    };
                    
                    // Mesajlaşma butonu ekle
                    const messageBtn = document.createElement('button');
                    messageBtn.className = 'action-btn message-btn';
                    messageBtn.innerHTML = '<span class="material-icons">message</span> Mesaj';
                    messageBtn.onclick = (e) => {
                        e.stopPropagation();
                        openMessageModal(app.id, app.customer_name);
                    };
                    
                    // Okunmamış mesaj sayısını kontrol et ve badge ekle
                    checkUnreadMessages(app.id, messageBtn);
                    
                    actionsDiv.appendChild(attendedBtn);
                    actionsDiv.appendChild(notAttendedBtn);
                    actionsDiv.appendChild(messageBtn);
                    appointmentItem.appendChild(actionsDiv);
                } else {
                    // Diğer durumlar için (Tamamlandı, Reddedildi, Gelmedi) sadece mesaj butonu
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'appointment-actions';
                    
                    const messageBtn = document.createElement('button');
                    messageBtn.className = 'action-btn message-btn';
                    messageBtn.innerHTML = '<span class="material-icons">message</span> Mesaj';
                    messageBtn.onclick = (e) => {
                        e.stopPropagation();
                        openMessageModal(app.id, app.customer_name);
                    };
                    
                    // Okunmamış mesaj sayısını kontrol et ve badge ekle
                    checkUnreadMessages(app.id, messageBtn);
                    
                    actionsDiv.appendChild(messageBtn);
                    appointmentItem.appendChild(actionsDiv);
                }
                
                appointmentsList.appendChild(appointmentItem);
            });
            
            // Telefon numarası gösterme için olay dinleyici ekle
            document.querySelectorAll('.customer-name').forEach(el => {
                el.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const phone = this.getAttribute('data-phone');
                    if (phone && phone !== 'Telefon bilgisi yok') {
                        if (confirm('Telefon numarasını aramak için telefonunuzun arama uygulaması açılacak. Devam etmek istiyor musunuz?')) {
                            window.open(`tel:${phone}`, '_blank');
                        }
                    } else {
                        alert('Telefon bilgisi bulunmamaktadır.');
                    }
                });
            });
            
        } catch (error) {
            console.error('Randevular yüklenirken hata:', error);
            appointmentsList.innerHTML = `<div class="loading-placeholder">Hata: ${error.message}</div>`;
        }
    }
    
    // Randevu geldi/gelmedi işaretleme fonksiyonu
    async function markAttendance(id, status, resourceId) {
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Oturum süreniz dolmuş. Lütfen yeniden giriş yapın.');
                window.location.href = '/login.html';
                return;
            }
            
            // Kullanıcıya işlem durumunu bildir
            alert('Randevu durumu güncelleniyor, lütfen bekleyin...');
            
            // Doğru API endpoint'lerini kullan
            let endpoint = '';
            if (status === 'attended') {
                endpoint = '/api/appointments/mark-attended';  // Geldi olarak işaretleme
            } else {
                endpoint = '/api/appointments/mark-not-attended';   // Gelmedi olarak işaretleme
            }
            
            console.log(`İşaretleme isteği gönderiliyor: ${endpoint}, ID: ${id}`);
            
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ id })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                alert(status === 'attended' ? 'Müşteri geldi olarak işaretlendi' : 'Müşteri gelmedi olarak işaretlendi');
                // Randevuları yenile
                fetchResourceAppointments(resourceId);
            } else {
                console.error('API Hatası:', data);
                
                // Token hatası durumunda yeniden giriş yapma
                if (response.status === 401 || response.status === 403) {
                    alert(`Oturum hatası: ${data.error || 'Oturum süreniz dolmuş.'}. Lütfen yeniden giriş yapın.`);
                    localStorage.removeItem('token');  // Geçersiz token'ı temizle
                    window.location.href = '/login.html';
                    return;
                }
                
                alert(`İşlem başarısız oldu: ${data.error || 'Bilinmeyen hata'}`);
            }
        } catch (error) {
            console.error('İşaretleme hatası:', error);
            alert(`Bağlantı hatası: ${error.message}`);
        }
    }
    
    // Sayfa yüklendiğinde randevuları ve kaynakları yükle
    document.addEventListener('DOMContentLoaded', function() {
        fetchResources();
    });
    
    // Kaynak durumunu değiştirme fonksiyonu
    async function toggleResourceStatus(event, resourceId, currentStatus) {
        // Tıklama olayının üst karta (resource-card) yayılmasını engelle
        event.stopPropagation();
        
        const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
        
        try {
            const token = localStorage.getItem('token');
            const response = await fetch(`/api/business/resources/${resourceId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ status: newStatus })
            });
            
            if (!response.ok) {
                throw new Error('Durum değiştirilemedi');
            }
            
            // Durumu değiştirdikten sonra kaynakları yeniden yükle
            fetchResources();
            
        } catch (error) {
            console.error('Kaynak durumu değiştirilirken hata:', error);
            alert(`Hata: ${error.message}`);
        }
    }

    // Saat yönetimi fonksiyonları
    let currentScheduleData = {};
    let selectedResourceForSchedule = null;

    // Saat yönetimi ekranını göster
    function showScheduleSection(resourceId, resourceName) {
        selectedResourceForSchedule = resourceId;
        
        // Başlığı güncelle
        document.getElementById('scheduleResourceTitle').textContent = `${resourceName} - Saat Yönetimi`;
        
        // Bugünün tarihini varsayılan olarak ayarla
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('scheduleDate').value = today;
        
        // Saat yönetimi bölümünü göster
        document.getElementById('resourceScheduleSection').classList.add('active');
        
        // Ana bölümü gizle
        document.querySelector('.resources-section').style.display = 'none';
        
        // Seçilen tarih için saatleri yükle
        loadResourceSchedule(resourceId, today);
        
        // Tarih değiştiğinde saatleri yeniden yükle
        document.getElementById('scheduleDate').addEventListener('change', function() {
            loadResourceSchedule(resourceId, this.value);
        });
    }

    // Saat yönetimi ekranını gizle
    function hideScheduleSection() {
        document.getElementById('resourceScheduleSection').classList.remove('active');
        document.querySelector('.resources-section').style.display = 'block';
        selectedResourceForSchedule = null;
        currentScheduleData = {};
    }

    // Kaynak için saat programını yükle
    async function loadResourceSchedule(resourceId, date) {
        const container = document.getElementById('timeGridContainer');
        container.innerHTML = '<div class="loading-placeholder">Saat programı yükleniyor...</div>';
        
        try {
            const token = localStorage.getItem('token');
            
            // İşletmenin çalışma saatlerini al
            const scheduleResponse = await fetch(`/api/business/schedule?businessId=${resourceId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            // Seçilen tarih için mevcut randevuları al
            const appointmentsResponse = await fetch(`/api/business/occupied-slots?businessId=${resourceId}&date=${date}&resourceId=${resourceId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            // Engellenen saatleri al (eğer API varsa)
            const blockedResponse = await fetch(`/api/business/blocked-slots?resourceId=${resourceId}&date=${date}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            let workingHours = { start: '09:00', end: '17:00' }; // Varsayılan
            let occupiedSlots = [];
            let blockedSlots = [];
            
            if (scheduleResponse.ok) {
                const scheduleData = await scheduleResponse.json();
                // Seçilen tarihin gününe göre çalışma saatlerini bul
                const dayOfWeek = new Date(date).getDay();
                const adjustedDay = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Pazar=6, Pazartesi=0
                
                const daySchedule = scheduleData.find(s => parseInt(s.day_of_week) === adjustedDay);
                if (daySchedule && daySchedule.is_working) {
                    workingHours = {
                        start: daySchedule.start_time ? daySchedule.start_time.substring(0, 5) : '09:00',
                        end: daySchedule.end_time ? daySchedule.end_time.substring(0, 5) : '17:00'
                    };
                }
            }
            
            if (appointmentsResponse.ok) {
                const appointmentsData = await appointmentsResponse.json();
                occupiedSlots = appointmentsData.occupiedSlots || [];
            }
            
            if (blockedResponse.ok) {
                const blockedData = await blockedResponse.json();
                blockedSlots = blockedData.blockedSlots || [];
            }
            
            // Saat dilimlerini oluştur
            generateTimeSlots(workingHours, occupiedSlots, blockedSlots, resourceId);
            
        } catch (error) {
            console.error('Saat programı yüklenirken hata:', error);
            container.innerHTML = `<div class="loading-placeholder">Hata: ${error.message}</div>`;
        }
    }

    // Saat dilimlerini oluştur
    function generateTimeSlots(workingHours, occupiedSlots, blockedSlots, resourceId) {
        const container = document.getElementById('timeGridContainer');
        
        // Çalışma saatlerini parse et
        const [startHour, startMinute] = workingHours.start.split(':').map(Number);
        const [endHour, endMinute] = workingHours.end.split(':').map(Number);
        
        // Saat dilimlerini oluştur
        const timeSlots = [];
        for (let hour = startHour; hour <= endHour; hour++) {
            if (hour < endHour || (hour === endHour && 0 <= endMinute)) {
                timeSlots.push(`${hour.toString().padStart(2, '0')}:00`);
            }
        }
        
        // Kaynak kartı oluştur
        const resourceCard = document.createElement('div');
        resourceCard.className = 'resource-time-card';
        
        const resourceName = document.querySelector(`[data-resource-id="${resourceId}"]`)?.getAttribute('data-resource-name') || 'Kaynak';
        const resourceType = document.querySelector(`[data-resource-id="${resourceId}"] .resource-type-tag`)?.textContent || 'Kaynak';
        
        resourceCard.innerHTML = `
            <div class="resource-time-header">
                <span class="material-icons resource-time-icon">table_restaurant</span>
                <div class="resource-time-info">
                    <h4>${resourceName}</h4>
                    <p>${resourceType} - ${workingHours.start} - ${workingHours.end}</p>
                </div>
            </div>
            <div class="time-slots-grid" id="timeSlots_${resourceId}">
                ${timeSlots.map(time => {
                    let slotClass = 'time-slot-btn';
                    let slotStatus = 'default';
                    
                    if (occupiedSlots.includes(time)) {
                        slotClass += ' occupied';
                        slotStatus = 'occupied';
                    } else if (blockedSlots.includes(time)) {
                        slotClass += ' blocked';
                        slotStatus = 'blocked';
                    } else {
                        slotClass += ' available';
                        slotStatus = 'available';
                    }
                    
                    return `
                        <button class="${slotClass}" 
                                data-time="${time}" 
                                data-resource="${resourceId}"
                                data-status="${slotStatus}"
                                onclick="toggleTimeSlot(this)"
                                ${slotStatus === 'occupied' ? 'disabled' : ''}>
                            ${time}
                        </button>
                    `;
                }).join('')}
            </div>
        `;
        
        container.innerHTML = '';
        container.appendChild(resourceCard);
        
        // Mevcut durumu kaydet
        currentScheduleData[resourceId] = {
            date: document.getElementById('scheduleDate').value,
            blockedSlots: [...blockedSlots],
            originalBlockedSlots: [...blockedSlots]
        };
    }

    // Saat dilimi durumunu değiştir
    function toggleTimeSlot(button) {
        const currentStatus = button.getAttribute('data-status');
        
        // Randevu olan saatlere dokunma
        if (currentStatus === 'occupied') {
            return;
        }
        
        const time = button.getAttribute('data-time');
        const resourceId = button.getAttribute('data-resource');
        
        // Durum değiştir
        if (currentStatus === 'blocked') {
            // Engellenmişten müsaite çevir
            button.className = 'time-slot-btn available';
            button.setAttribute('data-status', 'available');
            
            // Engellenen listeden çıkar
            const index = currentScheduleData[resourceId].blockedSlots.indexOf(time);
            if (index > -1) {
                currentScheduleData[resourceId].blockedSlots.splice(index, 1);
            }
        } else {
            // Müsaitten engellenmiş'e çevir
            button.className = 'time-slot-btn blocked';
            button.setAttribute('data-status', 'blocked');
            
            // Engellenen listeye ekle
            if (!currentScheduleData[resourceId].blockedSlots.includes(time)) {
                currentScheduleData[resourceId].blockedSlots.push(time);
            }
        }
    }

    // Saat programını kaydet
    async function saveResourceSchedule() {
        if (!selectedResourceForSchedule || !currentScheduleData[selectedResourceForSchedule]) {
            alert('Kaydedilecek değişiklik bulunamadı.');
            return;
        }
        
        const resourceId = selectedResourceForSchedule;
        const scheduleData = currentScheduleData[resourceId];
        const date = document.getElementById('scheduleDate').value;
        
        try {
            const token = localStorage.getItem('token');
            
            const response = await fetch('/api/business/blocked-slots', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    resourceId: resourceId,
                    date: date,
                    blockedSlots: scheduleData.blockedSlots
                })
            });
            
            if (response.ok) {
                alert('Saat programı başarıyla kaydedildi!');
                // Orijinal durumu güncelle
                scheduleData.originalBlockedSlots = [...scheduleData.blockedSlots];
            } else {
                const errorData = await response.json();
                alert(`Kaydetme hatası: ${errorData.error || 'Bilinmeyen hata'}`);
            }
            
        } catch (error) {
            console.error('Saat programı kaydedilirken hata:', error);
            alert(`Bağlantı hatası: ${error.message}`);
        }
    }

    // Kaynak kartlarına saat yönetimi butonu ekle
    function addScheduleButtonToResourceCards() {
        document.querySelectorAll('.resource-card').forEach(card => {
            const resourceId = card.getAttribute('data-resource-id');
            const resourceName = card.getAttribute('data-resource-name');
            
            // Eğer zaten buton varsa ekleme
            if (card.querySelector('.schedule-btn')) return;
            
            const scheduleBtn = document.createElement('button');
            scheduleBtn.className = 'toggle-status-btn schedule-btn';
            scheduleBtn.style.marginTop = '10px';
            scheduleBtn.innerHTML = '<span class="material-icons">schedule</span> Saat Yönetimi';
            scheduleBtn.onclick = (e) => {
                e.stopPropagation();
                showScheduleSection(resourceId, resourceName);
            };
            
            card.appendChild(scheduleBtn);
        });
    }

    // ===== MESAJLAŞMA FONKSİYONLARI =====
    
    let currentAppointmentId = null;
    let messagePollingInterval = null;
    
    // Okunmamış mesaj sayısını kontrol et ve badge ekle
    async function checkUnreadMessages(appointmentId, messageBtn) {
        try {
            const token = localStorage.getItem('token');
            const response = await fetch(`/api/messages/unread/${appointmentId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                const { unreadCount } = await response.json();
                if (unreadCount > 0) {
                    // Mevcut badge'i kaldır
                    const existingBadge = messageBtn.querySelector('.message-notification-badge');
                    if (existingBadge) {
                        existingBadge.remove();
                    }
                    
                    // Yeni badge ekle
                    const badge = document.createElement('span');
                    badge.className = 'message-notification-badge';
                    badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                    messageBtn.appendChild(badge);
                }
            }
        } catch (error) {
            console.log('Okunmamış mesaj kontrolü hatası:', error);
        }
    }
    
    // Mesaj modal'ını aç
    function openMessageModal(appointmentId, customerName) {
        currentAppointmentId = appointmentId;
        document.getElementById('messageModalTitle').textContent = `${customerName} ile Mesajlaşma`;
        document.getElementById('messageModal').style.display = 'block';
        document.getElementById('messageInput').value = '';
        
        // Mesajları yükle
        loadMessages();
        
        // Mesajları okundu olarak işaretle
        markMessagesAsRead(appointmentId);
        
        // 5 saniyede bir mesajları yenile
        messagePollingInterval = setInterval(loadMessages, 5000);
    }
    
    // Mesaj modal'ını kapat
    function closeMessageModal() {
        document.getElementById('messageModal').style.display = 'none';
        currentAppointmentId = null;
        
        // Polling'i durdur
        if (messagePollingInterval) {
            clearInterval(messagePollingInterval);
            messagePollingInterval = null;
        }
        
        // Randevuları yenile (badge'leri güncellemek için)
        const currentResourceId = document.querySelector('.resource-card.selected')?.getAttribute('data-resource-id');
        if (currentResourceId) {
            fetchResourceAppointments(currentResourceId);
        }
    }
    
    // Mesajları okundu olarak işaretle
    async function markMessagesAsRead(appointmentId) {
        try {
            const token = localStorage.getItem('token');
            await fetch(`/api/messages/mark-read/${appointmentId}`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });
        } catch (error) {
            console.log('Mesaj okundu işaretleme hatası:', error);
        }
    }
    
    // Mesajları yükle
    async function loadMessages() {
        if (!currentAppointmentId) return;
        
        try {
            const token = localStorage.getItem('token');
            const response = await fetch(`/api/messages/${currentAppointmentId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                const messages = await response.json();
                displayMessages(messages);
            } else {
                console.error('Mesajlar yüklenemedi');
            }
        } catch (error) {
            console.error('Mesaj yükleme hatası:', error);
        }
    }
    
    // Mesajları göster
    function displayMessages(messages) {
        const container = document.getElementById('messagesContainer');
        const currentUserId = getCurrentUserId();
        
        if (messages.length === 0) {
            container.innerHTML = '<div class="no-messages">Henüz mesaj bulunmuyor. İlk mesajı göndererek sohbeti başlatın!</div>';
            return;
        }
        
        container.innerHTML = messages.map(message => {
            const isSent = message.sender_id == currentUserId;
            const messageClass = isSent ? 'sent' : 'received';
            const time = new Date(message.created_at).toLocaleString('tr-TR', {
                hour: '2-digit',
                minute: '2-digit',
                day: '2-digit',
                month: '2-digit'
            });
            
            return `
                <div class="message-item ${messageClass}">
                    <div class="message-bubble">
                        ${message.message}
                    </div>
                    <div class="message-info">
                        ${isSent ? 'Siz' : message.sender_name} • ${time}
                    </div>
                </div>
            `;
        }).join('');
        
        // En alta scroll
        container.scrollTop = container.scrollHeight;
    }
    
    // Mesaj gönder
    async function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        
        if (!message || !currentAppointmentId) return;
        
        const sendBtn = document.getElementById('sendMessageBtn');
        sendBtn.disabled = true;
        
        try {
            const token = localStorage.getItem('token');
            const response = await fetch('/api/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    appointmentId: currentAppointmentId,
                    message: message
                })
            });
            
            if (response.ok) {
                input.value = '';
                loadMessages(); // Mesajları yenile
            } else {
                alert('Mesaj gönderilemedi');
            }
        } catch (error) {
            console.error('Mesaj gönderme hatası:', error);
            alert('Bağlantı hatası');
        }
        
        sendBtn.disabled = false;
    }
    
    // Mevcut kullanıcı ID'sini al
    function getCurrentUserId() {
        const token = localStorage.getItem('token');
        if (!token) return null;
        
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            return payload.userId;
        } catch (error) {
            return null;
        }
    }
    
    // Enter tuşu ile mesaj gönder
    document.addEventListener('DOMContentLoaded', function() {
        const messageInput = document.getElementById('messageInput');
        if (messageInput) {
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }
        
        // Modal dışına tıklayınca kapatma
        document.getElementById('messageModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeMessageModal();
            }
        });
    });
    
    </script>

    <!-- Mesajlaşma Modal -->
    <div id="messageModal" class="message-modal">
        <div class="message-modal-content">
            <div class="message-modal-header">
                <h3 id="messageModalTitle">Müşteri ile Mesajlaşma</h3>
                <button class="message-modal-close" onclick="closeMessageModal()">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div id="messagesContainer" class="messages-container">
                <div class="messages-loading">
                    <span class="material-icons">hourglass_empty</span>
                    Mesajlar yükleniyor...
                </div>
            </div>
            <div class="message-input-container">
                <input type="text" id="messageInput" class="message-input" placeholder="Mesajınızı yazın..." maxlength="500">
                <button id="sendMessageBtn" class="send-message-btn" onclick="sendMessage()">
                    <span class="material-icons">send</span>
                    Gönder
                </button>
            </div>
        </div>
    </div>
</body>
</html> 