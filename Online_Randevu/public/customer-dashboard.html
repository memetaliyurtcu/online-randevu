<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Müşteri Dashboard - Online Randevu</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="modal-alert.js"></script>
    
    <!-- NAVIGASYON GÜÇLENDIRME CSS - HİÇBİR ŞEKILDE OVERRIDE EDİLEMEZ -->
    <style id="nav-protection-styles">
                 .nav-bar, nav.nav-bar, [class*="nav-bar"] {
             display: flex !important;
             visibility: visible !important;
             opacity: 1 !important;
             position: sticky !important;
             top: 0 !important;
             z-index: 999999 !important;
            width: 100% !important;
            height: auto !important;
            pointer-events: auto !important;
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(20px) !important;
            padding: 0.8rem 1.5rem !important;
            border-radius: 16px !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            margin-bottom: 1.5rem !important;
            justify-content: space-between !important;
            align-items: center !important;
            overflow: visible !important;
        }
        
        .nav-bar *, nav.nav-bar *, [class*="nav-bar"] * {
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
        }
        
        /* MutationObserver koruması */
        .nav-bar[style*="display: none"], .nav-bar[style*="visibility: hidden"] {
            display: flex !important;
            visibility: visible !important;
        }
    </style>
    
    <style>
        /* EMERGENCY NAV BAR FIX */
        nav.nav-bar {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            z-index: 99999 !important;
            width: 100% !important;
            background: rgba(255, 255, 255, 0.95) !important;
            padding: 0.8rem 1.5rem !important;
            border-radius: 16px !important;
            margin-bottom: 1.5rem !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1) !important;
            justify-content: space-between !important;
            align-items: center !important;
        }
        
        nav.nav-bar * {
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* Zorla gösterim class'ı için ekstra güçlendirme */
        .nav-forced-visible {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            z-index: 999999 !important;
            pointer-events: auto !important;
            height: auto !important;
            overflow: visible !important;
        }

        .nav-forced-visible * {
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
        }

        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }

        body {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            min-height: 100vh;
            padding-top: 0;
        }

        /* Modern Gradient Header */
        .header-gradient {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.1) 0%, rgba(25, 118, 210, 0.1) 100%);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        /* Hero Section - Explicit Styling */
        .dashboard-container .hero-section {
            text-align: center !important;
            color: white !important;
            margin-bottom: 2.5rem !important;
            padding: 2rem 0 !important;
            display: block !important;
            visibility: visible !important;
            position: relative !important;
            z-index: 1 !important;
            width: 100% !important;
            box-sizing: border-box !important;
        }

        .dashboard-container .hero-section .hero-title {
            font-size: 3rem !important;
            font-weight: 700 !important;
            margin-bottom: 0.8rem !important;
            color: white !important;
            display: block !important;
            visibility: visible !important;
            line-height: 1.2 !important;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3) !important;
        }

        .dashboard-container .hero-section .hero-subtitle {
            font-size: 1.1rem !important;
            opacity: 0.95 !important;
            font-weight: 400 !important;
            max-width: 600px !important;
            margin: 0 auto !important;
            display: none !important;
            visibility: visible !important;
            color: rgba(255, 255, 255, 0.95) !important;
            line-height: 1.4 !important;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2) !important;
        }

        .dashboard-container {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            padding: 1.5rem;
            box-sizing: border-box;
            position: relative;
            z-index: 1;
        }

        /* Modern Navigation */
        .nav-bar {
            display: flex !important;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(20px);
            padding: 0.8rem 1.5rem;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 1.5rem;
            position: relative !important;
            z-index: 9999 !important;
            visibility: visible !important;
            opacity: 1 !important;
            width: 100% !important;
            height: auto !important;
            overflow: visible !important;
        }
        
        /* Navigasyon elemanlarını güçlendir */
        .nav-bar * {
            visibility: visible !important;
            opacity: 1 !important;
        }

        .nav-left, .nav-center, .nav-right {
            display: flex;
            align-items: center;
        }

        .nav-btn {
            display: flex;
            align-items: center;
            padding: 0.6rem 1.2rem;
            border: none;
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
            font-size: 0.9rem;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
        }

        .nav-btn .material-icons {
            margin-right: 6px;
            font-size: 18px;
        }

        /* Modern Search Box */
        .search-box {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 14px;
            padding: 0.8rem 1.2rem;
            width: 100%;
            max-width: 450px;
            min-width: 250px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .search-box:focus-within {
            border-color: #2196f3;
            box-shadow: 0 4px 25px rgba(33, 150, 243, 0.2);
            transform: translateY(-1px);
        }

        .search-box input {
            border: none;
            background: none;
            padding: 0.4rem;
            width: 100%;
            outline: none;
            font-size: 0.95rem;
            color: #333;
        }

        .search-box input::placeholder {
            color: #888;
        }

        .search-box .material-icons {
            color: #2196f3;
            margin-right: 8px;
        }

        /* Modern Location Filters */
        .location-filters {
            display: flex;
            gap: 0.8rem;
        }

        .location-select {
            padding: 0.6rem 0.8rem;
            border: 2px solid rgba(33, 150, 243, 0.2);
            border-radius: 10px;
            background: white;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            min-width: 120px;
            font-size: 0.9rem;
        }

        .location-select:hover {
            border-color: #2196f3;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.1);
        }

        .location-select:focus {
            border-color: #2196f3;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.2);
            outline: none;
        }

        /* Sadakat Puanı Progress Bar Stilleri */
        .loyalty-progress-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 18px;
            padding: 1.5rem;
            margin-bottom: 1.8rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 28px rgba(0, 0, 0, 0.1);
            position: relative;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        .loyalty-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .loyalty-header h4 {
            color: #333;
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }

        .loyalty-points-display {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2196f3;
        }

        .progress-bar-wrapper {
            position: relative;
            margin-bottom: 1.2rem;
        }

        .progress-bar {
            position: relative;
            height: 12px;
            background: linear-gradient(90deg, #e0e0e0 0%, #f5f5f5 100%);
            border-radius: 24px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50 0%, #66BB6A 25%, #FFC107 50%, #FF9800 75%, #F44336 100%);
            border-radius: 25px;
            transition: width 0.8s ease-in-out;
            width: 0%;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        .progress-checkpoints {
            position: absolute;
            top: -15px;
            left: 0;
            right: 0;
            height: 40px;
            display: flex;
            align-items: center;
            pointer-events: none;
        }

        .checkpoint {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            pointer-events: auto;
        }

        /* Checkpoint pozisyonları - 0, 10, 20, 30, 40 puan için */
        .checkpoint[data-points="0"] { left: 2%; transform: translateX(-50%); }
        .checkpoint[data-points="10"] { left: 27%; transform: translateX(-50%); } /* 10/40 = 25% + padding */
        .checkpoint[data-points="20"] { left: 52%; transform: translateX(-50%); } /* 20/40 = 50% + padding */
        .checkpoint[data-points="30"] { left: 77%; transform: translateX(-50%); } /* 30/40 = 75% + padding */
        .checkpoint[data-points="40"] { left: 98%; transform: translateX(-50%); } /* 40/40 = 100% - padding */

        .checkpoint-circle {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: #e0e0e0;
            border: 2px solid #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.8rem;
            color: #666;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 2;
        }

        .checkpoint.active .checkpoint-circle {
            background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }

        .checkpoint.achieved .checkpoint-circle {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            animation: pulse 2s infinite;
        }

        .checkpoint-amount {
            position: absolute;
            top: 38px;
            font-size: 0.75rem;
            color: #666;
            white-space: nowrap;
            font-weight: 500;
        }

        .checkpoint.active .checkpoint-amount {
            color: #4CAF50;
            font-weight: 600;
        }

        .checkpoint.achieved .checkpoint-amount {
            color: #2196f3;
            font-weight: 600;
        }

        .loyalty-info {
            text-align: center;
            margin-top: 1rem;
        }

        .loyalty-info p {
            color: #666;
            font-size: 0.95rem;
            margin: 0 0 0.5rem 0;
            font-style: italic;
        }

        .discount-info {
            margin-top: 1rem;
            padding: 1rem;
            background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
            border-radius: 12px;
            text-align: center;
        }

        .discount-info p {
            color: white !important;
            font-style: normal !important;
            font-weight: 600 !important;
            margin-bottom: 1rem !important;
        }

        .use-discount-btn {
            background: linear-gradient(135deg, #FF9800 0%, #FF6B35 100%);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
            animation: pulse-discount 2s infinite;
        }

        .use-discount-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4);
        }

        .use-discount-btn:active {
            transform: translateY(0);
        }

        @keyframes pulse-discount {
            0% {
                box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
            }
            50% {
                box-shadow: 0 4px 25px rgba(255, 152, 0, 0.6);
                transform: scale(1.02);
            }
            100% {
                box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
            }
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
            }
            50% {
                box-shadow: 0 4px 25px rgba(33, 150, 243, 0.6);
                transform: scale(1.05);
            }
            100% {
                box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
            }
        }

        /* Bilgi Butonu Stilleri */
        .loyalty-info-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
        }

        .loyalty-info-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }

        /* Bilgi Modal Stilleri */
        .loyalty-info-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .loyalty-info-modal-content {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            margin: 5% auto;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
            overflow: hidden;
        }

        .loyalty-info-modal-header {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            padding: 1.5rem;
            text-align: center;
            position: relative;
        }

        .loyalty-info-modal-header h3 {
            margin: 0;
            font-size: 1.4rem;
            font-weight: 600;
        }

        .loyalty-info-close {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loyalty-info-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-50%) scale(1.1);
        }

        .loyalty-info-modal-body {
            padding: 2rem;
        }

        .loyalty-rule {
            background: rgba(33, 150, 243, 0.08);
            border-left: 4px solid #2196f3;
            padding: 1rem 1.2rem;
            margin-bottom: 1rem;
            border-radius: 0 8px 8px 0;
            position: relative;
        }

        .loyalty-rule:last-child {
            margin-bottom: 0;
        }

        .loyalty-rule-icon {
            position: absolute;
            left: -2px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            background: #2196f3;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }

        .loyalty-rule-content {
            margin-left: 1rem;
        }

        .loyalty-rule-title {
            font-weight: 600;
            color: #2196f3;
            margin-bottom: 0.3rem;
            font-size: 0.95rem;
        }

        .loyalty-rule-desc {
            color: #555;
            font-size: 0.9rem;
            line-height: 1.4;
            margin: 0;
        }

        .loyalty-benefits {
            background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
            color: white;
            padding: 1.2rem;
            border-radius: 12px;
            margin-top: 1.5rem;
            text-align: center;
        }

        .loyalty-benefits-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .loyalty-benefits-desc {
            font-size: 0.9rem;
            opacity: 0.9;
            margin: 0;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .loyalty-progress-container {
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }

            .loyalty-header {
                flex-direction: column;
                gap: 0.5rem;
                text-align: center;
            }

            .checkpoint-circle {
                width: 35px;
                height: 35px;
                font-size: 0.8rem;
            }

            .checkpoint-amount {
                font-size: 0.7rem;
                top: 40px;
            }
        }

        .location-select:focus {
            outline: none;
            border-color: #2196f3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        /* Modern Category Cards */
        .category-section {
            margin: 2.5rem 0;
        }

        .category-title {
            font-size: 1.8rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 1.5rem;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1.2rem;
            margin-bottom: 1.5rem;
        }

        .category-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 1.5rem 0.8rem;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 600;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 2px solid transparent;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .category-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .category-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
        }

        .category-card:hover::before {
            opacity: 0.1;
        }

        .category-card.active {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            box-shadow: 0 12px 35px rgba(33, 150, 243, 0.3);
            transform: translateY(-4px);
        }

        .category-card .material-icons {
            font-size: 2.5rem;
            margin-bottom: 0.8rem;
            transition: all 0.3s ease;
        }

        .category-card:hover .material-icons {
            transform: scale(1.1);
        }

        /* Modern Business Section */
        .business-section {
            margin: 2.5rem 0;
        }

        .business-section h3 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .business-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .business-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .business-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.05) 0%, rgba(25, 118, 210, 0.05) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1;
        }

        .business-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 18px 45px rgba(0, 0, 0, 0.15);
        }

        .business-card:hover::before {
            opacity: 1;
        }

        .business-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .business-card:hover .business-image {
            transform: scale(1.05);
        }

        .business-info {
            padding: 1.2rem;
            position: relative;
            z-index: 2;
        }

        .business-name {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 0.4rem;
            color: #333;
        }

        .business-type, .business-location {
            color: #666;
            font-size: 0.85rem;
            margin-bottom: 0.4rem;
            display: flex;
            align-items: center;
            font-weight: 500;
        }

        .business-type .material-icons, .business-location .material-icons {
            font-size: 16px;
            margin-right: 6px;
            color: #2196f3;
        }

        .business-rating {
            display: flex;
            align-items: center;
            margin-top: 0.8rem;
            padding: 0.4rem 0.8rem;
            background: rgba(33, 150, 243, 0.1);
            border-radius: 10px;
            width: fit-content;
        }

        .business-rating .material-icons {
            color: #ffc107;
            font-size: 16px;
            margin-right: 4px;
        }

        .rating-value {
            font-weight: 700;
            margin-right: 4px;
            color: #333;
            font-size: 0.9rem;
        }

        .review-count {
            color: #666;
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* Modern No Results */
        #noResults {
            text-align: center;
            margin-top: 2.5rem;
            color: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            font-weight: 500;
        }

        /* Chatbot Modal Styles */
        .chatbot-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .chatbot-modal-content {
            position: absolute;
            right: 20px;
            top: 20px;
            bottom: 20px;
            width: 400px;
            max-width: calc(100vw - 40px);
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .chatbot-header {
            background: linear-gradient(135deg, #2196f3, #1976d2);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chatbot-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .chatbot-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chatbot-model-info {
            padding: 5px 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .chatbot-close-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }

        .chatbot-close-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .chatbot-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chatbot-welcome {
            text-align: center;
            color: #64748b;
            padding: 20px;
            font-style: italic;
        }

        .chatbot-welcome .material-icons {
            font-size: 48px;
            color: #2196f3;
            margin-bottom: 15px;
            display: block;
        }

        .chatbot-message {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            max-width: 85%;
            animation: fadeInUp 0.3s ease;
        }

        .chatbot-message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .chatbot-message.bot {
            align-self: flex-start;
        }

        .chatbot-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .chatbot-message.user .chatbot-avatar {
            background: linear-gradient(135deg, #2196f3, #1976d2);
            color: white;
        }

        .chatbot-message.bot .chatbot-avatar {
            background: linear-gradient(135deg, #4caf50, #388e3c);
            color: white;
        }

        .chatbot-message-content {
            background: white;
            padding: 10px 14px;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            word-wrap: break-word;
            line-height: 1.4;
            font-size: 0.9rem;
        }

        .chatbot-message.user .chatbot-message-content {
            background: linear-gradient(135deg, #2196f3, #1976d2);
            color: white;
        }

        .chatbot-message.bot .chatbot-message-content {
            background: white;
            color: #333;
            border: 1px solid #e2e8f0;
        }

        .chatbot-message-time {
            font-size: 0.7rem;
            color: #64748b;
            margin-top: 5px;
            text-align: right;
        }

        .chatbot-message.bot .chatbot-message-time {
            text-align: left;
        }

        .chatbot-typing {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0 20px;
            margin-bottom: 10px;
        }

        .chatbot-typing-dots {
            background: white;
            padding: 10px 14px;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .chatbot-typing-dots span {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #2196f3;
            margin: 0 2px;
            animation: typing 1.4s infinite ease-in-out;
        }

        .chatbot-typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .chatbot-typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .chatbot-input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e2e8f0;
        }

        .chatbot-input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .chatbot-input {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            outline: none;
            font-size: 0.9rem;
            resize: none;
            font-family: inherit;
            min-height: 40px;
            max-height: 100px;
            line-height: 1.4;
        }

        .chatbot-input:focus {
            border-color: #2196f3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .chatbot-send-btn {
            background: linear-gradient(135deg, #2196f3, #1976d2);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            flex-shrink: 0;
        }

        .chatbot-send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }

        .chatbot-send-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 1rem;
            }

            .hero-title {
                font-size: 1.8rem;
            }

            .nav-bar {
                flex-direction: column;
                gap: 1rem;
                padding: 1.2rem;
            }

            .nav-center {
                width: 100%;
                order: 3;
            }

            .search-box {
                width: 100%;
                max-width: none;
                min-width: auto;
            }

            .location-filters {
                flex-direction: column;
                width: 100%;
                gap: 0.5rem;
            }

            .location-select {
                width: 100%;
            }

            .nav-left, .nav-right {
                width: 100%;
                justify-content: center;
            }

            .category-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 1rem;
            }

            .category-card {
                padding: 1.2rem 0.6rem;
            }

            .category-card .material-icons {
                font-size: 2.2rem;
            }

            .business-grid {
                grid-template-columns: 1fr;
                gap: 1.2rem;
            }

            .chatbot-modal-content {
                right: 10px;
                top: 10px;
                bottom: 10px;
                width: calc(100vw - 20px);
            }
        }

        @media (max-width: 480px) {
            .dashboard-container {
                padding: 0.5rem;
            }

            .hero-title {
                font-size: 1.8rem;
            }

            .hero-subtitle {
                font-size: 1rem;
            }

            .nav-bar {
                padding: 1rem;
            }

            .category-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 0.8rem;
            }

            .modal-content {
                width: 95%;
                max-width: none;
                margin: 0.5rem auto;
                max-height: 95vh;
            }
        }

        /* Profil menüsü için stil */
        .profile-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            display: none;
            min-width: 160px;
            z-index: 1000;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .profile-menu.active {
            display: block;
        }

        .profile-menu a {
            display: block;
            padding: 0.8rem 1.2rem;
            color: #333;
            text-decoration: none;
            font-weight: 500;
            transition: background 0.2s ease;
            font-size: 0.9rem;
        }

        .profile-menu a:hover {
            background: #f8f9fa;
        }

        .profile-menu .logout {
            border-top: 1px solid #eee;
            color: #dc3545;
        }

        .profile-menu .logout:hover {
            background: #fff5f5;
        }

        /* İşletme listesi */
        .business-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(270px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .business-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
        }
        
        .business-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .business-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        
        .business-info {
            padding: 15px;
        }
        
        .business-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .business-type, .business-location {
            color: #666;
            font-size: 14px;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
        }
        
        .business-type .material-icons, .business-location .material-icons {
            font-size: 16px;
            margin-right: 5px;
        }
        
        .business-rating {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        
        .business-rating .material-icons {
            color: #ffc107;
            font-size: 16px;
        }
        
        .rating-value {
            font-weight: 600;
            margin-right: 5px;
        }
        
        .review-count {
            color: #666;
            font-size: 12px;
        }
        
        /* Modal stilleri */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal-content {
            background-color: white;
            margin: 0;
            width: 50%;
            max-width: 600px;
            height: 100%;
            border-radius: 0;
            overflow-y: auto;
            box-shadow: 4px 0 20px rgba(0,0,0,0.2);
            position: relative;
            float: left;
            animation: slideInLeft 0.3s ease-out;
        }
        
        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
            }
            to {
                transform: translateX(0);
            }
        }
        
        .close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s ease;
        }
        
        .close-button:hover {
            background-color: rgba(0, 0, 0, 0.8);
            transform: scale(1.1);
        }
        
        .modal-header {
            position: relative;
        }
        
        .business-cover-photo {
            height: 250px;
            background-size: cover;
            background-position: center;
            position: relative;
            overflow: hidden;
        }
        
        .business-header-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 30px 25px;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            color: white;
        }
        
        .modal-business-name {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 10px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }
        
        .modal-business-type, .modal-business-location {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .modal-business-type .material-icons, .modal-business-location .material-icons {
            font-size: 18px;
            margin-right: 8px;
        }
        
        .modal-body {
            padding: 25px;
            height: calc(100% - 300px);
            overflow-y: auto;
        }
        
        .modal-tabs {
            display: flex;
            border-bottom: 1px solid #eee;
            margin-bottom: 25px;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-right: 15px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .tab:hover {
            color: #4285f4;
        }
        
        .tab.active {
            border-bottom: 2px solid #4285f4;
            color: #4285f4;
        }
        
        .tab-content {
            display: block;
        }
        
        .tab-content.hidden {
            display: none;
        }

        /* İşletme bilgileri için stil */
        .info-section {
            margin-bottom: 30px;
        }
        
        .info-section h3 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .info-item {
            margin-bottom: 12px;
            display: flex;
            align-items: flex-start;
        }
        
        .info-item .material-icons {
            margin-right: 10px;
            color: #666;
            font-size: 20px;
        }
        
        .info-item p {
            margin: 0;
            line-height: 1.5;
        }
        
        .info-item strong {
            display: inline-block;
            min-width: 120px;
            color: #555;
        }
        
        /* Randevu formu stilleri */
        .appointment-form {
            margin-top: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input[type="date"], .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .resources-section {
            margin-bottom: 20px;
        }
        
        .resources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .resource-item {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .resource-item.selected {
            background-color: #e8f0fe;
            border-color: #4285f4;
        }
        
        .resource-item .material-icons {
            font-size: 24px;
            margin-bottom: 5px;
            color: #666;
        }
        
        .time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .time-slot {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .time-slot.selected {
            background-color: #e8f0fe;
            border-color: #4285f4;
        }
        
        .time-slot.disabled {
            background-color: #f5f5f5;
            color: #999;
            cursor: not-allowed;
            border-color: #ddd;
            position: relative;
        }
        
        .time-slot.disabled::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #dc3545;
            transform: translateY(-50%);
        }
        
        .time-slot.disabled:hover {
            background-color: #f5f5f5;
            border-color: #ddd;
            transform: none;
        }
        
        .time-slot:not(.disabled):hover {
            background-color: #f0f8ff;
            border-color: #4285f4;
            transform: translateY(-1px);
        }
        
        .appointment-submit {
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 12px 20px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            width: 100%;
            margin-top: 20px;
        }
        
        .appointment-submit:hover {
            background-color: #3367d6;
        }
        
        /* Galeri grid stil */
        .gallery-section {
            margin-top: 30px;
        }
        
        .gallery-section h3 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .gallery-item {
            height: 120px;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .gallery-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .gallery-item:hover img {
            transform: scale(1.05);
        }

        /* İşletme bilgileri için hizmetler bölümü ekle */
        .services-section {
            margin-bottom: 30px;
        }

        .services-section h3 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .services-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .service-item {
            background-color: #f5f7fa;
            padding: 12px 16px;
            border-radius: 20px;
            font-size: 14px;
            color: #555;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid #e8ecf0;
            transition: all 0.2s ease;
        }

        .service-item:hover {
            background-color: #e8f0fe;
            border-color: #4285f4;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(66, 133, 244, 0.1);
        }

        .service-item .material-icons {
            font-size: 16px;
            color: #4285f4;
            flex-shrink: 0;
        }

        .service-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex-grow: 1;
        }

        .service-name {
            font-weight: 500;
            color: #333;
        }

        .service-price {
            font-size: 12px;
            color: #4285f4;
            font-weight: 600;
        }

        /* Hizmet kategori stilleri */
        .service-category-header {
            display: flex;
            align-items: center;
            margin: 20px 0 10px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .service-category-header:first-child {
            margin-top: 0;
        }
        
        .category-indicator {
            width: 4px;
            height: 20px;
            border-radius: 2px;
            margin-right: 12px;
        }
        
        .service-category-header h4 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        
        .service-duration {
            color: #666;
            font-size: 12px;
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }
        
        /* Placeholder resim stilleri */
        .placeholder-image {
            background-color: #f8f9fa;
            background-image: linear-gradient(45deg, #e9ecef 25%, transparent 25%, transparent 75%, #e9ecef 75%), 
                              linear-gradient(45deg, #e9ecef 25%, transparent 25%, transparent 75%, #e9ecef 75%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        
        .placeholder-image-business {
            width: 100%;
            height: 150px;
        }
        
        .placeholder-image-cover {
            width: 100%;
            height: 250px;
            font-size: 18px;
        }
        
        .placeholder-image-gallery {
            width: 100%;
            height: 100%;
            font-size: 12px;
        }
        
        /* Hizmet seçim alanı stilleri */
        .services-selection-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f9f9f9;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .selected-services-summary {
            background: #e8f4f8;
            border: 1px solid #4285f4;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
        }
        
        .summary-label {
            font-weight: 600;
            color: #333;
            display: block;
            margin-bottom: 8px;
        }
        
        .selected-services-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 8px;
        }
        
        .selected-service-tag {
            background: #4285f4;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .selected-service-tag .remove-service {
            cursor: pointer;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }
        
        .selected-service-tag .remove-service:hover {
            background: rgba(255,255,255,0.5);
        }
        
        .total-price {
            font-weight: 600;
            color: #4285f4;
            text-align: right;
        }
        
        .service-category-group {
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .service-category-group:last-child {
            margin-bottom: 0;
        }

        /* Bilgiler sekmesindeki hizmetler için stil */
        .services-info-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .service-info-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #4285f4;
            transition: all 0.3s ease;
        }

        .service-info-item:hover {
            background: #e3f2fd;
            transform: translateX(5px);
        }

        .service-info-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            font-size: 16px;
        }

        .service-info-price {
            color: #4285f4;
            font-weight: 500;
            font-size: 14px;
        }

        .service-info-description {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
            line-height: 1.4;
        }
        
        .service-category-title {
            background: linear-gradient(135deg, #f5f5f5, #e8e8e8);
            padding: 12px 15px;
            font-weight: 600;
            color: #333;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .service-category-title .category-color-indicator {
            width: 4px;
            height: 20px;
            border-radius: 2px;
        }
        
        .service-category-services {
            padding: 10px;
            background: white;
        }
        
        .service-checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            border-radius: 4px;
            margin-bottom: 6px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .service-checkbox-item:hover {
            background: #f0f8ff;
        }
        
        .service-checkbox-item.selected {
            background: #e8f4f8;
            border: 1px solid #4285f4;
        }
        
        .service-checkbox-item input[type="checkbox"] {
            margin-right: 10px;
            width: 16px;
            height: 16px;
            accent-color: #4285f4;
        }
        
        .service-info {
            flex: 1;
        }
        
        .service-name {
            font-weight: 500;
            color: #333;
            margin-bottom: 2px;
        }
        
        .service-details {
            font-size: 12px;
            color: #666;
            display: flex;
            gap: 10px;
        }
        
        .service-price {
            color: #4285f4;
            font-weight: 600;
        }
        
        .service-duration {
            color: #999;
        }
        
        .no-services-message {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 20px;
            margin: 0;
        }

        /* Modern Modal stilleri */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            z-index: 1000;
            overflow-y: auto;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            margin: 1.5rem auto;
            width: 90%;
            max-width: 850px;
            max-height: 90vh;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            position: relative;
            animation: slideInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        @keyframes slideInUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .close-button {
            position: absolute;
            top: 18px;
            right: 18px;
            font-size: 22px;
            color: white;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .close-button:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: scale(1.1);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .modal-header {
            position: relative;
            overflow: hidden;
        }
        
        .business-cover-photo {
            height: 280px;
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            background-size: cover;
            background-position: center;
            position: relative;
            overflow: hidden;
        }

        .business-cover-photo::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.3) 0%, rgba(25, 118, 210, 0.3) 100%);
        }
        
        .business-header-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1.5rem;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
            color: white;
        }
        
        .modal-business-name {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.6rem;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }
        
        .modal-business-type, .modal-business-location {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            opacity: 0.95;
        }
        
        .modal-business-type .material-icons, .modal-business-location .material-icons {
            font-size: 16px;
            margin-right: 6px;
        }

        .modal-business-rating {
            display: flex;
            align-items: center;
            margin-top: 0.3rem;
        }

        .modal-business-rating .material-icons {
            color: #ffc107;
            margin-right: 3px;
            font-size: 16px;
        }
        
        .modal-body {
            padding: 1.2rem;
            height: calc(90vh - 320px);
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.95);
        }
        
        .modal-tabs {
            display: flex;
            background: rgba(33, 150, 243, 0.1);
            border-radius: 12px;
            padding: 0.3rem;
            margin-bottom: 1.2rem;
            position: sticky;
            top: 0;
            z-index: 5;
            backdrop-filter: blur(10px);
        }
        
        .tab {
            flex: 1;
            padding: 0.7rem 1rem;
            cursor: pointer;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #2196f3;
            position: relative;
            font-size: 0.85rem;
        }
        
        .tab:hover {
            background: rgba(33, 150, 243, 0.1);
            transform: translateY(-2px);
        }
        
        .tab.active {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
            transform: translateY(-2px);
        }
        
        .tab-content {
            display: block;
            animation: fadeInContent 0.3s ease;
        }

        @keyframes fadeInContent {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tab-content.hidden {
            display: none;
        }

        /* Modern İşletme bilgileri için stil */
        .info-section {
            margin-bottom: 1.2rem;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid rgba(33, 150, 243, 0.1);
        }
        
        .info-section h3 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: #333;
            display: flex;
            align-items: center;
            font-weight: 700;
        }

        .info-section h3::before {
            content: '';
            width: 3px;
            height: 16px;
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            border-radius: 2px;
            margin-right: 8px;
        }
        
        .info-item {
            margin-bottom: 0.6rem;
            display: flex;
            align-items: flex-start;
            padding: 0.6rem;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .info-item:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateX(2px);
        }
        
        .info-item .material-icons {
            margin-right: 10px;
            color: #2196f3;
            font-size: 18px;
        }
        
        .info-item p {
            margin: 0;
            line-height: 1.4;
            font-weight: 500;
            font-size: 0.85rem;
        }
        
        .info-item strong {
            display: inline-block;
            min-width: 80px;
            color: #333;
            font-weight: 600;
        }
        
        /* Modern Randevu formu stilleri */
        .appointment-form {
            margin-top: 1.2rem;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 1.2rem;
            border: 1px solid rgba(33, 150, 243, 0.1);
        }
        
        .form-group {
            margin-bottom: 1.2rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.6rem;
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }
        
        .form-group input[type="date"], .form-group select {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 2px solid rgba(33, 150, 243, 0.2);
            border-radius: 10px;
            font-size: 0.9rem;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .form-group input[type="date"]:focus, .form-group select:focus {
            outline: none;
            border-color: #2196f3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
            transform: translateY(-1px);
        }

        /* Modern Resources Section */
        .resources-section {
            margin-bottom: 1.2rem;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 12px;
            padding: 1.2rem;
            border: 1px solid rgba(33, 150, 243, 0.1);
        }
        
        .resources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 0.8rem;
            margin-top: 0.8rem;
        }

        /* Modern Button Styles */
        .appointment-submit {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 1.2rem;
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .appointment-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 25px rgba(33, 150, 243, 0.4);
        }

        .appointment-submit:active {
            transform: translateY(-1px);
        }

        /* Modern Time Slots */
        .time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0.8rem;
            margin-top: 0.8rem;
        }
        
        .time-slot {
            border: 2px solid rgba(33, 150, 243, 0.2);
            border-radius: 10px;
            padding: 0.8rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
            font-weight: 500;
            position: relative;
            font-size: 0.85rem;
        }
        
        .time-slot:hover {
            border-color: #2196f3;
            background: rgba(33, 150, 243, 0.1);
            transform: translateY(-1px);
        }
        
        .time-slot.selected {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            border-color: #2196f3;
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.3);
            transform: translateY(-1px);
        }
        
        .time-slot.disabled {
            background: rgba(0, 0, 0, 0.05);
            color: #999;
            cursor: not-allowed;
            border-color: rgba(0, 0, 0, 0.1);
        }

        .time-slot.disabled::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 10%;
            right: 10%;
            height: 2px;
            background: #dc3545;
            transform: translateY(-50%) rotate(-5deg);
        }

        /* Modern Resource Items */
        .resource-item {
            border: 2px solid rgba(33, 150, 243, 0.2);
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
        }
        
        .resource-item:hover {
            border-color: #2196f3;
            background: rgba(33, 150, 243, 0.1);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(33, 150, 243, 0.2);
        }
        
        .resource-item.selected {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            border-color: #2196f3;
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(33, 150, 243, 0.3);
        }
        
        .resource-item .material-icons {
            font-size: 1.6rem;
            margin-bottom: 0.6rem;
            color: inherit;
        }

        /* Modern Services List - Collapsible Categories */
        .services-list {
            display: block;
            gap: 1rem;
        }

        .service-category-header {
            display: flex;
            align-items: center;
            margin: 20px 0 10px 0;
            padding: 12px 16px;
            background: rgba(33, 150, 243, 0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .service-category-header:hover {
            background: rgba(33, 150, 243, 0.15);
            border-color: rgba(33, 150, 243, 0.3);
        }
        
        .service-category-header:first-child {
            margin-top: 0;
        }
        
        .category-indicator {
            width: 4px;
            height: 20px;
            border-radius: 2px;
            margin-right: 12px;
        }
        
        .service-category-header h4 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            flex: 1;
        }
        
        .category-toggle-icon {
            color: #2196f3;
            transition: transform 0.3s ease;
            font-size: 20px;
        }
        
        .category-toggle-icon.expanded {
            transform: rotate(180deg);
        }
        
        .category-services {
            display: none;
            padding: 0 16px 16px 16px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 0 0 12px 12px;
            margin-top: -10px;
        }
        
        .category-services.expanded {
            display: block;
        }

        .service-item {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            padding: 1rem;
            border-radius: 12px;
            border: 2px solid rgba(33, 150, 243, 0.1);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            margin-bottom: 8px;
        }

        .service-item:hover {
            border-color: #2196f3;
            background: rgba(255, 255, 255, 1);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(33, 150, 243, 0.15);
        }

        .service-item .material-icons {
            font-size: 1.6rem;
            color: #2196f3;
            flex-shrink: 0;
        }

        .service-details {
            flex: 1;
        }

        .service-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.2rem;
            font-size: 1rem;
        }

        .service-price {
            color: #2196f3;
            font-weight: 700;
            font-size: 0.9rem;
        }
        
        .service-duration {
            color: #666;
            font-size: 12px;
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }

        /* Modern Gallery */
        .gallery-section {
            margin-top: 1.5rem;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 1.2rem;
            border: 1px solid rgba(33, 150, 243, 0.1);
        }
        
        .gallery-section h3 {
            font-size: 1.2rem;
            margin-bottom: 1.2rem;
            color: #333;
            display: flex;
            align-items: center;
            font-weight: 700;
        }

        .gallery-section h3::before {
            content: '';
            width: 3px;
            height: 18px;
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            border-radius: 2px;
            margin-right: 10px;
        }
        
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 0.8rem;
        }
        
        .gallery-item {
            height: 120px;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }
        
        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .gallery-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
        }
        
        .gallery-item:hover img {
            transform: scale(1.05);
        }

        /* Modern Service Categories */
        .service-category-group {
            margin-bottom: 1.2rem;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        }
        
        .service-category-title {
            padding: 0.8rem 1.2rem;
            background: rgba(33, 150, 243, 0.1);
            border-bottom: 1px solid rgba(33, 150, 243, 0.1);
            display: none; /* Başlangıçta gizli */
            align-items: center;
            gap: 0.8rem;
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }

        .service-category-title.visible {
            display: flex; /* Seçim olduğunda göster */
        }
        
        .service-category-title.has-selected {
            background: rgba(33, 150, 243, 0.2);
            border-left: 4px solid #2196f3;
        }
        
        .category-color-indicator {
            width: 3px;
            height: 16px;
            border-radius: 2px;
        }
        
        .category-count {
            margin-left: auto;
            font-size: 0.8rem;
            color: #666;
        }
        
        .category-toggle-icon {
            color: #2196f3;
            transition: transform 0.3s ease;
            font-size: 20px;
        }
        
        .category-toggle-icon.expanded {
            transform: rotate(180deg);
        }
        
        .service-category-services {
            display: none;
            padding: 0 16px 16px 16px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 0 0 12px 12px;
            margin-top: -10px;
        }
        
        .service-category-services.expanded {
            display: block;
        }
        
        /* Miktar Kontrolü için Yeni Stiller */
        .service-quantity-item {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 1rem;
            border-radius: 12px;
            border: 2px solid rgba(33, 150, 243, 0.1);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .service-quantity-item:hover {
            border-color: #2196f3;
            background: rgba(255, 255, 255, 1);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(33, 150, 243, 0.15);
        }

        .service-quantity-item.selected {
            border-color: #2196f3;
            background: rgba(33, 150, 243, 0.1);
            box-shadow: 0 8px 20px rgba(33, 150, 243, 0.2);
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quantity-btn {
            width: 32px;
            height: 32px;
            border: 2px solid #2196f3;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            color: #2196f3;
        }

        .quantity-btn:hover:not(:disabled) {
            background: #2196f3;
            color: white;
            transform: scale(1.1);
        }

        .quantity-btn:disabled {
            border-color: #ccc;
            color: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .quantity-btn .material-icons {
            font-size: 18px;
        }

        .quantity-input {
            width: 50px;
            height: 32px;
            text-align: center;
            border: 2px solid rgba(33, 150, 243, 0.3);
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            background: white;
        }

        .quantity-input:focus {
            outline: none;
            border-color: #2196f3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        /* Selected Services Summary */
        .selected-services-summary {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.1) 0%, rgba(25, 118, 210, 0.1) 100%);
            border-radius: 12px;
            padding: 1.2rem;
            margin: 1.2rem 0;
            border: 2px solid rgba(33, 150, 243, 0.2);
        }

        .selected-service-tag {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 16px;
            margin: 0.2rem;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .remove-service {
            margin-left: 0.4rem;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: background 0.2s ease;
            font-size: 0.7rem;
        }

        .remove-service:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* Services Selection Container */
        .services-selection-container {
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 1rem;
            background: #f9f9f9;
            max-height: 450px;
            overflow-y: auto;
        }

        .summary-label {
            font-weight: 600;
            color: #333;
            display: block;
            margin-bottom: 0.6rem;
            font-size: 0.9rem;
        }

        .total-price {
            font-weight: 600;
            color: #2196f3;
            text-align: right;
            font-size: 0.9rem;
        }

        /* Placeholder Images Modern Style */
        .placeholder-image {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-weight: 600;
            text-align: center;
            border: 2px dashed #dee2e6;
            border-radius: 12px;
        }
        
        .placeholder-image-business {
            width: 100%;
            height: 200px;
        }
        
        .placeholder-image-cover {
            width: 100%;
            height: 300px;
            font-size: 1.2rem;
        }
        
        .placeholder-image-gallery {
            width: 100%;
            height: 100%;
            font-size: 0.9rem;
        }

        /* Modern Notification Panel */
        .notification-panel {
            position: relative;
        }

        .notification-btn {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid rgba(33, 150, 243, 0.2);
            border-radius: 12px;
            padding: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            backdrop-filter: blur(20px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            z-index: 1500;
        }

        .notification-btn:hover {
            border-color: #2196f3;
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.2);
            transform: translateY(-2px);
        }

        .notification-btn .material-icons {
            font-size: 1.5rem;
            color: #2196f3;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .notification-dropdown {
            position: fixed;
            top: 80px;
            right: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            width: 350px;
            max-height: 400px;
            overflow: hidden;
            z-index: 9999;
            display: none;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .notification-dropdown.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .notification-header {
            padding: 1rem 1.2rem;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
        }

        .notification-header h3 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .mark-all-read {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0.3rem;
            border-radius: 6px;
            transition: background-color 0.3s ease;
        }

        .mark-all-read:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .notification-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 1rem 1.2rem;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.3s ease;
            position: relative;
        }

        .notification-item:hover {
            background: #f8f9fa;
        }

        .notification-item.unread {
            background: #f0f8ff;
            border-left: 4px solid #2196f3;
        }

        .notification-item.unread::before {
            content: '';
            position: absolute;
            top: 50%;
            right: 1rem;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            background: #2196f3;
            border-radius: 50%;
        }

        .notification-content {
            display: flex;
            align-items: flex-start;
            gap: 0.8rem;
        }

        .notification-icon {
            color: #2196f3;
            margin-top: 0.2rem;
        }

        .notification-text {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
        }

        .notification-message {
            color: #666;
            font-size: 0.8rem;
            line-height: 1.4;
            margin-bottom: 0.3rem;
        }

        .notification-time {
            color: #999;
            font-size: 0.7rem;
        }

        .no-notifications {
            padding: 2rem;
            text-align: center;
            color: #999;
        }

        .no-notifications .material-icons {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            opacity: 0.5;
        }

        .no-notifications p {
            margin: 0;
            font-size: 0.9rem;
        }

        /* Hero subtitle'ı tamamen gizle */
        .hero-subtitle {
            display: none !important;
        }



        /* Message Modal */
        .message-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .message-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .message-modal-header {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .message-modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .message-close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .message-close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .message-list {
            height: 400px;
            overflow-y: auto;
            padding: 1rem;
            background: #f8f9fa;
        }

        .message-item {
            margin-bottom: 1rem;
            display: flex;
            gap: 0.8rem;
        }

        .message-item.sent {
            flex-direction: row-reverse;
        }

        .message-bubble {
            max-width: 70%;
            padding: 0.8rem 1rem;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .message-item.received .message-bubble {
            background: white;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .message-item.sent .message-bubble {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 0.3rem;
        }

        .message-input-area {
            padding: 1rem;
            border-top: 1px solid #eee;
            background: white;
        }

        .message-input-container {
            display: flex;
            gap: 0.8rem;
            align-items: flex-end;
        }

        .message-input {
            flex: 1;
            padding: 0.8rem 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            resize: none;
            max-height: 100px;
            font-family: inherit;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .message-input:focus {
            outline: none;
            border-color: #2196f3;
        }

        .message-send-btn {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .message-send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- NAVIGASYON GÜÇLENDIRME SCRIPTI -->
        <script>
                // NAVİGASYON YENİDEN OLUŞTURMA SİSTEMİ
        function recreateNavigation() {
            // Mevcut navigasyonu kaldır
            const existingNav = document.querySelector('.nav-bar');
            if (existingNav) {
                existingNav.remove();
                console.log('🗑️ Eski navigasyon kaldırıldı');
            }
            
            // Yeni navigasyon oluştur
            const nav = document.createElement('nav');
            nav.className = 'nav-bar nav-forced-visible';
            nav.style.cssText = `
                display: flex !important;
                visibility: visible !important;
                opacity: 1 !important;
                position: sticky !important;
                top: 0 !important;
                z-index: 999999 !important;
                width: 100% !important;
                height: auto !important;
                pointer-events: auto !important;
                margin: 0 !important;
                padding: 0.8rem 1.5rem !important;
                background: rgba(255, 255, 255, 0.95) !important;
                backdrop-filter: blur(20px) !important;
                border-radius: 16px !important;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1) !important;
                border: 1px solid rgba(255, 255, 255, 0.2) !important;
                margin-bottom: 1.5rem !important;
                justify-content: space-between !important;
                align-items: center !important;
                overflow: visible !important;
            `;
            
            nav.innerHTML = `
                <div class="nav-left">
                    <a class="nav-btn" href="/profile.html">
                        <span class="material-icons">person</span>
                        Profil
                    </a>
                </div>
                <div class="nav-center">
                    <div class="search-box">
                        <span class="material-icons">search</span>
                        <input id="searchInput" type="text" placeholder="İşletme veya hizmet ara...">
                    </div>
                </div>
                <div class="nav-right">
                    <button class="nav-btn" onclick="openChatbot()" style="margin-right: 15px;">
                        <span class="material-icons">smart_toy</span>
                        AI Chatbot
                    </button>
                    <div class="notification-panel">
                        <button class="notification-btn" onclick="toggleNotifications()">
                            <span class="material-icons">notifications</span>
                            <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                        </button>
                        <div class="notification-dropdown" id="notificationDropdown">
                            <div class="notification-header">
                                <h3>Bildirimler</h3>
                                <button class="mark-all-read" onclick="markAllAsRead()">
                                    <span class="material-icons">done_all</span>
                                </button>
                            </div>
                            <div class="notification-list" id="notificationList">
                                <div class="no-notifications">
                                    <span class="material-icons">notifications_none</span>
                                    <p>Henüz bildirim yok</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Dashboard container'ın en başına ekle
            const dashboardContainer = document.querySelector('.dashboard-container');
            const firstChild = dashboardContainer.firstElementChild;
            dashboardContainer.insertBefore(nav, firstChild);
            
            // Search input event listener'ını yeniden ekle
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', filterAndDisplayBusinesses);
            }
            
            console.log('🆕 Yeni navigasyon oluşturuldu ve eklendi');
            return nav;
        }

        // Navigasyon varlığını kontrol et ve gerekirse yeniden oluştur
        function enforceNavVisibility() {
            const nav = document.querySelector('.nav-bar');
            if (!nav) {
                console.log('🚨 Navigasyon bulunamadı! Yeniden oluşturuluyor...');
                recreateNavigation();
                return;
            }
            
            const computedStyle = window.getComputedStyle(nav);
            if (computedStyle.display === 'none' || 
                computedStyle.visibility === 'hidden' || 
                parseFloat(computedStyle.opacity) < 0.1) {
                console.log('🚨 Navigasyon gizli! Yeniden oluşturuluyor...');
                recreateNavigation();
                return;
            }
            
            // Navigasyon varsa ama style'ı bozuksa düzelt
            nav.style.cssText = `
                display: flex !important;
                visibility: visible !important;
                opacity: 1 !important;
                position: sticky !important;
                top: 0 !important;
                z-index: 999999 !important;
                width: 100% !important;
                height: auto !important;
                pointer-events: auto !important;
                margin: 0 !important;
                padding: 0.8rem 1.5rem !important;
                background: rgba(255, 255, 255, 0.95) !important;
                backdrop-filter: blur(20px) !important;
                border-radius: 16px !important;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1) !important;
                border: 1px solid rgba(255, 255, 255, 0.2) !important;
                margin-bottom: 1.5rem !important;
                justify-content: space-between !important;
                align-items: center !important;
                overflow: visible !important;
            `;
            
            nav.classList.add('nav-forced-visible');
            
            console.log('✅ Navigasyon style düzeltildi');
        }
        
        // IIFE fonksiyonu hemen çalıştır
        (function() {
            // Her 50ms kontrol et - ULTRA agresif
            setInterval(enforceNavVisibility, 50);
            
            // DOM ready olduğunda hemen çalıştır
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', enforceNavVisibility);
            } else {
                enforceNavVisibility();
            }
            
            // Window load'da da çalıştır
            window.addEventListener('load', enforceNavVisibility);
            
            // Resize'da da çalıştır
            window.addEventListener('resize', enforceNavVisibility);
        })();
        </script>

        <!-- Hero Section -->

        <nav class="nav-bar" style="display: flex !important; visibility: visible !important; opacity: 1 !important; position: sticky !important; top: 0 !important; z-index: 999999 !important;">
            <div class="nav-left">
                <a class="nav-btn" href="/profile.html">
                    <span class="material-icons">person</span>
                    Profil
                </a>
            </div>
            <div class="nav-center">
                <div class="search-box">
                    <span class="material-icons">search</span>
                    <input id="searchInput" type="text" placeholder="İşletme veya hizmet ara...">
                </div>
            </div>
            <div class="nav-right">
                <button class="nav-btn" onclick="openChatbot()" style="margin-right: 15px;">
                    <span class="material-icons">smart_toy</span>
                    AI Chatbot
                </button>
                <div class="notification-panel">
                    <button class="notification-btn" onclick="toggleNotifications()">
                        <span class="material-icons">notifications</span>
                        <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                    </button>
                    <div class="notification-dropdown" id="notificationDropdown">
                        <div class="notification-header">
                            <h3>Bildirimler</h3>
                            <button class="mark-all-read" onclick="markAllAsRead()">
                                <span class="material-icons">done_all</span>
                            </button>
                        </div>
                        <div class="notification-list" id="notificationList">
                            <div class="no-notifications">
                                <span class="material-icons">notifications_none</span>
                                <p>Henüz bildirim yok</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
        
        <!-- Kategori Kartları Başlangıç -->
        <div class="category-section">
            <div class="category-title">İşletme Türü Seçin</div>
            <div class="category-grid" id="categoryGrid">
                <div class="category-card active" data-type="all">
                    <span class="material-icons">apps</span>
                    Tümü
                </div>
                <div class="category-card" data-type="dis hekimi">
                    <span class="material-icons">medication</span>
                    Diş Hekimi
                </div>
                <div class="category-card" data-type="kuafor">
                    <span class="material-icons">content_cut</span>
                    Kuaför
                </div>
                <div class="category-card" data-type="guzellik salonu">
                    <span class="material-icons">face</span>
                    Güzellik Salonu
                </div>
                <div class="category-card" data-type="spa salonu">
                    <span class="material-icons">spa</span>
                    Spa Salonu
                </div>
                <div class="category-card" data-type="halısaha">
                    <span class="material-icons">sports_soccer</span>
                    Halısaha
                </div>
                <div class="category-card" data-type="restoran">
                    <span class="material-icons">restaurant</span>
                    Restoran
                </div>
                <div class="category-card" data-type="cafe">
                    <span class="material-icons">local_cafe</span>
                    Cafe
                </div>
            </div>
        </div>
        <!-- Kategori Kartları Bitiş -->
        
        <!-- Sadakat Puanı Progress Bar -->
        <div class="loyalty-progress-container">
            <div class="loyalty-header">
                <h4>Sadakat Puanlarınız</h4>
                <div class="loyalty-points-display">
                    <span id="currentPoints">0</span> / <span id="nextMilestone">40</span>
                </div>
            </div>
            <button class="loyalty-info-btn" onclick="openLoyaltyInfoModal()" title="Sadakat Puanı Bilgileri">
                i
            </button>
            <div class="progress-bar-wrapper">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                    <div class="progress-checkpoints">
                        <div class="checkpoint active" data-points="0">
                            <div class="checkpoint-circle">
                                <span class="material-icons">check</span>
                            </div>
                            <span class="checkpoint-amount">0 Puan</span>
                        </div>
                        <div class="checkpoint" data-points="10">
                            <div class="checkpoint-circle">10</div>
                            <span class="checkpoint-amount">10 Puan</span>
                        </div>
                        <div class="checkpoint" data-points="20">
                            <div class="checkpoint-circle">20</div>
                            <span class="checkpoint-amount">20 Puan</span>
                        </div>
                        <div class="checkpoint" data-points="30">
                            <div class="checkpoint-circle">30</div>
                            <span class="checkpoint-amount">30 Puan</span>
                        </div>
                        <div class="checkpoint" data-points="40">
                            <div class="checkpoint-circle">40</div>
                            <span class="checkpoint-amount">40 Puan<br>💰 100₺ İndirim</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="loyalty-info">
                <p>Her 100 TL ve üzeri harcamanızda 10 puan kazanırsınız!</p>
                <div class="discount-info">
                    <p><strong>40 puana ulaştığınızda 100 TL indirim hakkı kazanırsınız!</strong></p>
                    <button id="useDiscountBtn" class="use-discount-btn" style="display: none;">
                        100 TL İndirim Hakkımı Kullan
                    </button>
                </div>
            </div>
        </div>

        <!-- İşletmeler Grid Başlangıç -->
        <div class="business-section">
            <h3>İşletmeler</h3>
            <div id="businessList" class="business-grid">
                <!-- JS ile işletme kartları buraya gelecek -->
            </div>
            <div id="noResults" style="display:none; text-align:center; margin-top:30px; color:#888;">
                Sonuç bulunamadı.
            </div>
        </div>
        
        <!-- Sonuç bulunamadı mesajı -->
        <div id="noResults" style="display: none; text-align: center; margin-top: 30px;">
            <p>Arama kriterlerinize uygun işletme bulunamadı.</p>
        </div>
    </div>

    <!-- Mesajlaşma Modal -->
    <div id="messageModal" class="message-modal">
        <div class="message-modal-content">
            <div class="message-modal-header">
                <div class="message-modal-title" id="messageModalTitle">
                    Mesajlar
                </div>
                <button class="message-close-btn" onclick="closeMessageModal()">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="message-list" id="messageList">
                <!-- Mesajlar buraya gelecek -->
            </div>
            <div class="message-input-area">
                <div class="message-input-container">
                    <textarea 
                        id="messageInput" 
                        class="message-input" 
                        placeholder="Mesajınızı yazın..."
                        rows="1"></textarea>
                    <button class="message-send-btn" onclick="sendMessage()">
                        <span class="material-icons">send</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Chatbot Modal -->
    <div id="chatbotModal" class="chatbot-modal">
        <div class="chatbot-modal-content">
            <div class="chatbot-header">
                <div class="chatbot-title">
                    <span class="material-icons">smart_toy</span>
                    AI Asistanınız
                </div>
                <div class="chatbot-controls">
                    <span class="chatbot-model-info">Llama 3.1 8B</span>
                    <button class="chatbot-close-btn" onclick="closeChatbot()">
                        <span class="material-icons">close</span>
                    </button>
                </div>
            </div>
            
            <div class="chatbot-messages" id="chatbotMessages">
                <div class="chatbot-welcome">
                    <span class="material-icons">smart_toy</span>
                    <p>Merhaba! Ben AI asistanınızım. Size nasıl yardımcı olabilirim?</p>
                </div>
            </div>
            
            <div class="chatbot-typing" id="chatbotTyping" style="display: none;">
                <div class="chatbot-avatar">🤖</div>
                <div class="chatbot-typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
            
            <div class="chatbot-input-area">
                <div class="chatbot-input-container">
                    <textarea 
                        id="chatbotInput" 
                        class="chatbot-input" 
                        placeholder="Mesajınızı yazın..." 
                        rows="1"
                        maxlength="2000"
                    ></textarea>
                    <button id="chatbotSendBtn" class="chatbot-send-btn" onclick="sendChatbotMessage()">
                        <span class="material-icons">send</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sadakat Puanı Bilgi Modal -->
    <div id="loyaltyInfoModal" class="loyalty-info-modal">
        <div class="loyalty-info-modal-content">
            <div class="loyalty-info-modal-header">
                <h3>💎 Sadakat Puanı Sistemi</h3>
                <button class="loyalty-info-close" onclick="closeLoyaltyInfoModal()">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="loyalty-info-modal-body">
                <div class="loyalty-rule">
                    <div class="loyalty-rule-icon">💰</div>
                    <div class="loyalty-rule-content">
                        <div class="loyalty-rule-title">Puan Kazanma</div>
                        <p class="loyalty-rule-desc">100 TL ve üzeri aldığınız her hizmet karşılığında 10 puan kazanırsınız</p>
                    </div>
                </div>
                
                <div class="loyalty-rule">
                    <div class="loyalty-rule-icon">🎁</div>
                    <div class="loyalty-rule-content">
                        <div class="loyalty-rule-title">İndirim Kazanma</div>
                        <p class="loyalty-rule-desc">Toplam 40 puana eriştiğiniz zaman 100 TL'lik indirim kuponu kazanırsınız</p>
                    </div>
                </div>
                
                <div class="loyalty-rule">
                    <div class="loyalty-rule-icon">⚠️</div>
                    <div class="loyalty-rule-content">
                        <div class="loyalty-rule-title">Minimum Tutar</div>
                        <p class="loyalty-rule-desc">İndirimi uygulayabilmek için en az 180 TL'lik hizmet seçmelisiniz</p>
                    </div>
                </div>
                
                <div class="loyalty-rule">
                    <div class="loyalty-rule-icon">📅</div>
                    <div class="loyalty-rule-content">
                        <div class="loyalty-rule-title">Kupon Geçerlilik</div>
                        <p class="loyalty-rule-desc">İndirim kuponlarınız 1 ay boyunca geçerlidir ve sadece bir kez kullanılabilir</p>
                    </div>
                </div>
                
                <div class="loyalty-rule">
                    <div class="loyalty-rule-icon">🔄</div>
                    <div class="loyalty-rule-content">
                        <div class="loyalty-rule-title">Puan Biriktirme</div>
                        <p class="loyalty-rule-desc">Her 40 puan tamamladığınızda yeni bir kupon kazanırsınız, kuponunuzu kullandıktan sonra puanlarınız sıfırlanır ve tekrardan indirim kuponunu kazanmak için puan toplayabilirsiniz</p>
                    </div>
                </div>
                
                <div class="loyalty-benefits">
                    <div class="loyalty-benefits-title">🌟 Özel Avantajlar</div>
                    <p class="loyalty-benefits-desc">
                        Sadık müşterilerimiz için özel kampanyalar, erken erişim fırsatları ve 
                        doğum günü sürprizleri sizi bekliyor!
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- İşletme Detay Modal -->
    <div id="businessDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            
            <div class="modal-header">
                <div class="business-cover-photo" id="modalBusinessCover">
                    <img id="modalBusinessImage" src="" alt="İşletme Fotoğrafı" style="width: 100%; height: 100%; object-fit: cover;">
                    <div class="business-header-info">
                        <h2 id="modalBusinessName" class="modal-business-name"></h2>
                        <div class="modal-business-type">
                            <span class="material-icons">store</span>
                            <span id="modalBusinessType"></span>
                        </div>
                        <div class="modal-business-location">
                            <span class="material-icons">location_on</span>
                            <span id="modalBusinessAddress"></span>
                        </div>
                        <div class="modal-business-rating">
                            <span class="material-icons">star</span>
                            <span id="modalBusinessRating"></span>
                            <span id="modalBusinessReviewCount"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-body">
                <div class="modal-tabs">
                    <div class="tab active" data-tab="info">Bilgiler</div>
                    <div class="tab" data-tab="appointment">Randevu Al</div>
                    <div class="tab" data-tab="reviews">Değerlendirmeler</div>
                </div>
                
                <div id="infoTab" class="tab-content">
                    <div class="info-section">
                        <h3>İşletme Hakkında</h3>
                        <div class="info-item">
                            <span class="material-icons">description</span>
                            <p id="businessDescription">İşletme açıklaması yükleniyor...</p>
                        </div>
                        <div class="info-item">
                            <span class="material-icons">payment</span>
                            <p><strong>Rezervasyon Ücreti:</strong> <span id="reservationPrice">Yükleniyor...</span></p>
                        </div>
                    </div>
                    
                    <div class="info-section">
                        <h3>İletişim Bilgileri</h3>
                        <div class="info-item">
                            <span class="material-icons">location_on</span>
                            <p><strong>Adres:</strong> <span id="businessAddress">Yükleniyor...</span></p>
                        </div>
                        <div class="info-item">
                            <span class="material-icons">phone</span>
                            <p><strong>Telefon:</strong> <span id="businessPhone">Yükleniyor...</span></p>
                        </div>
                        <div class="info-item">
                            <span class="material-icons">email</span>
                            <p><strong>E-posta:</strong> <span id="businessEmail">Yükleniyor...</span></p>
                        </div>
                    </div>
                    
                    <div class="info-section">
                        <h3>Sunulan Hizmetler</h3>
                        <div id="businessServices" class="services-info-list">
                            <!-- Hizmetler buraya eklenecek -->
                            <p>Hizmet bilgisi yükleniyor...</p>
                        </div>
                    </div>
                    
                    <div class="gallery-section">
                        <h3>Galeri</h3>
                        <div id="businessGallery" class="gallery-grid">
                            <!-- Galeri resimleri buraya eklenecek -->
                        </div>
                    </div>
                </div>
                
                <div class="tab-content hidden" id="appointmentTab">
                    <h3>Randevu Al</h3>
                    <form id="appointmentForm" class="appointment-form">
                        <input type="hidden" name="businessId" id="appointmentBusinessId">
                        
                        <div class="form-group">
                            <label for="appointmentService">Seçilen Hizmetler</label>
                            <div class="services-selection-container">
                                <div class="selected-services-summary" id="selectedServicesSummary">
                                    <span class="summary-label">Standart Randevu:</span>
                                    <div class="selected-services-list" id="selectedServicesList">
                                        <div class="selected-service-item default-service">
                                            <span class="service-name">Standart Randevu</span>
                                            <span class="service-price" id="defaultServicePrice">0 TL</span>
                                        </div>
                                    </div>
                                    <div class="total-price" id="totalPrice">Toplam: 0 TL</div>
                                </div>
                                
                                <div style="margin-top: 15px;">
                                    <h4 style="margin-bottom: 10px; color: #333; font-size: 1rem;">Ek Hizmetler (Opsiyonel)</h4>
                                    <div class="services-categories" id="servicesCategories">
                                        <p class="no-services-message">Hizmetler yükleniyor...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="appointmentDate">Tarih Seçin</label>
                            <input type="date" id="appointmentDate" name="appointmentDate" required>
                        </div>
                        
                        <div class="resources-section">
                            <h4 id="resourcesLabel">Kaynak Seçin</h4>
                            <p id="noResourcesMessage" style="display: none;">Bu işletme için kaynak bulunmamaktadır.</p>
                            <div id="resourcesList" class="resources-grid">
                                <!-- Kaynaklar buraya eklenecek -->
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Saat Seçin</label>
                            <div id="timeSlots" class="time-slots">
                                <!-- Müsait saatler buraya eklenecek -->
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="appointmentNote">Not (Opsiyonel)</label>
                            <textarea id="appointmentNote" name="appointmentNote" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div class="form-group" id="couponSection" style="margin-top: 15px;">
                            <label for="appointmentCoupon" style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">
                                💰 İndirim Kuponu
                            </label>
                            <select id="appointmentCoupon" name="appointmentCoupon" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background-color: white;">
                                <option value="">İndirim kuponu seçin (opsiyonel)</option>
                            </select>
                            <div id="couponInfo" style="margin-top: 5px; font-size: 0.9rem; color: #666;"></div>
                            <div id="noCouponMessage" style="margin-top: 5px; font-size: 0.85rem; color: #999; font-style: italic; display: none;">
                                Henüz kullanılabilir kuponunuz bulunmuyor. Randevularınızı tamamlayarak sadakat puanı kazanın ve indirim kuponları elde edin! 🎁
                            </div>
                        </div>
                        
                        <div class="total-price-display" id="totalPriceDisplay" style="text-align: center; margin-bottom: 15px; font-size: 1.2rem; font-weight: bold; color: #4285f4;">
                            Toplam Ücret: <span id="finalTotalPrice">0 TL</span>
                            <div id="discountInfo" style="font-size: 0.9rem; color: #4CAF50; margin-top: 5px; display: none;"></div>
                        </div>
                        
                        <button type="submit" class="appointment-submit">Randevu Oluştur</button>
                    </form>
                </div>
                
                <div class="tab-content hidden" id="reviewsTab">
                    <div class="reviews-section">
                        <h3>Değerlendirmeler</h3>
                        <div id="reviewsList" class="reviews-list">
                            <!-- Değerlendirmeler buraya eklenecek -->
                        </div>
                        

                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Profil menüsünü aç/kapat fonksiyonu
        function toggleProfileMenu(event) {
            event.stopPropagation();
            const menu = document.getElementById('profileMenu');
            menu.classList.toggle('active');
        }
        // Sayfa dışına tıklayınca menüyü kapat
        document.addEventListener('click', (event) => {
            const menu = document.getElementById('profileMenu');
            if (menu && !menu.contains(event.target) && menu.classList.contains('active')) {
                menu.classList.remove('active');
            }
            
            // Bildirim panelini de kapat
            const notificationDropdown = document.getElementById('notificationDropdown');
            const notificationBtn = document.querySelector('.notification-btn');
            if (notificationDropdown && !notificationDropdown.contains(event.target) && 
                !notificationBtn.contains(event.target) && notificationDropdown.classList.contains('active')) {
                notificationDropdown.classList.remove('active');
            }
        });

        // Global değişkenler
        let allBusinesses = [];
        let selectedCategory = 'all'; // Varsayılan olarak 'all' kategorisi seçili
        
        // Kategori seçimi için event listener'ları ayarla
        function setupCategoryListeners() {
            document.querySelectorAll('.category-card').forEach(card => {
                card.addEventListener('click', function() {
                    const categoryType = this.getAttribute('data-type');
                    console.log('Kategori seçildi:', categoryType);
                    
                    // Aktif sınıfını diğer kategorilerden kaldır
                    document.querySelectorAll('.category-card').forEach(c => c.classList.remove('active'));
                    
                    // Seçilen kategoriye aktif sınıfını ekle
                    this.classList.add('active');
                    
                    // Global değişkeni güncelle
                    selectedCategory = categoryType;
                    
                    // İşletmeleri filtrele
                    filterAndDisplayBusinesses();
                });
            });
        }

        // Sayfa yüklendiğinde çalışacak ana fonksiyon
        async function init() {
            try {
                // URL'den parametreleri alıp kontrol et
                const urlParams = new URLSearchParams(window.location.search);
                const businessIdParam = urlParams.get('businessId');
                
                // Eğer URL'de businessId parametresi varsa, doğrudan o işletmenin modalını aç
                if (businessIdParam) {
                    console.log('URL\'de businessId bulundu:', businessIdParam);
                    // Parametrelerle direkt randevu oluşturma sayfasındayız, 
                    // burada normal dashboard akışını atla
                    try {
                        // İşletme bilgilerini getir
                        const response = await fetch(`/api/businesses/${businessIdParam}`);
                        if (!response.ok) {
                            throw new Error('İşletme bilgileri getirilemedi');
                        }
                        
                        const data = await response.json();
                        if (data && data.business) {
                            console.log('İşletme bilgileri alındı:', data.business);
                            openBusinessModal(data.business);
                            
                            // Diğer parametreleri doldur
                            const appointmentDate = urlParams.get('appointmentDate');
                            if (appointmentDate) {
                                const dateInput = document.getElementById('appointmentDate');
                                if (dateInput) dateInput.value = appointmentDate;
                            }
                            
                            const appointmentNote = urlParams.get('appointmentNote');
                            if (appointmentNote) {
                                const noteInput = document.getElementById('appointmentNote');
                                if (noteInput) noteInput.value = appointmentNote;
                            }
                            
                            // Randevu sekmesini göster
                            showTab('appointment');
                        }
                    } catch (err) {
                        console.error('URL parametre işleme hatası:', err);
                    }
                    
                    return; // Normal dashboard akışına devam etme
                }
                
                // Token kontrolü
                const token = localStorage.getItem('token');
                console.log('Token kontrolü: ', token ? 'Token var' : 'Token yok');
                
                if (!token) {
                    showError('Oturum açık değil. Lütfen giriş yapın.', 'Oturum Hatası');
                    window.location.href = '/login.html';
                    return;
                }
                
                // Token'ı decode et ve içeriğini göster (sadece debug için)
                try {
                    const tokenParts = token.split('.');
                    if (tokenParts.length === 3) {
                        const payload = JSON.parse(atob(tokenParts[1]));
                        console.log('Token içeriği:', payload);
                        console.log('Token süresi:', new Date(payload.exp * 1000));
                        console.log('Şu anki zaman:', new Date());
                        
                        // Token süresi dolmuş mu kontrol et
                        if (payload.exp * 1000 < Date.now()) {
                            console.log('Token süresi dolmuş!');
                            showError('Oturum süreniz dolmuş. Lütfen tekrar giriş yapın.', 'Oturum Süresi Doldu');
                            localStorage.removeItem('token');
                            localStorage.removeItem('user');
                            window.location.href = '/login.html';
                            return;
                        }
                    }
                } catch (e) {
                    console.error('Token decode hatası:', e);
                }
                
                // Kategori seçimi için dinleyicileri ayarla
                setupCategoryListeners();
                
                await loadBusinesses();
                setupFilterListeners();
                setupModalListeners();
                setupAppointmentForm();
            } catch (error) {
                console.error('Başlatma hatası:', error);
            }
        }
        
        // Sayfa yüklendiğinde init fonksiyonunu çağır
        document.addEventListener('DOMContentLoaded', init);

        // İşletmeleri yükle
        async function loadBusinesses() {
            try {
                const response = await fetch('/api/businesses');
                const data = await response.json();
                allBusinesses = data.businesses || [];
                console.log('API işletme verisi:', allBusinesses);
                
                // API yanıtında her işletme kaydı için business_type ve services alanını console'a yazdır
                allBusinesses.forEach((b, index) => {
                    console.log(`İşletme ${index + 1}: ${b.business_name}`);
                    console.log(`  - Tür: ${b.business_type}`);
                    console.log(`  - Services verisi:`, b.services);
                    console.log(`  - Services veri tipi:`, typeof b.services);
                    if (b.services) {
                        console.log(`  - Services string değeri:`, String(b.services));
                        console.log(`  - Services uzunluğu:`, b.services.length || 'N/A');
                    }
                    console.log('---');
                });
                
                filterAndDisplayBusinesses();
                
                // İşletmeler yüklendikten sonra navigasyon koruma
                setTimeout(() => {
                    if (typeof enforceNavVisibility === 'function') {
                        enforceNavVisibility();
                        console.log('🔧 İşletme verisi yüklendikten sonra navigasyon koruması çalıştırıldı');
                    }
                }, 100);
            } catch (error) {
                console.error('İşletmeler yüklenemedi:', error);
            }
        }

        // Kategori eşleştirme tablosu
        const categoryMap = {
            'dis hekimi': ['dis hekimi', 'diş hekimi', 'dishekim', 'dişhekim', 'dişhekimi', 'dis_hekimi', 'diş_hekimi'],
            'kuafor': ['kuafor', 'kuaför', 'coiffeur', 'berber'],
            'guzellik salonu': ['guzellik salonu', 'güzellik salonu', 'guzelliksalonu', 'güzelliksalonu', 'guzellik_salonu', 'güzellik_salonu'],
            'spa salonu': ['spa salonu', 'spasalonu', 'spa', 'spa_salonu'],
            'halısaha': ['halısaha', 'halı saha', 'halisaha', 'futbol', 'saha', 'hali_saha', 'halı_saha'],
            'restoran': ['restoran', 'restaurant'],
            'cafe': ['cafe', 'kafe'],
            'all': ['all']
        };

        // Filtreleme fonksiyonu
        function filterAndDisplayBusinesses() {
            let filtered = allBusinesses;
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            
            if (selectedCategory !== 'all') {
                filtered = filtered.filter(b => {
                    const type = (b.business_type || '').toLowerCase().trim();
                    console.log(`Filtreleme - İşletme: ${b.business_name}, Tür: ${type}, Seçilen kategori: ${selectedCategory}`);
                    const validTypes = categoryMap[selectedCategory] || [];
                    return validTypes.includes(type);
                });
            }
            
            if (searchText) {
                filtered = filtered.filter(b =>
                    b.business_name.toLowerCase().includes(searchText) ||
                    (b.city && b.city.toLowerCase().includes(searchText)) ||
                    (b.district && b.district.toLowerCase().includes(searchText))
                );
            }
            
            displayBusinesses(filtered);
        }

        // Arama kutusu ile filtreleme
        document.getElementById('searchInput').addEventListener('input', filterAndDisplayBusinesses);

        // İşletmeleri ekrana yaz
        function displayBusinesses(businesses) {
            const businessList = document.getElementById('businessList');
            const noResults = document.getElementById('noResults');
            businessList.innerHTML = '';
            if (!businesses.length) {
                noResults.style.display = 'block';
                // Navigasyon koruma çağrısı
                setTimeout(() => {
                    enforceNavVisibility();
                }, 50);
                return;
            }
            noResults.style.display = 'none';
            businesses.forEach(business => {
                const card = document.createElement('div');
                card.className = 'business-card';
                card.onclick = () => openBusinessModal(business);

                // İşletme resmi için hata kontrolü ekleyelim
                let imageElement = '';
                if (business.image_url) {
                    imageElement = `<img class="business-image" src="${business.image_url}" alt="${business.business_name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                    <div class="placeholder-image placeholder-image-business" style="display: none;">
                        <span>İşletme Resmi</span>
                    </div>`;
                } else {
                    imageElement = `<div class="placeholder-image placeholder-image-business">
                        <span>İşletme Resmi</span>
                    </div>`;
                }
                
                card.innerHTML = `
                    ${imageElement}
                    <div class="business-info">
                        <div class="business-name">${business.business_name}</div>
                        <div class="business-type"><span class="material-icons">category</span> ${business.business_type || ''}</div>
                        <div class="business-location"><span class="material-icons">location_on</span> ${business.city || ''} ${business.district || ''}</div>
                    </div>
                `;
                businessList.appendChild(card);
            });
            
            // DOM manipülasyonu tamamlandıktan sonra navigasyon koruma
            setTimeout(() => {
                if (typeof enforceNavVisibility === 'function') {
                    enforceNavVisibility();
                    console.log('🔧 İşletmeler yüklendikten sonra navigasyon koruması aktif edildi');
                }
            }, 50);
        }

        // İşletme türünü formatla
        function formatBusinessType(type) {
            const types = {
                'kuafor': 'Kuaför',
                'berber': 'Berber',
                'klinik': 'Klinik',
                'restoran': 'Restoran',
                'spor': 'Spor Salonu',
                'diger': 'Diğer'
            };
            
            return types[type] || type;
        }
        
        // İşletme modalını açma fonksiyonu
        function openBusinessModal(business) {
            // İşletme bilgilerini gösterme fonksiyonunu güncelle
            showBusinessDetails(business.id);
        }
        
        // İşletme bilgilerini gösterme fonksiyonunu güncelle
        function showBusinessDetails(businessId) {
            // İşletmeyi bul
            const business = allBusinesses.find(b => b.id === businessId);
            
            if (!business) {
                console.error('İşletme bulunamadı, ID:', businessId);
                return;
            }
            
            console.log('İşletme detayları gösteriliyor:', business);
            
            // Business verisini global değişkene kaydet
            window.currentBusinessData = business;
            
            // Modal içeriğini doldur
            document.getElementById('modalBusinessName').textContent = business.business_name || 'İsimsiz İşletme';
            document.getElementById('modalBusinessType').textContent = formatBusinessType(business.business_type) || 'Belirtilmemiş';
            document.getElementById('modalBusinessAddress').textContent = `${business.district || ''}, ${business.city || ''}`;
            
            // Kapak fotoğrafı
            const coverPhoto = document.querySelector('.business-cover-photo');
            if (business.cover_image) {
                coverPhoto.style.backgroundImage = `url(${business.cover_image})`;
                coverPhoto.style.backgroundSize = 'cover';
                coverPhoto.style.backgroundPosition = 'center';
            } else {
                // Placeholder arka plan
                coverPhoto.style.backgroundImage = 'none';
                coverPhoto.style.background = 'linear-gradient(45deg, #f8f9fa 25%, transparent 25%, transparent 75%, #f8f9fa 75%), linear-gradient(45deg, #f8f9fa 25%, transparent 25%, transparent 75%, #f8f9fa 75%)';
                coverPhoto.style.backgroundSize = '20px 20px';
                coverPhoto.style.backgroundPosition = '0 0, 10px 10px';
                coverPhoto.style.backgroundColor = '#e9ecef';
                
                // Placeholder metin ekle
                if (!coverPhoto.querySelector('.placeholder-text')) {
                    const placeholderText = document.createElement('div');
                    placeholderText.className = 'placeholder-text';
                    placeholderText.style.cssText = `
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        color: #6c757d;
                        font-size: 18px;
                        font-weight: 500;
                        text-align: center;
                        z-index: 1;
                    `;
                    placeholderText.textContent = 'Kapak Fotoğrafı';
                    coverPhoto.appendChild(placeholderText);
                }
            }
            
            // İşletme bilgilerini doldur
            document.getElementById('businessDescription').textContent = business.description || 'İşletme açıklaması bulunmuyor.';
            document.getElementById('reservationPrice').textContent = business.reservation_price ? `${business.reservation_price} TL` : 'Belirtilmemiş';
            document.getElementById('businessAddress').textContent = business.address || 'Adres belirtilmemiş';
            document.getElementById('businessPhone').textContent = business.business_phone || 'Telefon belirtilmemiş';
            document.getElementById('businessEmail').textContent = business.email || 'E-posta belirtilmemiş';
            
            // Standart randevu ücretini ayarla (rezervasyon ücreti ile eşit)
            const reservationPrice = business.reservation_price || 0;
            document.getElementById('defaultServicePrice').textContent = `${reservationPrice} TL`;
                            document.getElementById('totalPrice').textContent = `Toplam: ${parseFloat(reservationPrice).toFixed(2)} TL`;
                            document.getElementById('finalTotalPrice').textContent = `${parseFloat(reservationPrice).toFixed(2)} TL`;
            
            // Global değişkeni güncelle (standart randevu için)
            window.currentBusinessReservationPrice = reservationPrice;
            
            // Bilgiler sekmesindeki hizmetleri sadece bilgi amaçlı göster
            loadBusinessServicesInfo(business);
            
            // Galeri resimlerini yükle
            loadBusinessGallery(business);
            
            // Randevu formu için işletme ID'sini ayarla
            document.getElementById('appointmentBusinessId').value = business.id;
            
            // Hizmetleri kategorili seçim olarak yükle (sadece randevu al sekmesinde)
            // loadBusinessServicesForSelection(business); // Bilgiler sekmesinde seçim yapılmamalı
            
            // Kaynakları yükle
            loadBusinessResources(business.id);
            
            // Kapatma butonlarını ayarla
            const closeButton = document.querySelector('.close-button');
            if (closeButton) {
                closeButton.onclick = function() {
                    document.getElementById('businessDetailModal').style.display = 'none';
                };
            }
            
            // Sekme event listener'larını tekrar ekle
            document.querySelectorAll('.modal-tabs .tab').forEach(tab => {
                tab.onclick = function() {
                    showTab(this.getAttribute('data-tab'));
                };
            });
            
            // Varsayılan olarak 'Bilgiler' sekmesini göster
            showTab('info');
            
            // Kuponları yükle
            loadUserCoupons();
            
            // Modalı göster
            document.getElementById('businessDetailModal').style.display = 'block';
        }
        
        // İşletme galeri resimlerini yükleme
        function loadBusinessGallery(business) {
            const galleryContainer = document.getElementById('businessGallery');
            galleryContainer.innerHTML = '';
            
            console.log('=== GALERİ DEBUG ===');
            console.log('Business objesi:', business);
            console.log('gallery_images değeri:', business.gallery_images);
            console.log('gallery_images türü:', typeof business.gallery_images);
            
            try {
                let images = [];
                
                // gallery_images bir string ise JSON olarak parse et, değilse doğrudan kullan
                if (business.gallery_images) {
                    if (typeof business.gallery_images === 'string') {
                        console.log('Gallery images string formatında:', business.gallery_images);
                        try {
                            images = JSON.parse(business.gallery_images);
                            console.log('JSON parse başarılı:', images);
                        } catch (e) {
                            console.error('Galeri JSON parse hatası:', e);
                            // Eğer parse edilemezse, string'i bir URL olarak kabul et
                            if (business.gallery_images.trim() !== '') {
                                images = [business.gallery_images];
                                console.log('String URL olarak kabul edildi:', images);
                            } else {
                                images = [];
                                console.log('Boş string, images boş array');
                            }
                        }
                    } else if (Array.isArray(business.gallery_images)) {
                        images = business.gallery_images;
                        console.log('Gallery images zaten array:', images);
                    } else {
                        console.log('Gallery images bilinmeyen format:', business.gallery_images);
                        images = [];
                    }
                } else {
                    console.log('Gallery images null/undefined/false');
                    images = [];
                }
                
                console.log('Final images array:', images);
                console.log('Images array uzunluğu:', images ? images.length : 0);
                
                if (!images || images.length === 0) {
                    console.log('Hiç resim bulunamadı, placeholder gösteriliyor');
                    galleryContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Galeride gösterilecek resim bulunamadı.</p>';
                    return;
                }
                
                console.log(`${images.length} adet resim işlenecek`);
                
                images.forEach((image, index) => {
                    console.log(`Resim ${index + 1} işleniyor:`, image);
                    
                    if (!image || (typeof image === 'string' && image.trim() === '')) {
                        console.log(`Resim ${index + 1} boş, atlanıyor`);
                        return; // Boş URL'leri atla
                    }
                    
                    const galleryItem = document.createElement('div');
                    galleryItem.className = 'gallery-item';
                    
                    const img = document.createElement('img');
                    
                    // URL'yi düzelt - eğer relative path ise absolute yap
                    let imageUrl = String(image);
                    if (imageUrl.startsWith('/uploads/')) {
                        imageUrl = window.location.origin + imageUrl;
                    } else if (!imageUrl.startsWith('http')) {
                        // Eğer uploads/ ile başlamıyorsa ekle
                        if (!imageUrl.startsWith('uploads/')) {
                            imageUrl = 'uploads/' + imageUrl;
                        }
                        imageUrl = window.location.origin + '/' + imageUrl;
                    }
                    
                    console.log(`Resim ${index + 1} URL:`, imageUrl);
                    
                    img.src = imageUrl;
                    img.alt = business.business_name || 'İşletme resmi';
                    img.loading = 'lazy'; // Lazy loading ekle
                    
                    // Resim yüklenemezse placeholder göster
                    img.onerror = function() {
                        console.error(`Resim ${index + 1} yüklenemedi:`, imageUrl);
                        // Resmi gizle ve placeholder div'i göster
                        this.style.display = 'none';
                        
                        // Placeholder div'i yoksa oluştur
                        if (!this.nextElementSibling || !this.nextElementSibling.classList.contains('placeholder-image')) {
                            const placeholder = document.createElement('div');
                            placeholder.className = 'placeholder-image placeholder-image-gallery';
                            placeholder.innerHTML = '<span>Resim Bulunamadı</span>';
                            placeholder.style.height = '200px';
                            placeholder.style.display = 'flex';
                            placeholder.style.alignItems = 'center';
                            placeholder.style.justifyContent = 'center';
                            this.parentNode.appendChild(placeholder);
                        }
                    };
                    
                    galleryItem.appendChild(img);
                    galleryContainer.appendChild(galleryItem);
                    
                    // Resim yüklendiğinde konsola bilgi yazdır
                    img.onload = function() {
                        console.log(`✅ Resim ${index + 1} başarıyla yüklendi:`, imageUrl);
                    };
                });
                
                console.log('Galeri container final HTML:', galleryContainer.innerHTML.substring(0, 200) + '...');
                
            } catch (error) {
                console.error('Galeri resimleri yüklenirken hata:', error);
                galleryContainer.innerHTML = '<p style="color: red; text-align: center; padding: 20px;">Galeri resimleri yüklenirken bir hata oluştu: ' + error.message + '</p>';
            }
        }
        
        // İşletme kaynaklarını yükleme
        async function loadBusinessResources(businessId) {
            const resourcesContainer = document.getElementById('resourcesList');
            const noResourcesMessage = document.getElementById('noResourcesMessage');
            const resourceLabel = document.getElementById('resourcesLabel');
            
            resourcesContainer.innerHTML = '<p>Kaynaklar yükleniyor...</p>';
            
            try {
                console.log(`Kaynaklar yükleniyor, işletme ID: ${businessId}`);
                
                const response = await fetch(`/api/business/resources/public?businessId=${businessId}`);
                console.log('Kaynak API yanıtı:', response.status, response.statusText);
                
                if (!response.ok) {
                    console.error('Kaynaklar getirilirken hata:', response.status, response.statusText);
                    throw new Error('Kaynaklar getirilirken bir hata oluştu');
                }
                
                const data = await response.json();
                console.log('Kaynak API verisi:', data);
                
                resourcesContainer.innerHTML = '';
                
                // Kaynak türü etiketleri
                const resourceTypeLabels = {
                    'kuafor': 'Koltuk',
                    'berber': 'Koltuk',
                    'klinik': 'Oda',
                    'restoran': 'Masa',
                    'spor': 'Saha',
                    'diger': 'Kaynak'
                };
                
                // İşletme türünü alıp etiket ve ikonları belirle
                const businessType = data.businessType || 'default';
                console.log('İşletme türü:', businessType);
                
                const typeLabel = resourceTypeLabels[businessType] || 'Kaynak';
                resourceLabel.textContent = `${typeLabel} Seçin`;
                
                if (!data.resources || data.resources.length === 0) {
                    console.log('Hiç kaynak bulunamadı');
                    noResourcesMessage.style.display = 'block';
                    return;
                }
                
                noResourcesMessage.style.display = 'none';
                
                console.log(`${data.resources.length} adet kaynak yüklendi`);
                
                // Kaynakları listele
                data.resources.forEach(resource => {
                    console.log('Kaynak yükleniyor:', resource);
                    
                    const resourceItem = document.createElement('div');
                    resourceItem.className = 'resource-item';
                    resourceItem.setAttribute('data-resource-id', resource.id);
                    
                    // Her kaynak türü için uygun ikon
                    const iconMap = {
                        'kuafor': 'chair',
                        'berber': 'chair',
                        'klinik': 'local_hospital',
                        'restoran': 'table_restaurant',
                        'spor': 'sports_soccer',
                        'diger': 'category'
                    };
                    
                    const icon = iconMap[businessType] || 'category';
                    
                    resourceItem.innerHTML = `
                        <span class="material-icons">${icon}</span>
                        <div>${resource.name}</div>
                    `;
                    
                    resourceItem.addEventListener('click', function() {
                        console.log(`Kaynak seçildi: ${resource.name}, ID: ${resource.id}`);
                        
                        document.querySelectorAll('.resource-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                        this.classList.add('selected');
                        
                        // Seçilen kaynağa göre müsait saatleri güncelle
                        const date = document.getElementById('appointmentDate').value;
                        if (date) {
                            loadTimeSlots(date, resource.id);
                        }
                    });
                    
                    resourcesContainer.appendChild(resourceItem);
                });
            } catch (error) {
                console.error('Kaynaklar yüklenirken hata:', error);
                resourcesContainer.innerHTML = '<p>Kaynaklar yüklenirken bir hata oluştu: ' + error.message + '</p>';
            }
        }
        
        // Modal sekmeleri arasında geçiş
        function showTab(tabName) {
            const tabs = document.querySelectorAll('.modal-tabs .tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            // Tüm sekmelerin aktif durumunu kaldır
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Tüm sekme içeriklerini gizle
            tabContents.forEach(content => content.classList.add('hidden'));
            
            // Seçilen sekmeyi aktif yap
            document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
            
            // Seçilen sekmenin içeriğini göster
            document.getElementById(`${tabName}Tab`).classList.remove('hidden');
            
            // Randevu sekmesi seçildiyse
            if (tabName === 'appointment') {
                // Hizmetleri yükle (sadece randevu sekmesinde seçim yapılabilir)
                const businessData = window.currentBusinessData;
                if (businessData) {
                    loadBusinessServicesForSelection(businessData);
                }
                
                // Varsayılan olarak bugünün tarihini ayarla
                const today = new Date();
                const dateInput = document.getElementById('appointmentDate');
                dateInput.min = today.toISOString().split('T')[0]; // Bugünden önceki günleri seçilemesin
                dateInput.value = today.toISOString().split('T')[0];
                
                // Önce seçilmiş olan kaynak ve saat seçimlerini temizle
                document.querySelectorAll('.resource-item').forEach(item => {
                    item.classList.remove('selected');
                });
                document.querySelectorAll('.time-slot').forEach(slot => {
                    slot.classList.remove('selected');
                });
                
                // Tarihe göre zaman dilimlerini yükle (seçili kaynak varsa ona göre)
                const selectedResource = document.querySelector('.resource-item.selected');
                const resourceId = selectedResource ? selectedResource.getAttribute('data-resource-id') : null;
                
                loadTimeSlots(dateInput.value, resourceId);
                
                // Tarih değiştiğinde zaman dilimlerini güncelle
                dateInput.addEventListener('change', function() {
                    const selectedResource = document.querySelector('.resource-item.selected');
                    const resourceId = selectedResource ? selectedResource.getAttribute('data-resource-id') : null;
                    loadTimeSlots(this.value, resourceId);
                });
                
                // Randevu sekmesi her açıldığında saatleri güncel veriyle yenile
                console.log('Randevu sekmesi açıldı, saatler yenileniyor...');
                setTimeout(() => {
                    const selectedResource = document.querySelector('.resource-item.selected');
                    const resourceId = selectedResource ? selectedResource.getAttribute('data-resource-id') : null;
                    if (resourceId) {
                        loadTimeSlots(dateInput.value, resourceId);
                    }
                }, 500); // Kısa bir gecikme ile saatleri yenile
            }
            
            // Değerlendirmeler sekmesi seçildiyse
            if (tabName === 'reviews') {
                loadBusinessReviews();
            }
        }
        
        // Zaman dilimlerini yükleme fonksiyonu
        async function loadTimeSlots(date, resourceId = null) {
            const businessId = document.getElementById('appointmentBusinessId').value;
            const timeSlotsContainer = document.getElementById('timeSlots');
            
            if (!businessId || !date) return;
            
            // Eğer kaynak seçilmediyse saatleri gösterme
            if (!resourceId) {
                timeSlotsContainer.innerHTML = '<p>Lütfen önce bir kaynak (koltuk) seçin.</p>';
                return;
            }
            
            // Yükleniyor mesajı
            timeSlotsContainer.innerHTML = '<p>Saatler yükleniyor...</p>';
            
            try {
                console.log(`İşletme ID ${businessId} için çalışma saatleri alınıyor...`);
                
                // API URL'sini oluştur ve konsola yazdır
                const apiUrl = `/api/business/schedule/public?businessId=${businessId}`;
                console.log('API URL:', apiUrl);
                
                // İşletmenin çalışma saatlerini al
                const scheduleResponse = await fetch(apiUrl);
                
                console.log('API yanıt durumu:', scheduleResponse.status, scheduleResponse.statusText);
                
                if (!scheduleResponse.ok) {
                    console.error('API yanıtı hatalı:', scheduleResponse.status, scheduleResponse.statusText);
                    throw new Error(`Çalışma saatleri alınamadı: ${scheduleResponse.status} ${scheduleResponse.statusText}`);
                }
                
                // Yanıt verisini JSON olarak çözümle ve durumunu konsola yazdır
                let scheduleData;
                try {
                    scheduleData = await scheduleResponse.json();
                    console.log('Çalışma saatleri verisi:', scheduleData);
                } catch (jsonError) {
                    console.error('JSON çözümleme hatası:', jsonError);
                    const responseText = await scheduleResponse.text();
                    console.error('Ham yanıt:', responseText);
                    throw new Error('Çalışma saatleri verisi geçerli JSON formatında değil');
                }
                
                // Veri bir dizi değilse
                if (!Array.isArray(scheduleData)) {
                    console.error('Beklenmeyen veri formatı:', scheduleData);
                    throw new Error('Çalışma saatleri verisi beklenen formatta değil');
                }
                
                // Seçilen tarihin haftanın günü
                const selectedDate = new Date(date);
                const jsDay = selectedDate.getDay(); // JavaScript'te 0: Pazar, 1: Pazartesi...
                console.log('Seçilen tarih:', date, 'JavaScript gün değeri:', jsDay);
                
                // JavaScript'in gün değerini veritabanı formatına dönüştürme
                // 0:Pazar, 1:Pazartesi, 2:Salı... -> 6:Pazar, 0:Pazartesi, 1:Salı...
                let adjustedDayOfWeek = jsDay === 0 ? 6 : jsDay - 1;
                console.log('Veritabanında aranacak gün değeri:', adjustedDayOfWeek);
                
                // Tüm schedule verilerini konsola yazdır
                scheduleData.forEach((dayData, index) => {
                    console.log(`Gün ${index}: day_of_week=${dayData.day_of_week}, is_working=${dayData.is_working}`);
                });
                
                // Seçilen günün çalışma saatlerini bul
                const daySchedule = scheduleData.find(schedule => {
                    const scheduleDay = parseInt(schedule.day_of_week);
                    console.log(`Karşılaştırma: ${scheduleDay} === ${adjustedDayOfWeek} -> ${scheduleDay === adjustedDayOfWeek}`);
                    return scheduleDay === adjustedDayOfWeek;
                });
                
                console.log('Bulunan çalışma saati verisi:', daySchedule);
                
                // Gün bulunamadı veya işletme o gün çalışmıyor
                if (!daySchedule) {
                    console.log('Bu gün için çalışma saati verisi bulunamadı');
                    timeSlotsContainer.innerHTML = '<p>İşletme seçilen tarihte hizmet vermemektedir.</p>';
                    return;
                }
                
                // is_working değeri string veya boolean olabilir
                console.log('is_working değerinin türü:', typeof daySchedule.is_working, 'değeri:', daySchedule.is_working);
                const isWorking = daySchedule.is_working === true || 
                                  daySchedule.is_working === 'true' || 
                                  daySchedule.is_working === 't' ||
                                  daySchedule.is_working === 1 ||
                                  daySchedule.is_working === '1';
                
                console.log('isWorking değeri:', isWorking);
                
                if (!isWorking) {
                    console.log('İşletme seçilen günde çalışmıyor (is_working değeri:', daySchedule.is_working, ')');
                    timeSlotsContainer.innerHTML = '<p>İşletme seçilen tarihte hizmet vermemektedir.</p>';
                    return;
                }
                
                // Başlangıç ve bitiş saatlerini al
                const startTime = daySchedule.start_time ? daySchedule.start_time.substring(0, 5) : '09:00';
                const endTime = daySchedule.end_time ? daySchedule.end_time.substring(0, 5) : '17:00';
                console.log('Çalışma saatleri:', startTime, '-', endTime);
                
                // Başlangıç ve bitiş saatlerini saat ve dakika olarak ayır
                const [startHour, startMinute] = startTime.split(':').map(Number);
                const [endHour, endMinute] = endTime.split(':').map(Number);
                
                // Tüm saat dilimlerini oluştur (1 saat aralıklarla)
                let availableTimes = [];
                for (let hour = startHour; hour <= endHour; hour++) {
                    // Eğer bu saat, bitiş saatinden küçükse ekle
                    if (hour < endHour || (hour === endHour && 0 <= endMinute)) {
                        availableTimes.push(`${hour.toString().padStart(2, '0')}:00`);
                    }
                }
                
                console.log('Oluşturulan saat dilimleri:', availableTimes);
                
                if (availableTimes.length === 0) {
                    console.log('Uygun saat bulunamadı');
                    timeSlotsContainer.innerHTML = '<p>Uygun saat bulunamadı.</p>';
                    return;
                }
                
                // Dolu saatleri getir
                const occupiedResponse = await fetch(`/api/business/occupied-slots?businessId=${businessId}&date=${date}&resourceId=${resourceId}`);
                let occupiedSlots = [];
                
                if (occupiedResponse.ok) {
                    const occupiedData = await occupiedResponse.json();
                    occupiedSlots = occupiedData.occupiedSlots || [];
                    console.log('Dolu saatler:', occupiedSlots);
                } else {
                    console.error('Dolu saatler alınamadı');
                }
                
                // Engellenen saatleri getir
                const blockedResponse = await fetch(`/api/business/blocked-slots/public?businessId=${businessId}&resourceId=${resourceId}&date=${date}`);
                let blockedSlots = [];
                
                if (blockedResponse.ok) {
                    const blockedData = await blockedResponse.json();
                    blockedSlots = blockedData.blockedSlots || [];
                    console.log('Engellenen saatler:', blockedSlots);
                } else {
                    console.error('Engellenen saatler alınamadı');
                }
                
                // Şu anki tarih ve saat
                const now = new Date();
                const today = now.toISOString().split('T')[0]; // Bugünün tarihi YYYY-MM-DD formatında
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();
                
                console.log('Şu anki zaman:', now, 'Saat:', currentHour, 'Dakika:', currentMinute);
                console.log('Seçilen tarih:', date, 'Bugünün tarihi:', today);
                
                // Saat seçeneklerini temizle
                timeSlotsContainer.innerHTML = '';
                
                // Saatleri ekle
                availableTimes.forEach(time => {
                    const timeSlot = document.createElement('div');
                    timeSlot.className = 'time-slot';
                    timeSlot.textContent = time;
                    timeSlot.setAttribute('data-time', time);
                    
                    // Saatin dolu olup olmadığını kontrol et
                    const isOccupied = occupiedSlots.includes(time);
                    
                    // Saatin engellenmiş olup olmadığını kontrol et
                    const isBlocked = blockedSlots.includes(time);
                    
                    // Seçilen tarih bugünse, geçmiş saatleri kontrol et
                    let isPastTime = false;
                    if (date === today) {
                        const [timeHour, timeMinute] = time.split(':').map(Number);
                        // Eğer saat geçmişse veya aynı saatte ama dakika geçmişse
                        if (timeHour < currentHour || (timeHour === currentHour && timeMinute <= currentMinute)) {
                            isPastTime = true;
                        }
                    }
                    
                    // Dolu, engellenmiş veya geçmiş saatleri disable et
                    if (isOccupied || isBlocked || isPastTime) {
                        timeSlot.classList.add('disabled');
                        if (isOccupied) {
                            timeSlot.title = 'Bu saat dolu';
                        } else if (isBlocked) {
                            timeSlot.title = 'Bu saatte hizmet verilmiyor';
                        } else if (isPastTime) {
                            timeSlot.title = 'Geçmiş saat';
                        }
                        
                        // Birden fazla durum varsa title'ı birleştir
                        if ((isOccupied && isPastTime) || (isBlocked && isPastTime)) {
                            const reasons = [];
                            if (isOccupied) reasons.push('dolu');
                            if (isBlocked) reasons.push('hizmet verilmiyor');
                            if (isPastTime) reasons.push('geçmiş saat');
                            timeSlot.title = reasons.join(' ve ');
                        }
                    } else {
                        // Sadece müsait saatlere tıklama event'i ekle
                        timeSlot.addEventListener('click', function() {
                            document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
                            this.classList.add('selected');
                        });
                    }
                    
                    timeSlotsContainer.appendChild(timeSlot);
                });
            } catch (error) {
                console.error('Saat yükleme hatası:', error);
                timeSlotsContainer.innerHTML = `<p>Saatler yüklenirken bir hata oluştu: ${error.message}</p>`;
            }
        }
        
        // Filtreleme için listener'ları ayarla
        function setupFilterListeners() {
            const searchInput = document.getElementById('searchInput');
            
            // Null kontrolü ekleyelim
            if (searchInput) {
                // Arama yapıldığında
                searchInput.addEventListener('input', function() {
                    applyFilters();
                });
            } else {
                console.warn('searchInput elementi bulunamadı');
            }
        }
        
        // Filtreler uygulanarak işletmeleri yükle
        async function applyFilters() {
            // Elementleri kontrol edelim ve null kontrolü yapalım
            const searchInput = document.getElementById('searchInput');
            const searchText = searchInput ? searchInput.value.toLowerCase() : '';
            
            try {
                const response = await fetch('/api/businesses');
                let businesses = await response.json();
                
                // İşletme türü filtresi için kategori kartından durum al
                const activeCategory = document.querySelector('.category-card.active');
                const selectedCategory = activeCategory ? activeCategory.getAttribute('data-type') : 'all';
                
                // Kategori filtrelemesi
                if (selectedCategory !== 'all') {
                    businesses = businesses.filter(business => {
                        const type = (business.business_type || '').toLowerCase().trim();
                        const validTypes = categoryMap[selectedCategory] || [];
                        return validTypes.includes(type);
                    });
                }
                
                // Arama filtresi
                if (searchText) {
                    businesses = businesses.filter(business => 
                        (business.business_name || '').toLowerCase().includes(searchText) ||
                        (business.city || '').toLowerCase().includes(searchText) ||
                        (business.district || '').toLowerCase().includes(searchText)
                    );
                }
                
                const noResultsElem = document.getElementById('noResults');
                const businessListElem = document.getElementById('businessList');
                
                if (!businesses || businesses.length === 0) {
                    if (noResultsElem) noResultsElem.style.display = 'block';
                    if (businessListElem) businessListElem.innerHTML = '';
                } else {
                    if (noResultsElem) noResultsElem.style.display = 'none';
                    if (businessListElem) displayBusinesses(businesses);
                }
            } catch (error) {
                console.error('Filtreleme hatası:', error);
            }
        }
        
        // Randevu formu gönderimi
        function setupAppointmentForm() {
            document.getElementById('appointmentForm').addEventListener('submit', async function(e) {
                try {
                    e.preventDefault();
                    console.log('Randevu formu gönderiliyor...');
                    
                    const businessId = document.getElementById('appointmentBusinessId').value;
                    const date = document.getElementById('appointmentDate').value;
                    const selectedTimeSlot = document.querySelector('.time-slot.selected');
                    const selectedResource = document.querySelector('.resource-item.selected');
                    const note = document.getElementById('appointmentNote').value;
                    const couponId = document.getElementById('appointmentCoupon').value;
                    
                                            console.log('Form değerleri:', { 
                            businessId, 
                            date, 
                            selectedTimeSlot: selectedTimeSlot ? selectedTimeSlot.getAttribute('data-time') : null,
                            selectedResource: selectedResource ? selectedResource.getAttribute('data-resource-id') : null,
                            selectedServices: selectedServices,
                            note,
                            couponId 
                        });
                    
                    if (!businessId || !date) {
                        showWarning('Lütfen işletme ve tarih seçin', 'Eksik Bilgi');
                        console.error('İşletme veya tarih eksik');
                        return;
                    }
                    
                    if (!selectedResource) {
                        showWarning('Lütfen bir kaynak seçin (koltuk, masa vb.)', 'Kaynak Seçimi Gerekli');
                        console.error('Kaynak seçilmemiş');
                        return;
                    }
                    
                    if (!selectedTimeSlot) {
                        showWarning('Lütfen bir saat dilimi seçin', 'Saat Seçimi Gerekli');
                        console.error('Saat dilimi seçilmemiş');
                        return;
                    }
                    
                    // Seçilen saatin disabled olup olmadığını kontrol et
                    if (selectedTimeSlot.classList.contains('disabled')) {
                        showWarning('Seçilen saat dilimi müsait değil. Lütfen başka bir saat seçin.', 'Saat Müsait Değil');
                        console.error('Disabled saat seçilmiş');
                        return;
                    }
                    
                    // Kaynak zorunlu değil ancak seçili ise ID'sini al
                    const resourceId = selectedResource ? selectedResource.getAttribute('data-resource-id') : null;
                    
                    const time = selectedTimeSlot.getAttribute('data-time');
                    
                    // Çoklu hizmet seçimi - ARTIK TÜM HİZMETLERİ GÖNDERECEĞİZ
                    const firstSelectedService = selectedServices.length > 0 ? selectedServices[0] : null;
                    
                    const token = localStorage.getItem('token');
                    console.log('Token mevcut:', !!token);
                    console.log('🚀 FORM GÖNDERİMİ - Seçilen hizmetler:', selectedServices);
                    console.log('📊 Seçilen hizmet sayısı:', selectedServices.length);
                    selectedServices.forEach((service, index) => {
                        console.log(`📋 Hizmet ${index + 1}:`, service);
                    });
                    
                    if (!token) {
                        showError('Oturum süresi dolmuş. Lütfen tekrar giriş yapın.', 'Oturum Süresi Doldu');
                        window.location.href = '/login.html';
                        return;
                    }
                    
                    try {
                        console.log('API isteği gönderiliyor...');
                        console.log('Gönderilen veriler:', {
                            businessId,
                            date,
                            time,
                            resourceId,
                            serviceId: firstSelectedService ? firstSelectedService.id : null,
                            selectedServices: selectedServices, // TÜM SEÇILEN HİZMETLER
                            note
                        });
                        
                        // BusinessId'yi sayıya çevirelim
                        const numericBusinessId = parseInt(businessId, 10);
                        const numericResourceId = resourceId ? parseInt(resourceId, 10) : null;
                        const numericServiceId = firstSelectedService ? parseInt(firstSelectedService.id, 10) : null;
                        
                        console.log('Dönüştürülmüş değerler:', {
                            businessId: numericBusinessId,
                            resourceId: numericResourceId,
                            serviceId: numericServiceId,
                            selectedServicesCount: selectedServices.length
                        });
                        
                        // API URL'sini kontrol et
                        console.log('API URL:', '/api/appointments');
                        console.log('Headers:', {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token.substring(0, 15)}...`
                        });
                        
                        const response = await fetch('/api/appointments', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                businessId: numericBusinessId,
                                date,
                                time,
                                resourceId: numericResourceId,
                                serviceId: numericServiceId,
                                selectedServices: selectedServices, // Tüm seçilen hizmetler - MİKTAR BİLGİSİ DAHİL
                                note,
                                couponId: couponId || null // Seçilen kupon ID'si
                            })
                        });
                        
                        console.log('API yanıtı alındı:', response.status, response.statusText);
                        
                        const result = await response.json();
                        console.log('API yanıt verisi:', result);
                        
                        console.log('API yanıtı işleniyor...');
                        
                        if (response.ok) {
                            console.log('✅ Randevu başarıyla oluşturuldu');
                            
                            // Başarı mesajını kutu içinde göster
                            const successMessage = document.createElement('div');
                            successMessage.style.cssText = `
                                position: fixed;
                                top: 50%;
                                left: 50%;
                                transform: translate(-50%, -50%);
                                background: white;
                                border: 2px solid #4CAF50;
                                border-radius: 12px;
                                padding: 30px;
                                text-align: center;
                                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                                z-index: 10000;
                                max-width: 400px;
                                font-family: Arial, sans-serif;
                            `;
                            
                            successMessage.innerHTML = `
                                <div style="color: #4CAF50; font-size: 48px; margin-bottom: 15px;">✓</div>
                                <h3 style="color: #333; margin-bottom: 15px;">Randevu Talebiniz Gönderilmiştir</h3>
                                <p style="color: #666; line-height: 1.5; margin-bottom: 20px;">
                                    Randevu talebinizin durumunu profilinizdeki 
                                    <strong>"Aktif Randevularım"</strong> penceresinden takip edebilirsiniz.
                                </p>
                                <button onclick="this.parentElement.remove(); document.getElementById('businessDetailModal').style.display='none'; window.location.reload();" 
                                        style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 16px;">
                                    Tamam
                                </button>
                            `;
                            
                            document.body.appendChild(successMessage);
                            
                            // 5 saniye sonra otomatik olarak kapat
                            setTimeout(() => {
                                if (document.body.contains(successMessage)) {
                                    successMessage.remove();
                                    document.getElementById('businessDetailModal').style.display = 'none';
                                    window.location.reload();
                                }
                            }, 5000);
                            
                        } else {
                            console.log('❌ Randevu oluşturma hatası:', result.error);
                            
                            // Eğer çakışma hatası ise (409), saatleri yeniden yükle
                            if (response.status === 409) {
                                console.log('Çakışma hatası algılandı, saatler yeniden yükleniyor...');
                                const selectedResource = document.querySelector('.resource-item.selected');
                                const resourceId = selectedResource ? selectedResource.getAttribute('data-resource-id') : null;
                                if (resourceId) {
                                    loadTimeSlots(date, resourceId);
                                }
                            }
                            
                            // Hata mesajını kutu içinde göster
                            const errorMessage = document.createElement('div');
                            errorMessage.style.cssText = `
                                position: fixed;
                                top: 50%;
                                left: 50%;
                                transform: translate(-50%, -50%);
                                background: white;
                                border: 2px solid #f44336;
                                border-radius: 12px;
                                padding: 30px;
                                text-align: center;
                                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                                z-index: 10000;
                                max-width: 400px;
                                font-family: Arial, sans-serif;
                            `;
                            
                            errorMessage.innerHTML = `
                                <div style="color: #f44336; font-size: 48px; margin-bottom: 15px;">✗</div>
                                <h3 style="color: #333; margin-bottom: 15px;">Randevu Oluşturma Hatası</h3>
                                <p style="color: #666; line-height: 1.5; margin-bottom: 20px;">
                                    ${result.error || 'Bilinmeyen bir hata oluştu'}
                                </p>
                                <button onclick="this.parentElement.remove();" 
                                        style="background: #f44336; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 16px;">
                                    Tamam
                                </button>
                            `;
                            
                            document.body.appendChild(errorMessage);
                        }
                    } catch (error) {
                        console.error('Randevu oluşturma API hatası:', error);
                        
                        // Bağlantı hatası mesajını kutu içinde göster
                        const connectionErrorMessage = document.createElement('div');
                        connectionErrorMessage.style.cssText = `
                            position: fixed;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            background: white;
                            border: 2px solid #ff9800;
                            border-radius: 12px;
                            padding: 30px;
                            text-align: center;
                            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                            z-index: 10000;
                            max-width: 400px;
                            font-family: Arial, sans-serif;
                        `;
                        
                        connectionErrorMessage.innerHTML = `
                            <div style="color: #ff9800; font-size: 48px; margin-bottom: 15px;">⚠</div>
                            <h3 style="color: #333; margin-bottom: 15px;">Bağlantı Hatası</h3>
                            <p style="color: #666; line-height: 1.5; margin-bottom: 20px;">
                                Sunucuya bağlanırken bir hata oluştu. Lütfen internet bağlantınızı kontrol edip tekrar deneyin.
                            </p>
                            <button onclick="this.parentElement.remove();" 
                                    style="background: #ff9800; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 16px;">
                                Tamam
                            </button>
                        `;
                        
                        document.body.appendChild(connectionErrorMessage);
                    }
                } catch (globalError) {
                    console.error('Randevu formu global hatası:', globalError);
                    showError('Beklenmedik bir hata oluştu: ' + globalError.message, 'Sistem Hatası');
                }
            });
        }

        // İl seçildiğinde ilçeleri güncelle
        function updateDistricts() {
            const citySelect = document.getElementById('citySelect');
            const districtSelect = document.getElementById('districtSelect');
            const selectedCity = citySelect.value;
            
            // İlçe seçimini sıfırla
            districtSelect.innerHTML = '<option value="">Tüm İlçeler</option>';
            
            if (!selectedCity) return;
            
            // Seçilen şehre göre ilçeleri filtrele
            const districts = getDistrictsForCity(selectedCity);
            
            // İlçeleri ekle
            districts.forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                districtSelect.appendChild(option);
            });
        }
        
        // Şehirlere göre ilçeleri döndüren fonksiyon
        function getDistrictsForCity(city) {
            const districtMap = {
                'İstanbul': ['Kadıköy', 'Beşiktaş', 'Şişli', 'Üsküdar', 'Beyoğlu', 'Ataşehir', 'Maltepe'],
                'Ankara': ['Çankaya', 'Keçiören', 'Mamak', 'Altındağ', 'Yenimahalle', 'Etimesgut'],
                'İzmir': ['Konak', 'Karşıyaka', 'Bornova', 'Bayraklı', 'Çiğli', 'Balçova'],
                'Bursa': ['Nilüfer', 'Osmangazi', 'Yıldırım', 'Gemlik', 'Mudanya'],
                'Antalya': ['Muratpaşa', 'Konyaaltı', 'Kepez', 'Alanya', 'Manavgat']
            };
            
            return districtMap[city] || [];
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // İşletmeleri yükle
            loadBusinesses();
        });

        // Modal için olayları ayarla
        function setupModalListeners() {
            // Modal kapat
            document.querySelector('.close-button').addEventListener('click', function() {
                document.getElementById('businessDetailModal').style.display = 'none';
            });
            
            // Modal dışına tıklandığında kapat
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('businessDetailModal');
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
            
            // ESC tuşuna basıldığında modalı kapat
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    document.getElementById('businessDetailModal').style.display = 'none';
                }
            });
            
            // Sekme değiştirme
            document.querySelectorAll('.modal-tabs .tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    showTab(this.getAttribute('data-tab'));
                });
            });
        }

        // İşletme hizmetlerini dropdown'a yükleme
        function loadBusinessServicesForDropdown(business) {
            const serviceSelect = document.getElementById('appointmentService');
            serviceSelect.innerHTML = '<option value="">Hizmet seçiniz</option>';
            
            if (!business.services || business.services.length === 0) {
                console.log('Bu işletmede hizmet bulunmuyor');
                return;
            }
            
            console.log('Dropdown için hizmetler yükleniyor:', business.services);
            
            // Hizmetleri dropdown'a ekle
            business.services.forEach(service => {
                if (typeof service === 'object' && service.name) {
                    const option = document.createElement('option');
                    option.value = service.id;
                    
                    // Hizmet adı ve fiyat bilgisini göster
                    let optionText = service.name;
                    if (service.price && parseFloat(service.price) > 0) {
                        optionText += ` - ${service.price} TL`;
                    }
                    if (service.duration && parseInt(service.duration) > 0) {
                        optionText += ` (${service.duration} dk)`;
                    }
                    
                    option.textContent = optionText;
                    serviceSelect.appendChild(option);
                } else if (typeof service === 'string') {
                    // Eski format string hizmetler için
                    const option = document.createElement('option');
                    option.value = ''; // String hizmetlerin ID'si yok
                    option.textContent = service;
                    serviceSelect.appendChild(option);
                }
            });
        }

        // Seçilen hizmetleri takip etmek için global değişken
        let selectedServices = [];
        
        // İşletme hizmetlerini kategorili ve çoklu seçim yapılabilir şekilde yükleme
        function loadBusinessServicesForSelection(business) {
            console.log('🎯 loadBusinessServicesForSelection fonksiyonu çağrıldı');
            console.log('📋 Business verisi:', business);
            console.log('📋 Business.services:', business.services);
            
            const servicesContainer = document.getElementById('servicesCategories');
            const selectedServicesSummary = document.getElementById('selectedServicesSummary');
            
            console.log('🎯 servicesContainer:', servicesContainer);
            console.log('🎯 selectedServicesSummary:', selectedServicesSummary);
            
            // Seçilen hizmetleri standart randevu ile başlat
            selectedServices = [{
                id: 'standard',
                name: 'Standart Randevu',
                price: window.currentBusinessReservationPrice || 0,
                quantity: 1
            }];
            updateSelectedServicesSummary();
            
            if (!business.services || business.services.length === 0) {
                console.log('❌ Hizmet bulunamadı, boş mesaj gösteriliyor');
                servicesContainer.innerHTML = '<p class="no-services-message">Bu işletme için ek hizmet bulunmuyor. Standart randevu ücreti üzerinden devam edebilirsiniz.</p>';
                return;
            }
            
            console.log('✅ Hizmetler bulundu, kategorili hizmet seçimi için yükleniyor:', business.services);
            
            // Hizmetleri kategorilere göre gruplandır
            const servicesByCategory = {};
            
            business.services.forEach(service => {
                if (typeof service === 'object' && service.name) {
                    const categoryName = service.category_name || 'Diğer Hizmetler';
                    const categoryColor = service.category_color || '#6c757d';
                    
                    if (!servicesByCategory[categoryName]) {
                        servicesByCategory[categoryName] = {
                            name: categoryName,
                            color: categoryColor,
                            services: []
                        };
                    }
                    
                    servicesByCategory[categoryName].services.push(service);
                }
            });
            
            // Kategorileri HTML olarak oluştur
            servicesContainer.innerHTML = '';
            
            if (Object.keys(servicesByCategory).length === 0) {
                servicesContainer.innerHTML = '<p class="no-services-message">Bu işletmede hizmet bulunmuyor.</p>';
                return;
            }
            
            Object.values(servicesByCategory).forEach(category => {
                const categoryGroup = document.createElement('div');
                categoryGroup.className = 'service-category-group';
                
                // Kategori başlığı (her zaman görünür, tıklanabilir)
                const categoryTitle = document.createElement('div');
                categoryTitle.className = 'service-category-title visible'; // visible class'ını baştan ekle
                categoryTitle.style.cursor = 'pointer';
                categoryTitle.innerHTML = `
                    <div class="category-color-indicator" style="background-color: ${category.color}"></div>
                    <span>${category.name}</span>
                    <span class="category-count">(${category.services.length} hizmet)</span>
                    <span class="material-icons category-toggle-icon expanded">expand_less</span>
                `;
                
                // Kategori hizmetleri (başlangıçta açık)
                const categoryServices = document.createElement('div');
                categoryServices.className = 'service-category-services expanded';
                
                category.services.forEach(service => {
                    const serviceItem = document.createElement('div');
                    serviceItem.className = 'service-quantity-item';
                    serviceItem.setAttribute('data-service-id', service.id);
                    
                    let priceText = '';
                    if (service.price && parseFloat(service.price) > 0) {
                        priceText = `<span class="service-price">${service.price} TL</span>`;
                    }
                    
                    let durationText = '';
                    if (service.duration && parseInt(service.duration) > 0) {
                        durationText = `<span class="service-duration">${service.duration} dk</span>`;
                    }
                    
                    serviceItem.innerHTML = `
                        <div class="service-info">
                            <div class="service-name">${service.name}</div>
                            <div class="service-details">
                                ${priceText}
                                ${durationText}
                            </div>
                        </div>
                        <div class="quantity-controls">
                            <button type="button" class="quantity-btn decrease" onclick="changeServiceQuantity(${service.id}, -1)" disabled>
                                <span class="material-icons">remove</span>
                            </button>
                            <input type="number" class="quantity-input" value="0" min="0" max="10" 
                                   onchange="setServiceQuantity(${service.id}, this.value)">
                            <button type="button" class="quantity-btn increase" onclick="changeServiceQuantity(${service.id}, 1)">
                                <span class="material-icons">add</span>
                            </button>
                        </div>
                    `;
                    
                    // Service data'sını element'e ekle
                    serviceItem.setAttribute('data-service', JSON.stringify(service));
                    
                    categoryServices.appendChild(serviceItem);
                });
                
                // Kategori başlığına tıklama event'i ekle (accordion)
                categoryTitle.addEventListener('click', function() {
                    const toggleIcon = this.querySelector('.category-toggle-icon');
                    
                    if (categoryServices.classList.contains('expanded')) {
                        categoryServices.classList.remove('expanded');
                        toggleIcon.classList.remove('expanded');
                    } else {
                        categoryServices.classList.add('expanded');
                        toggleIcon.classList.add('expanded');
                    }
                });
                
                categoryGroup.appendChild(categoryTitle);
                categoryGroup.appendChild(categoryServices);
                servicesContainer.appendChild(categoryGroup);
                
                console.log('✅ Kategori grubu servicesContainer\'a eklendi:', category.name);
            });
            
            console.log('🎯 Tüm kategoriler eklendi, final servicesContainer içeriği:', servicesContainer.innerHTML.substring(0, 200) + '...');
        }
        
        // Hizmet miktarını değiştirme
        function changeServiceQuantity(serviceId, change) {
            console.log('🔧 changeServiceQuantity çağrıldı:', { serviceId, change });
            
            const serviceItem = document.querySelector(`[data-service-id="${serviceId}"]`);
            if (!serviceItem) {
                console.error('❌ Service item bulunamadı:', serviceId);
                return;
            }
            
            const quantityInput = serviceItem.querySelector('.quantity-input');
            const decreaseBtn = serviceItem.querySelector('.quantity-btn.decrease');
            const increaseBtn = serviceItem.querySelector('.quantity-btn.increase');
            
            let currentQuantity = parseInt(quantityInput.value) || 0;
            let newQuantity = Math.max(0, Math.min(10, currentQuantity + change));
            
            console.log('📊 Miktar değişimi:', { currentQuantity, newQuantity });
            
            quantityInput.value = newQuantity;
            
            // Buton durumlarını güncelle
            decreaseBtn.disabled = newQuantity <= 0;
            increaseBtn.disabled = newQuantity >= 10;
            
            // Seçilen hizmetleri güncelle
            updateServiceSelection(serviceId, newQuantity);
            
            // Görünümü güncelle
            updateServiceItemAppearance(serviceItem, newQuantity > 0);
            
            console.log('✅ Miktar güncellendi, yeni selectedServices:', selectedServices);
        }
        
        // Hizmet miktarını doğrudan ayarlama
        function setServiceQuantity(serviceId, quantity) {
            const serviceItem = document.querySelector(`[data-service-id="${serviceId}"]`);
            const quantityInput = serviceItem.querySelector('.quantity-input');
            const decreaseBtn = serviceItem.querySelector('.quantity-btn.decrease');
            const increaseBtn = serviceItem.querySelector('.quantity-btn.increase');
            
            quantity = Math.max(0, Math.min(10, parseInt(quantity) || 0));
            quantityInput.value = quantity;
            
            // Buton durumlarını güncelle
            decreaseBtn.disabled = quantity <= 0;
            increaseBtn.disabled = quantity >= 10;
            
            // Seçilen hizmetleri güncelle
            updateServiceSelection(serviceId, quantity);
            
            // Görünümü güncelle
            updateServiceItemAppearance(serviceItem, quantity > 0);
        }
        
        // Hizmet seçimini güncelleme
        function updateServiceSelection(serviceId, quantity) {
            console.log('🔄 updateServiceSelection çağrıldı:', { serviceId, quantity });
            
            const serviceItem = document.querySelector(`[data-service-id="${serviceId}"]`);
            const serviceData = JSON.parse(serviceItem.getAttribute('data-service'));
            
            console.log('📋 Service data:', serviceData);
            
            // Mevcut hizmeti seçili listeden çıkar
            selectedServices = selectedServices.filter(s => s.id !== serviceData.id);
            console.log('🗑️ Hizmet listeden çıkarıldı, kalan:', selectedServices);
            
            // Eğer miktar 0'dan büyükse, yeni miktar ile ekle
            if (quantity > 0) {
                const newService = {
                    ...serviceData,
                    quantity: quantity
                };
                selectedServices.push(newService);
                console.log('➕ Yeni hizmet eklendi:', newService);
            }
            
            console.log('📦 Final selectedServices:', selectedServices);
            
            updateSelectedServicesSummary();
            updateCategoryVisibility();
        }
        
        // Hizmet item görünümünü güncelleme
        function updateServiceItemAppearance(serviceItem, isSelected) {
            if (isSelected) {
                serviceItem.classList.add('selected');
            } else {
                serviceItem.classList.remove('selected');
            }
        }
        
        // Seçilen hizmetler özetini güncelleme
        function updateSelectedServicesSummary() {
            const summaryDiv = document.getElementById('selectedServicesSummary');
            const servicesListDiv = document.getElementById('selectedServicesList');
            const totalPriceDiv = document.getElementById('totalPrice');
            
            // Standart randevu her zaman gösterilir
            if (selectedServices.length === 0) {
                selectedServices = [{
                    id: 'standard',
                    name: 'Standart Randevu',
                    price: window.currentBusinessReservationPrice || 0,
                    quantity: 1
                }];
            }
            
            summaryDiv.style.display = 'block';
            
            // Seçilen hizmetler listesi
            servicesListDiv.innerHTML = '';
            let totalPrice = 0;
            let totalItems = 0;
            
            selectedServices.forEach(service => {
                const quantity = service.quantity || 1;
                const serviceTag = document.createElement('div');
                serviceTag.className = 'selected-service-tag';
                
                // Fiyat hesaplama
                const unitPrice = parseFloat(service.price) || 0;
                const serviceTotal = unitPrice * quantity;
                
                let priceDisplay = '';
                if (unitPrice > 0) {
                    if (quantity > 1) {
                        priceDisplay = ` (${quantity}x${unitPrice} TL)`;
                    } else {
                        priceDisplay = ` (${unitPrice} TL)`;
                    }
                }
                
                // Standart randevu ise kaldırma butonunu gösterme
                if (service.id === 'standard') {
                    serviceTag.innerHTML = `
                        <span>${service.name} ${quantity > 1 ? `x${quantity}` : ''}${priceDisplay}</span>
                    `;
                    serviceTag.classList.add('default-service');
                } else {
                    serviceTag.innerHTML = `
                        <span>${service.name} ${quantity > 1 ? `x${quantity}` : ''}${priceDisplay}</span>
                        <span class="remove-service" onclick="removeSelectedService(${service.id})">×</span>
                    `;
                }
                servicesListDiv.appendChild(serviceTag);
                
                // Toplam fiyat hesaplama
                totalPrice += serviceTotal;
                totalItems += quantity;
            });
            
            // Toplam fiyat ve miktar gösterimi
            const itemText = totalItems === 1 ? 'hizmet' : 'hizmet';
            totalPriceDiv.innerHTML = `
                <div>Toplam: ${totalItems} ${itemText}</div>
                <div style="font-size: 1.1em; color: #2196f3;">₺${totalPrice.toFixed(2)}</div>
            `;
            
            // Final toplam fiyatı da güncelle
            const finalTotalElement = document.getElementById('finalTotalPrice');
            if (finalTotalElement) {
                finalTotalElement.textContent = `${totalPrice.toFixed(2)} TL`;
            }
        }
        
        // Seçilen hizmeti kaldırma
        function removeSelectedService(serviceId) {
            // Standart randevu kaldırılamaz
            if (serviceId === 'standard') {
                return;
            }
            
            // Quantity input'u sıfırla
            const serviceItem = document.querySelector(`[data-service-id="${serviceId}"]`);
            if (serviceItem) {
                const quantityInput = serviceItem.querySelector('.quantity-input');
                const decreaseBtn = serviceItem.querySelector('.quantity-btn.decrease');
                const increaseBtn = serviceItem.querySelector('.quantity-btn.increase');
                
                quantityInput.value = 0;
                decreaseBtn.disabled = true;
                increaseBtn.disabled = false;
                
                updateServiceItemAppearance(serviceItem, false);
            }
            
            // Seçilen hizmetlerden çıkar
            selectedServices = selectedServices.filter(s => s.id !== serviceId);
            updateSelectedServicesSummary();
            updateCategoryVisibility();
        }

        // Kategori başlıklarının vurgusunu güncelleme
        function updateCategoryVisibility() {
            // Seçilen hizmetlerin kategorilerini belirle
            const selectedCategories = new Set();
            selectedServices.forEach(service => {
                const categoryName = service.category_name || 'Diğer Hizmetler';
                selectedCategories.add(categoryName);
            });

            // Tüm kategori başlıklarını kontrol et ve seçilen kategorileri vurgula
            document.querySelectorAll('.service-category-group').forEach(categoryGroup => {
                const categoryTitle = categoryGroup.querySelector('.service-category-title');
                const categoryName = categoryTitle.querySelector('span').textContent;
                
                if (selectedCategories.has(categoryName)) {
                    categoryTitle.classList.add('has-selected');
                } else {
                    categoryTitle.classList.remove('has-selected');
                }
            });
        }

        // Fonksiyonları global hale getir
        window.changeServiceQuantity = changeServiceQuantity;
        window.setServiceQuantity = setServiceQuantity;
        window.removeSelectedService = removeSelectedService;

        // Bildirim paneli fonksiyonları
        let notifications = [];
        let unreadCount = 0;

        function toggleNotifications() {
            const dropdown = document.getElementById('notificationDropdown');
            const notificationBtn = document.querySelector('.notification-btn');
            
            dropdown.classList.toggle('active');
            
            if (dropdown.classList.contains('active')) {
                // Bildirim butonunun konumunu al
                const btnRect = notificationBtn.getBoundingClientRect();
                
                // Dropdown'ı bildirim butonunun altına konumlandır
                dropdown.style.top = (btnRect.bottom + 10) + 'px';
                dropdown.style.right = (window.innerWidth - btnRect.right) + 'px';
                
                loadNotifications();
            }
        }

        function loadNotifications() {
            // Hem mesaj hem de randevu bildirimlerini yükle
            loadAllNotifications();
        }

        async function loadAllNotifications() {
            try {
                const token = localStorage.getItem('token');
                if (!token) return;

                const allNotifications = [];

                // 1. Mesaj bildirimlerini yükle
                const messageNotifications = await loadMessageNotifications();
                allNotifications.push(...messageNotifications);

                // 2. Randevu onay bildirimlerini yükle
                const appointmentNotifications = await loadAppointmentNotifications();
                allNotifications.push(...appointmentNotifications);

                // Bildirimleri zamana göre sırala (en yeni önce)
                allNotifications.sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0));

                notifications = allNotifications;
                updateNotificationBadge();
                renderNotifications();
            } catch (error) {
                console.error('Bildirim yükleme hatası:', error);
                notifications = [];
                updateNotificationBadge();
                renderNotifications();
            }
        }

        async function loadMessageNotifications() {
            try {
                const token = localStorage.getItem('token');
                if (!token) return [];

                // Aktif randevuları getir
                const response = await fetch('/api/appointments/active', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const appointments = await response.json();
                    const messageNotifications = [];

                    // Her randevu için okunmamış mesaj sayısını kontrol et
                    for (const appointment of appointments) {
                        try {
                            const unreadResponse = await fetch(`/api/messages/unread/${appointment.id}`, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            
                            if (unreadResponse.ok) {
                                const { unreadCount } = await unreadResponse.json();
                                if (unreadCount > 0) {
                                    messageNotifications.push({
                                        id: `message_${appointment.id}`,
                                        title: 'Yeni Mesaj',
                                        message: `${appointment.businessName} ile randevunuzda ${unreadCount} okunmamış mesaj`,
                                        time: 'Yeni',
                                        type: 'message',
                                        unread: true,
                                        appointmentId: appointment.id,
                                        timestamp: new Date()
                                    });
                                }
                            }
                        } catch (err) {
                            console.log('Mesaj kontrolü hatası:', err);
                        }
                    }

                    return messageNotifications;
                }
                return [];
            } catch (error) {
                console.error('Mesaj bildirimleri yükleme hatası:', error);
                return [];
            }
        }

        async function loadAppointmentNotifications() {
            try {
                const token = localStorage.getItem('token');
                if (!token) return [];

                // Son 24 saat içinde onaylanan ve reddedilen randevuları getir
                const response = await fetch('/api/appointments/recent-status-changes', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const statusChangedAppointments = await response.json();
                    const appointmentNotifications = [];

                    for (const appointment of statusChangedAppointments) {
                        // Bildirimin okunup okunmadığını kontrol et
                        const isRead = localStorage.getItem(`notification_read_${appointment.id}`) === 'true';
                        
                        if (!isRead) {
                            const appointmentDate = new Date(appointment.date);
                            const formattedDate = appointmentDate.toLocaleDateString('tr-TR');
                            const formattedTime = appointmentDate.toLocaleTimeString('tr-TR', {
                                hour: '2-digit',
                                minute: '2-digit'
                            });

                            let title, message, notificationType;
                            
                            if (appointment.status === 'Onaylandı') {
                                title = 'Randevu Onaylandı';
                                message = `${appointment.businessName} ile ${formattedDate} ${formattedTime} randevunuz onaylandı`;
                                notificationType = 'appointment';
                            } else if (appointment.status === 'Reddedildi') {
                                title = 'Randevu Reddedildi';
                                message = `${appointment.businessName} ile ${formattedDate} ${formattedTime} randevu talebiniz reddedildi`;
                                notificationType = 'warning';
                            } else {
                                continue; // Diğer durumları atla
                            }

                            appointmentNotifications.push({
                                id: `appointment_${appointment.id}`,
                                title: title,
                                message: message,
                                time: getTimeAgo(appointment.updated_at),
                                type: notificationType,
                                unread: true,
                                appointmentId: appointment.id,
                                timestamp: new Date(appointment.updated_at)
                            });
                        }
                    }

                    return appointmentNotifications;
                }
                return [];
            } catch (error) {
                console.error('Randevu bildirimleri yükleme hatası:', error);
                return [];
            }
        }

        // Zaman farkını hesaplayan yardımcı fonksiyon
        function getTimeAgo(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const diffInMinutes = Math.floor((now - date) / (1000 * 60));

            if (diffInMinutes < 1) return 'Şimdi';
            if (diffInMinutes < 60) return `${diffInMinutes} dakika önce`;
            
            const diffInHours = Math.floor(diffInMinutes / 60);
            if (diffInHours < 24) return `${diffInHours} saat önce`;
            
            const diffInDays = Math.floor(diffInHours / 24);
            return `${diffInDays} gün önce`;
        }

        function renderNotifications() {
            const notificationList = document.getElementById('notificationList');
            
            if (notifications.length === 0) {
                notificationList.innerHTML = `
                    <div class="no-notifications">
                        <span class="material-icons">notifications_none</span>
                        <p>Henüz bildirim yok</p>
                    </div>
                `;
                return;
            }

            const notificationHTML = notifications.map(notification => {
                const iconMap = {
                    'appointment': 'event',
                    'reminder': 'schedule',
                    'info': 'info',
                    'warning': 'warning',
                    'message': 'message'
                };

                const clickHandler = notification.type === 'message' 
                    ? `openAppointmentMessages(${notification.appointmentId})` 
                    : `markAsRead(${notification.id})`;

                return `
                    <div class="notification-item ${notification.unread ? 'unread' : ''}" 
                         onclick="${clickHandler}">
                        <div class="notification-content">
                            <span class="material-icons notification-icon">
                                ${iconMap[notification.type] || 'notifications'}
                            </span>
                            <div class="notification-text">
                                <div class="notification-title">${notification.title}</div>
                                <div class="notification-message">${notification.message}</div>
                                <div class="notification-time">${notification.time}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            notificationList.innerHTML = notificationHTML;
        }

        function updateNotificationBadge() {
            unreadCount = notifications.filter(n => n.unread).length;
            const badge = document.getElementById('notificationBadge');
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        function markAsRead(notificationId) {
            const notification = notifications.find(n => n.id === notificationId);
            if (notification && notification.unread) {
                notification.unread = false;
                
                // Randevu bildirimi ise localStorage'a kaydet
                if (notification.type === 'appointment') {
                    localStorage.setItem(`notification_read_${notification.appointmentId}`, 'true');
                }
                
                updateNotificationBadge();
                renderNotifications();
            }
        }

        function markAllAsRead() {
            notifications.forEach(n => {
                if (n.unread) {
                    n.unread = false;
                    // Randevu bildirimi ise localStorage'a kaydet
                    if (n.type === 'appointment') {
                        localStorage.setItem(`notification_read_${n.appointmentId}`, 'true');
                    }
                }
            });
            updateNotificationBadge();
            renderNotifications();
        }

        // İşletme değerlendirmelerini yükle
        async function loadBusinessReviews() {
            const businessId = document.getElementById('appointmentBusinessId').value;
            const reviewsList = document.getElementById('reviewsList');
            
            if (!businessId) {
                reviewsList.innerHTML = '<p>İşletme bilgisi bulunamadı.</p>';
                return;
            }
            
            reviewsList.innerHTML = '<p>Değerlendirmeler yükleniyor...</p>';
            
            try {
                const response = await fetch(`/api/businesses/${businessId}/reviews`);
                
                if (!response.ok) {
                    throw new Error('Değerlendirmeler yüklenemedi');
                }
                
                const data = await response.json();
                console.log('Değerlendirmeler verisi:', data);
                
                if (!data.reviews || data.reviews.length === 0) {
                    reviewsList.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            <span class="material-icons" style="font-size: 3rem; opacity: 0.5;">rate_review</span>
                            <p>Henüz değerlendirme yapılmamış.</p>
                        </div>
                    `;
                    return;
                }
                
                // Ortalama puanı göster
                const averageSection = `
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                        <h4>Ortalama Puan</h4>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <div style="display: flex;">
                                ${Array.from({length: 5}, (_, i) => 
                                    `<span class="material-icons" style="color: ${i < Math.round(data.averageRating) ? '#ffc107' : '#e0e0e0'};">star</span>`
                                ).join('')}
                            </div>
                            <span style="font-weight: bold; margin-left: 0.5rem;">${data.averageRating.toFixed(1)}</span>
                            <span style="color: #666;">(${data.totalReviews} değerlendirme)</span>
                        </div>
                    </div>
                `;
                
                // Değerlendirmeleri listele
                const reviewsHtml = data.reviews.map(review => {
                    const reviewDate = new Date(review.created_at).toLocaleDateString('tr-TR');
                    let businessResponseHtml = '';
                    
                    // İşletme yanıtı varsa göster
                    if (review.business_response) {
                        const responseDate = new Date(review.response_date).toLocaleDateString('tr-TR');
                        businessResponseHtml = `
                            <div style="background: #f0f8ff; border-left: 4px solid #2196F3; padding: 1rem; margin-top: 1rem; border-radius: 0 8px 8px 0;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span class="material-icons" style="color: #2196F3; font-size: 1.2rem;">business</span>
                                    <strong style="color: #2196F3;">İşletme Yanıtı</strong>
                                    <span style="color: #666; font-size: 0.85rem; margin-left: auto;">${responseDate}</span>
                                </div>
                                <p style="margin: 0; color: #333; font-style: italic;">${review.business_response}</p>
                            </div>
                        `;
                    }
                    
                    return `
                        <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <strong>${review.customer_name}</strong>
                                    <div style="display: flex;">
                                        ${Array.from({length: 5}, (_, i) => 
                                            `<span class="material-icons" style="font-size: 1.2rem; color: ${i < review.rating ? '#ffc107' : '#e0e0e0'};">star</span>`
                                        ).join('')}
                                    </div>
                                </div>
                                <span style="color: #666; font-size: 0.9rem;">${reviewDate}</span>
                            </div>
                            ${review.comment ? `<p style="margin: 0; color: #333;">${review.comment}</p>` : ''}
                            ${businessResponseHtml}
                        </div>
                    `;
                }).join('');
                
                reviewsList.innerHTML = averageSection + reviewsHtml;
                
            } catch (error) {
                console.error('Değerlendirmeler yükleme hatası:', error);
                reviewsList.innerHTML = '<p style="color: red;">Değerlendirmeler yüklenirken bir hata oluştu.</p>';
            }
        }

        // Mesajlaşma değişkenleri
        let currentAppointmentId = null;
        let messagePolling = null;

        // Mesajlaşma modal aç
        function openAppointmentMessages(appointmentId) {
            currentAppointmentId = appointmentId;
            document.getElementById('messageModal').style.display = 'block';
            document.getElementById('messageModalTitle').textContent = `Mesajlar - Randevu #${appointmentId}`;
            loadMessages();
            startMessagePolling();
            
            // Bildirim panelini kapat
            const notificationDropdown = document.getElementById('notificationDropdown');
            if (notificationDropdown) {
                notificationDropdown.classList.remove('active');
            }
        }

        // Mesajlaşma modal kapat
        function closeMessageModal() {
            document.getElementById('messageModal').style.display = 'none';
            stopMessagePolling();
            currentAppointmentId = null;
        }

        // Mesajları yükle
        async function loadMessages() {
            if (!currentAppointmentId) return;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/messages/${currentAppointmentId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const messages = await response.json();
                    displayMessages(messages);
                    markMessagesAsRead();
                }
            } catch (error) {
                console.error('Mesaj yükleme hatası:', error);
            }
        }

        // Mesajları görüntüle
        function displayMessages(messages) {
            const messageList = document.getElementById('messageList');
            const token = localStorage.getItem('token');
            const payload = JSON.parse(atob(token.split('.')[1]));
            const userId = payload.userId;

            if (messages.length === 0) {
                messageList.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <span class="material-icons" style="font-size: 3rem; opacity: 0.5;">message</span>
                        <p>Henüz mesaj yok. İlk mesajı siz gönderin!</p>
                    </div>
                `;
                return;
            }

            messageList.innerHTML = messages.map(message => {
                const isSent = message.sender_id === userId;
                const messageClass = isSent ? 'sent' : 'received';
                const time = new Date(message.created_at).toLocaleString('tr-TR', {
                    day: '2-digit',
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                return `
                    <div class="message-item ${messageClass}">
                        <div class="message-bubble">
                            ${message.message}
                            <div class="message-time">${time}</div>
                        </div>
                    </div>
                `;
            }).join('');

            // En alt mesaja scroll
            messageList.scrollTop = messageList.scrollHeight;
        }

        // Mesaj gönder
        async function sendMessage() {
            if (!currentAppointmentId) return;

            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message) return;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        appointmentId: currentAppointmentId,
                        message: message
                    })
                });

                if (response.ok) {
                    messageInput.value = '';
                    loadMessages(); // Mesajları yenile
                }
            } catch (error) {
                console.error('Mesaj gönderme hatası:', error);
            }
        }

        // Mesajları okundu işaretle
        async function markMessagesAsRead() {
            if (!currentAppointmentId) return;

            try {
                const token = localStorage.getItem('token');
                await fetch(`/api/messages/mark-read/${currentAppointmentId}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                // Bildirimleri güncelle
                loadNotifications();
            } catch (error) {
                console.error('Mesaj okundu işaretleme hatası:', error);
            }
        }

        // Mesaj polling başlat
        function startMessagePolling() {
            stopMessagePolling();
            messagePolling = setInterval(loadMessages, 5000); // 5 saniyede bir yenile
        }

        // Mesaj polling durdur
        function stopMessagePolling() {
            if (messagePolling) {
                clearInterval(messagePolling);
                messagePolling = null;
            }
        }

        // Enter tuşu ile mesaj gönder ve modal event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const messageInput = document.getElementById('messageInput');
            messageInput?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Modal dışına tıklayınca kapat
            const messageModal = document.getElementById('messageModal');
            messageModal?.addEventListener('click', function(e) {
                if (e.target === messageModal) {
                    closeMessageModal();
                }
            });

            // ESC tuşu ile modal kapat
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeMessageModal();
                }
            });
        });

        // Bilgiler sekmesindeki hizmetleri sadece bilgi amaçlı göster
        function loadBusinessServicesInfo(business) {
            const servicesContainer = document.getElementById('businessServices');
            servicesContainer.innerHTML = '';
            
            console.log('Bilgiler sekmesi için hizmetler yükleniyor:', business.services);
            
            let services = [];
            
            // Hizmetleri parse et
            if (business.services) {
                if (typeof business.services === 'string') {
                    if (business.services.trim() === '') {
                        services = [];
                    } else {
                        try {
                            services = JSON.parse(business.services);
                        } catch (e) {
                            console.error('JSON parse hatası:', e);
                            services = [];
                        }
                    }
                } else if (Array.isArray(business.services)) {
                    services = business.services;
                }
            }
            
            if (services && services.length > 0) {
                // Hizmetleri kategorilere göre gruplandır
                const servicesByCategory = {};
                
                services.forEach(service => {
                    let serviceName = '';
                    let servicePrice = '';
                    let serviceDuration = '';
                    let categoryName = 'Diğer Hizmetler';
                    
                    if (typeof service === 'object' && service.name) {
                        serviceName = service.name;
                        servicePrice = service.price ? `${service.price} TL` : '';
                        serviceDuration = service.duration ? `${service.duration} dk` : '';
                        categoryName = service.category_name || 'Diğer Hizmetler';
                    } else if (typeof service === 'string') {
                        serviceName = service;
                    }
                    
                    if (!servicesByCategory[categoryName]) {
                        servicesByCategory[categoryName] = [];
                    }
                    
                    servicesByCategory[categoryName].push({
                        name: serviceName,
                        price: servicePrice,
                        duration: serviceDuration
                    });
                });
                
                // Kategorileri HTML olarak oluştur
                Object.entries(servicesByCategory).forEach(([categoryName, categoryServices]) => {
                    // Kategori başlığı
                    const categoryTitle = document.createElement('h4');
                    categoryTitle.textContent = categoryName;
                    categoryTitle.style.marginTop = '20px';
                    categoryTitle.style.marginBottom = '10px';
                    categoryTitle.style.color = '#333';
                    categoryTitle.style.borderBottom = '2px solid #4285f4';
                    categoryTitle.style.paddingBottom = '5px';
                    servicesContainer.appendChild(categoryTitle);
                    
                    // Hizmetleri ekle
                    categoryServices.forEach(service => {
                        const serviceItem = document.createElement('div');
                        serviceItem.className = 'service-info-item';
                        
                        let serviceDetails = '';
                        if (service.price || service.duration) {
                            const priceText = service.price ? service.price : '';
                            const durationText = service.duration ? service.duration : '';
                            const separator = (priceText && durationText) ? ' • ' : '';
                            serviceDetails = `<div class="service-info-price">${priceText}${separator}${durationText}</div>`;
                        }
                        
                        serviceItem.innerHTML = `
                            <div class="service-info-name">${service.name}</div>
                            ${serviceDetails}
                        `;
                        
                        servicesContainer.appendChild(serviceItem);
                    });
                });
            } else {
                servicesContainer.innerHTML = '<p>Hizmet bilgisi bulunamadı.</p>';
            }
        }

        // Sadakat puanlarını yükle
        async function loadLoyaltyPoints() {
            try {
                const token = localStorage.getItem('token');
                if (!token) return;

                const response = await fetch('/api/customer/loyalty-points', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const loyaltyData = await response.json();
                    updateLoyaltyProgressBar(loyaltyData);
                }
            } catch (error) {
                console.error('Sadakat puanları yükleme hatası:', error);
            }
        }

        // İlerleme çubuğunu güncelle
        function updateLoyaltyProgressBar(loyaltyData) {
            const currentPoints = loyaltyData.total_points || 0;
            const targetPoints = 40; // 40 puan hedefe
            
            // Mevcut puanları güncelle
            document.getElementById('currentPoints').textContent = currentPoints;
            document.getElementById('nextMilestone').textContent = targetPoints;
            
            // İlerleme çubuğunu güncelle
            const progressPercentage = Math.min((currentPoints / targetPoints) * 100, 100);
            document.getElementById('progressFill').style.width = progressPercentage + '%';
            
            // Checkpoint'leri güncelle
            const checkpoints = document.querySelectorAll('.checkpoint');
            checkpoints.forEach((checkpoint, index) => {
                const requiredPoints = [0, 10, 20, 30, 40][index]; // 0, 10, 20, 30, 40 puan milestoneleri
                
                if (currentPoints >= requiredPoints) {
                    checkpoint.classList.add('achieved');
                    checkpoint.classList.remove('active');
                } else if (currentPoints < requiredPoints) {
                    checkpoint.classList.remove('achieved', 'active');
                    // İlk ulaşılamayan checkpoint'i aktif yap
                    if (!checkpoint.classList.contains('achieved') && !document.querySelector('.checkpoint.active')) {
                        checkpoint.classList.add('active');
                    }
                }
            });

            // İlk checkpoint her zaman aktif
            if (currentPoints === 0) {
                checkpoints[0].classList.add('active');
            }

            // İndirim butonunu göster/gizle
            const useDiscountBtn = document.getElementById('useDiscountBtn');
            if (currentPoints >= 40) {
                useDiscountBtn.style.display = 'inline-block';
            } else {
                useDiscountBtn.style.display = 'none';
            }
        }

        // Kullanıcının kuponlarını yükle
        async function loadUserCoupons() {
            console.log('🎫 loadUserCoupons fonksiyonu çağrıldı');
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    console.log('❌ Token bulunamadı, kupon bölümü gizleniyor');
                    // Kullanıcı giriş yapmamışsa kupon bölümünü gizle
                    const couponSection = document.getElementById('couponSection');
                    const noCouponMessage = document.getElementById('noCouponMessage');
                    if (couponSection) couponSection.style.display = 'none';
                    return;
                }
                console.log('✅ Token bulundu, kuponlar API\'den yükleniyor...');

                const response = await fetch('/api/customer/coupons', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const couponSelect = document.getElementById('appointmentCoupon');
                const couponSection = document.getElementById('couponSection');
                const noCouponMessage = document.getElementById('noCouponMessage');

                // Kupon bölümünü her zaman göster
                if (couponSection) {
                    couponSection.style.display = 'block';
                }

                if (response.ok) {
                    const data = await response.json();
                    console.log('📊 API yanıtı:', data);
                    const coupons = data.coupons || [];
                    console.log(`📋 Toplam kupon sayısı: ${coupons.length}`);
                    
                    // Sadece kullanılmamış kuponları göster
                    const availableCoupons = coupons.filter(coupon => !coupon.used);
                    console.log(`✨ Kullanılabilir kupon sayısı: ${availableCoupons.length}`);
                    
                    if (availableCoupons.length > 0) {
                        // Kuponlar varsa seçim listesini doldur
                        couponSelect.innerHTML = '<option value="">İndirim kuponu seçin (opsiyonel)</option>';
                        
                        availableCoupons.forEach(coupon => {
                            const option = document.createElement('option');
                            option.value = coupon.id;
                            option.textContent = `${coupon.discount_amount} TL İndirim - ${coupon.description}`;
                            couponSelect.appendChild(option);
                        });
                        
                        // Bilgilendirme mesajını gizle
                        if (noCouponMessage) {
                            noCouponMessage.style.display = 'none';
                        }
                        
                        // Kupon select'ini aktif et
                        couponSelect.disabled = false;
                        couponSelect.style.backgroundColor = 'white';
                        
                        // Kupon seçimi değiştiğinde fiyatı güncelle
                        couponSelect.removeEventListener('change', updatePriceWithCoupon);
                        couponSelect.addEventListener('change', updatePriceWithCoupon);
                        console.log('🔗 Kupon select change event listener eklendi');
                    } else {
                        // Kupon yoksa bilgilendirme mesajını göster
                        couponSelect.innerHTML = '<option value="">Kullanılabilir kuponunuz bulunmuyor</option>';
                        couponSelect.disabled = true;
                        couponSelect.style.backgroundColor = '#f5f5f5';
                        
                        if (noCouponMessage) {
                            noCouponMessage.style.display = 'block';
                        }
                    }
                } else {
                    console.error('Kuponlar yüklenemedi:', response.status);
                    // Hata durumunda da bilgilendirme göster
                    couponSelect.innerHTML = '<option value="">Kuponlar yüklenemedi</option>';
                    couponSelect.disabled = true;
                    couponSelect.style.backgroundColor = '#f5f5f5';
                    
                    if (noCouponMessage) {
                        noCouponMessage.style.display = 'block';
                        noCouponMessage.textContent = 'Kuponlar şu anda yüklenemiyor. Lütfen daha sonra tekrar deneyin.';
                        noCouponMessage.style.color = '#dc3545';
                    }
                }
            } catch (error) {
                console.error('Kupon yükleme hatası:', error);
                // Hata durumunda bilgilendirme göster
                const couponSelect = document.getElementById('appointmentCoupon');
                const noCouponMessage = document.getElementById('noCouponMessage');
                
                if (couponSelect) {
                    couponSelect.innerHTML = '<option value="">Kuponlar yüklenemedi</option>';
                    couponSelect.disabled = true;
                    couponSelect.style.backgroundColor = '#f5f5f5';
                }
                
                if (noCouponMessage) {
                    noCouponMessage.style.display = 'block';
                    noCouponMessage.textContent = 'Kuponlar yüklenirken bir hata oluştu. Lütfen daha sonra tekrar deneyin.';
                    noCouponMessage.style.color = '#dc3545';
                }
            }
        }

        // Kupon ile fiyat güncelleme
        function updatePriceWithCoupon() {
            console.log('💰 updatePriceWithCoupon fonksiyonu çağrıldı');
            const couponSelect = document.getElementById('appointmentCoupon');
            const discountInfo = document.getElementById('discountInfo');
            const finalTotalPrice = document.getElementById('finalTotalPrice');
            
            console.log('🎯 Seçilen kupon değeri:', couponSelect.value);
            
            // Toplam fiyatı al
            const originalPrice = Math.round(calculateTotalPrice() * 100) / 100;
            // Sadece ek hizmetlerin fiyatını al (kupon kontrolü için)
            const additionalServicesPrice = Math.round(calculateAdditionalServicesPrice() * 100) / 100;
            
            console.log('💵 Hesaplanan fiyatlar:', {
                totalPrice: originalPrice,
                additionalServicesOnly: additionalServicesPrice
            });
            
            if (couponSelect.value) {
                // Minimum 180 TL kontrolü - SADECE EK HİZMETLER İÇİN
                console.log('⚠️ Minimum tutar kontrolü yapılıyor (sadece ek hizmetler):', additionalServicesPrice, 'vs 180');
                if (additionalServicesPrice < 180) {
                    console.log('❌ Ek hizmetler minimum tutarı yetersiz:', additionalServicesPrice);
                    showAlert(`İndirim kuponunu kullanabilmek için en az 180 TL'lik ek hizmet seçmelisiniz. Mevcut ek hizmet tutarı: ${additionalServicesPrice.toFixed(2)} TL`, 'error');
                    couponSelect.value = ''; // Kupon seçimini sıfırla
                    finalTotalPrice.textContent = `${originalPrice.toFixed(2)} TL`;
                    discountInfo.style.display = 'none';
                    return;
                }

                console.log('✅ Ek hizmetler minimum tutarı yeterli, kupon uygulanabilir');

                // Seçilen kuponun bilgilerini al
                fetch('/api/customer/coupons', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                })
                .then(response => response.json())
                .then(data => {
                    const selectedCoupon = data.coupons.find(c => c.id == couponSelect.value);
                    if (selectedCoupon) {
                        const discountAmount = parseFloat(selectedCoupon.discount_amount);
                        const discountedPrice = Math.max(0, originalPrice - discountAmount);
                        
                        finalTotalPrice.textContent = `${discountedPrice.toFixed(2)} TL`;
                        discountInfo.textContent = `(-${discountAmount} TL indirim uygulandı)`;
                        discountInfo.style.display = 'block';
                        console.log('💰 Kupon uygulandı:', {
                            originalPrice,
                            discountAmount,
                            finalPrice: discountedPrice
                        });
                    }
                })
                .catch(error => {
                    console.error('Kupon bilgisi alınamadı:', error);
                });
            } else {
                finalTotalPrice.textContent = `${originalPrice.toFixed(2)} TL`;
                discountInfo.style.display = 'none';
            }
        }

        // Toplam fiyat hesaplama (mevcut)
        function calculateTotalPrice() {
            console.log('🧮 calculateTotalPrice çağrıldı');
            
            // Standart randevu fiyatı
            const reservationPrice = parseFloat(window.currentBusinessReservationPrice || 0);
            console.log('🏢 Rezervasyon fiyatı:', reservationPrice);
            
            // Seçilen ek hizmetlerin fiyatını hesapla
            const additionalServicesPrice = calculateAdditionalServicesPrice();
            
            const totalPrice = reservationPrice + additionalServicesPrice;
            console.log('💰 Toplam hesaplanan fiyat:', {
                reservationPrice,
                additionalServicesPrice,
                totalPrice
            });
            
            return totalPrice;
        }

        // Sadece ek hizmetlerin fiyatını hesapla (kupon kontrolü için)
        function calculateAdditionalServicesPrice() {
            console.log('🛍️ calculateAdditionalServicesPrice çağrıldı');
            
            let additionalServicesPrice = 0;
            if (typeof selectedServices !== 'undefined' && selectedServices.length > 0) {
                console.log('🛍️ Seçilen hizmetler:', selectedServices);
                selectedServices.forEach(service => {
                    if (service.id !== 'standard') { // Standart randevu hariç
                        const servicePrice = parseFloat(service.price || 0);
                        const quantity = parseInt(service.quantity || 1);
                        const serviceTotal = servicePrice * quantity;
                        additionalServicesPrice += serviceTotal;
                        console.log(`📦 Ek Hizmet: ${service.name}, Fiyat: ${servicePrice}, Miktar: ${quantity}, Toplam: ${serviceTotal}`);
                    }
                });
            }
            
            console.log('🎯 Sadece ek hizmetler toplamı:', additionalServicesPrice);
            return additionalServicesPrice;
        }

        // Alert gösterme fonksiyonu
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert ' + (type === 'success' ? 'alert-success' : 'alert-danger');
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 10000;
                display: flex;
                align-items: center;
                gap: 10px;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                font-size: 14px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                backdrop-filter: blur(10px);
                max-width: 400px;
                word-wrap: break-word;
            `;
            
            if (type === 'success') {
                alertDiv.style.backgroundColor = '#d4edda';
                alertDiv.style.color = '#155724';
                alertDiv.style.border = '1px solid #c3e6cb';
            } else {
                alertDiv.style.backgroundColor = '#f8d7da';
                alertDiv.style.color = '#721c24';
                alertDiv.style.border = '1px solid #f5c6cb';
            }
            
            const icon = document.createElement('span');
            icon.className = 'material-icons';
            icon.textContent = type === 'success' ? 'check_circle' : 'error';
            icon.style.fontSize = '20px';
            
            const text = document.createElement('span');
            text.textContent = message;
            
            alertDiv.appendChild(icon);
            alertDiv.appendChild(text);
            document.body.appendChild(alertDiv);
            
            // 4 saniye sonra alertı kaldır
            setTimeout(() => {
                if (document.body.contains(alertDiv)) {
                    alertDiv.remove();
                }
            }, 4000);
        }

        // İndirim hakkını kullan (40 puana ulaştığında kupon oluştur)
        async function useDiscount() {
            console.log('🎉 useDiscount fonksiyonu çağrıldı');
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    console.log('❌ Token bulunamadı');
                    showAlert('Lütfen giriş yapın', 'error');
                    return;
                }
                console.log('✅ Token bulundu, kupon oluşturma API\'sine istek gönderiliyor...');

                const response = await fetch('/api/customer/create-loyalty-coupon', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        discount_amount: 100,
                        description: 'Sadakat Programı - 40 Puan İndirimi'
                    })
                });

                const data = await response.json();
                console.log('📊 Kupon oluşturma API yanıtı:', data);
                console.log('📊 Response status:', response.status);

                if (response.ok) {
                    console.log('✅ Kupon başarıyla oluşturuldu');
                    showAlert('🎉 Tebrikler! 100 TL indirim kuponunuz oluşturuldu. Artık randevu alırken kullanabilirsiniz!', 'success');
                    // Sadakat puanlarını yeniden yükle (40 puan düşecek)
                    loadLoyaltyPoints();
                    // Kuponları yeniden yükle
                    loadUserCoupons();
                } else {
                    console.log('❌ Kupon oluşturma hatası:', data.error);
                    showAlert(data.error || 'Kupon oluşturulurken bir hata oluştu', 'error');
                }
            } catch (error) {
                console.error('Kupon oluşturma hatası:', error);
                showAlert('Kupon oluşturulurken bir hata oluştu', 'error');
            }
        }

        // Sayfa yüklendiğinde bildirimleri ve sadakat puanlarını yükle
        document.addEventListener('DOMContentLoaded', function() {
            loadNotifications();
            loadLoyaltyPoints();

            // İndirim butonuna event listener ekle
            const useDiscountBtn = document.getElementById('useDiscountBtn');
            if (useDiscountBtn) {
                useDiscountBtn.addEventListener('click', useDiscount);
                console.log('UseDiscount button event listener eklendi');
            } else {
                console.error('UseDiscount button bulunamadı!');
            }

            // Navigasyon çubuğunu koruma sistemi
            function forceShowNavigation() {
                const navBar = document.querySelector('.nav-bar');
                if (navBar) {
                    navBar.style.cssText = `
                        display: flex !important;
                        visibility: visible !important;
                        opacity: 1 !important;
                        position: relative !important;
                        z-index: 99999 !important;
                        pointer-events: auto !important;
                    `;
                    navBar.classList.add('nav-forced-visible');
                    return true;
                } else {
                    console.error('Navigasyon çubuğu bulunamadı!');
                    return false;
                }
            }

            // İlk gösterme
            forceShowNavigation();
            console.log('Navigasyon çubuğu ilk kez zorla gösterildi');
            
            // Navigasyonun kaybolmasını engellemek için interval
            setInterval(function() {
                const navBar = document.querySelector('.nav-bar');
                if (navBar) {
                    const computedStyle = window.getComputedStyle(navBar);
                    if (computedStyle.display === 'none' || 
                        computedStyle.visibility === 'hidden' || 
                        parseFloat(computedStyle.opacity) < 0.1) {
                        console.log('Navigasyon kaybedildi, yeniden gösteriliyor...');
                        forceShowNavigation();
                    }
                }
            }, 300);
        });

        // Chatbot Fonksiyonları
        const CHATBOT_API_KEY = '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';
        const CHATBOT_API_URL = 'https://openrouter.ai/api/v1/chat/completions';
        let chatbotConversationHistory = [];

        // Chatbot modal'ını aç
        function openChatbot() {
            document.getElementById('chatbotModal').style.display = 'block';
            document.getElementById('chatbotInput').focus();
        }

        // Chatbot modal'ını kapat
        function closeChatbot() {
            document.getElementById('chatbotModal').style.display = 'none';
        }

        // Chatbot mesaj gönder
        async function sendChatbotMessage() {
            const chatbotInput = document.getElementById('chatbotInput');
            const chatbotSendBtn = document.getElementById('chatbotSendBtn');
            const message = chatbotInput.value.trim();
            
            if (!message || chatbotSendBtn.disabled) return;

            // Kullanıcı mesajını ekle
            addChatbotMessage(message, 'user');
            chatbotInput.value = '';
            chatbotInput.style.height = 'auto';

            // Gönder butonunu devre dışı bırak
            chatbotSendBtn.disabled = true;
            
            // Yazıyor göstergesini göster
            showChatbotTyping();

            try {
                // Konuşma geçmişine ekle
                chatbotConversationHistory.push({
                    role: 'user',
                    content: message
                });

                // API'ye istek gönder (Ücretsiz Llama 3.1 8B modeli kullan)
                const response = await fetch(CHATBOT_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${CHATBOT_API_KEY}`,
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'Online Randevu Chatbot'
                    },
                    body: JSON.stringify({
                        model: 'meta-llama/llama-3.1-8b-instruct',
                        messages: [
                            {
                                role: 'system',
                                content: 'Sen yardımsever bir AI asistanısın. Türkçe konuşuyorsun ve kullanıcılara nazik bir şekilde yardım ediyorsun. Online randevu sistemi hakkında sorular gelirse, bu sistemin işletmelerin randevu yönetimi yapmasına yardımcı olduğunu söyle.'
                            },
                            ...chatbotConversationHistory
                        ],
                        temperature: 0.7,
                        max_tokens: 1000
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Hatası: ${response.status}`);
                }

                const data = await response.json();
                const botMessage = data.choices[0].message.content;

                // Bot mesajını ekle
                addChatbotMessage(botMessage, 'bot');

                // Konuşma geçmişine ekle
                chatbotConversationHistory.push({
                    role: 'assistant',
                    content: botMessage
                });

                // Konuşma geçmişini sınırla (son 20 mesaj)
                if (chatbotConversationHistory.length > 20) {
                    chatbotConversationHistory = chatbotConversationHistory.slice(-20);
                }

            } catch (error) {
                console.error('Chatbot hatası:', error);
                addChatbotErrorMessage('Üzgünüm, bir hata oluştu. Lütfen tekrar deneyin.');
            } finally {
                // Yazıyor göstergesini gizle
                hideChatbotTyping();
                
                // Gönder butonunu aktif et
                chatbotSendBtn.disabled = false;
                
                // Input'a odaklan
                chatbotInput.focus();
            }
        }

        // Chatbot mesaj ekleme fonksiyonu
        function addChatbotMessage(content, sender) {
            const chatbotMessages = document.getElementById('chatbotMessages');
            
            // Hoş geldin mesajını kaldır
            const welcomeMessage = chatbotMessages.querySelector('.chatbot-welcome');
            if (welcomeMessage) {
                welcomeMessage.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `chatbot-message ${sender}`;

            const avatar = document.createElement('div');
            avatar.className = 'chatbot-avatar';
            avatar.textContent = sender === 'user' ? '👤' : '🤖';

            const messageContent = document.createElement('div');
            messageContent.className = 'chatbot-message-content';
            messageContent.innerHTML = formatChatbotMessage(content);

            const messageTime = document.createElement('div');
            messageTime.className = 'chatbot-message-time';
            messageTime.textContent = new Date().toLocaleTimeString('tr-TR', {
                hour: '2-digit',
                minute: '2-digit'
            });

            messageDiv.appendChild(avatar);
            const contentWrapper = document.createElement('div');
            contentWrapper.appendChild(messageContent);
            contentWrapper.appendChild(messageTime);
            messageDiv.appendChild(contentWrapper);

            chatbotMessages.appendChild(messageDiv);
            scrollChatbotToBottom();
        }

        // Chatbot hata mesajı ekleme
        function addChatbotErrorMessage(message) {
            const chatbotMessages = document.getElementById('chatbotMessages');
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                background: linear-gradient(135deg, #ff6b6b, #ee5a52);
                color: white;
                padding: 12px 16px;
                border-radius: 12px;
                margin: 10px 0;
                display: flex;
                align-items: center;
                gap: 8px;
            `;
            errorDiv.innerHTML = `
                <span class="material-icons">error</span>
                ${message}
            `;
            chatbotMessages.appendChild(errorDiv);
            scrollChatbotToBottom();
        }

        // Chatbot mesaj formatlaması
        function formatChatbotMessage(content) {
            // Basit markdown desteği
            return content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code style="background: #f1f5f9; padding: 2px 4px; border-radius: 4px;">$1</code>')
                .replace(/\n/g, '<br>');
        }

        // Chatbot yazıyor göstergesi
        function showChatbotTyping() {
            document.getElementById('chatbotTyping').style.display = 'flex';
            scrollChatbotToBottom();
        }

        function hideChatbotTyping() {
            document.getElementById('chatbotTyping').style.display = 'none';
        }

        // Chatbot en alta kaydır
        function scrollChatbotToBottom() {
            const chatbotMessages = document.getElementById('chatbotMessages');
            setTimeout(() => {
                chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
            }, 100);
        }

        // Chatbot textarea otomatik boyutlandırma ve Enter tuşu
        document.addEventListener('DOMContentLoaded', function() {
            const chatbotInput = document.getElementById('chatbotInput');
            
            // Textarea otomatik boyutlandırma
            chatbotInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
            });

            // Enter tuşu ile mesaj gönderme
            chatbotInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatbotMessage();
                }
            });

            // Modal dışına tıklayınca kapat
            const chatbotModal = document.getElementById('chatbotModal');
            chatbotModal.addEventListener('click', function(e) {
                if (e.target === chatbotModal) {
                    closeChatbot();
                }
            });

            // ESC tuşu ile modal kapat
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && chatbotModal.style.display === 'block') {
                    closeChatbot();
                }
            });
        });
        
        // MutationObserver ile navigasyon koruması - SON SAVUNMA
        const navObserver = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                    const target = mutation.target;
                    if (target.classList.contains('nav-bar')) {
                        const computedStyle = window.getComputedStyle(target);
                        if (computedStyle.display === 'none' || 
                            computedStyle.visibility === 'hidden' || 
                            parseFloat(computedStyle.opacity) < 0.1) {
                            console.log('🚨 Navigasyon saldırı altında! Koruma devreye giriyor...');
                            target.style.cssText = `
                                display: flex !important;
                                visibility: visible !important;
                                opacity: 1 !important;
                                position: relative !important;
                                z-index: 999999 !important;
                                width: 100% !important;
                                height: auto !important;
                                pointer-events: auto !important;
                                background: rgba(255, 255, 255, 0.95) !important;
                                backdrop-filter: blur(20px) !important;
                                padding: 0.8rem 1.5rem !important;
                                border-radius: 16px !important;
                                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1) !important;
                                border: 1px solid rgba(255, 255, 255, 0.2) !important;
                                margin-bottom: 1.5rem !important;
                                justify-content: space-between !important;
                                align-items: center !important;
                                overflow: visible !important;
                            `;
                        }
                    }
                }
            });
        });

        // Tüm navigasyon elementlerini gözlemle
        const navElements = document.querySelectorAll('.nav-bar, nav, [class*="nav"]');
        navElements.forEach(nav => {
            navObserver.observe(nav, { attributes: true, attributeFilter: ['style', 'class'] });
        });
        
        console.log('🛡️ Navigasyon koruma sistemi aktif');

        // Sadakat Puanı Bilgi Modal Fonksiyonları
        function openLoyaltyInfoModal() {
            document.getElementById('loyaltyInfoModal').style.display = 'block';
        }

        function closeLoyaltyInfoModal() {
            document.getElementById('loyaltyInfoModal').style.display = 'none';
        }

        // Loyalty modal için event listener'lar ekle
        document.addEventListener('DOMContentLoaded', function() {
            // Modal dışına tıklandığında kapatma
            window.addEventListener('click', function(event) {
                const loyaltyModal = document.getElementById('loyaltyInfoModal');
                if (event.target === loyaltyModal) {
                    closeLoyaltyInfoModal();
                }
            });

            // ESC tuşu ile modal kapatma (mevcut ESC listener'a ekleme)
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    const loyaltyModal = document.getElementById('loyaltyInfoModal');
                    if (loyaltyModal.style.display === 'block') {
                        closeLoyaltyInfoModal();
                    }
                }
            });
        });
    </script>
</body>
</html> 